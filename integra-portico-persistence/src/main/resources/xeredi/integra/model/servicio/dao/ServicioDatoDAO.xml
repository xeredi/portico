<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.servicio.dao.ServicioDatoDAO">
	<resultMap type="ItemDatoVO" id="ResultMap">
		<id column="srdt_srvc_pk" property="itemId" />
		<id column="srdt_tpdt_pk" property="tpdtId" />
		<result column="srdt_nentero" property="cantidadEntera" />
		<result column="srdt_ndecimal" property="cantidadDecimal" />
		<result column="srdt_fecha" property="fecha" />
		<result column="srdt_cadena" property="cadena" />

		<association property="prmt" javaType="ParametroVO">
			<result column="srdt_prmt_pk" property="id" />
			<result column="prmt_parametro" property="parametro" />
			<result column="p18n_texto" property="texto" />
		</association>

		<association property="srvc" javaType="ServicioVO">
			<result column="srdt_srvc_dep_pk" property="id" />
			<result column="srvc_anno" property="anno" />
			<result column="srvc_numero" property="numero" />

			<association property="prto" javaType="PuertoVO">
				<result column="prto_codigo" property="codigo" />
			</association>
		</association>
	</resultMap>

	<select id="selectList" parameterType="ServicioCriterioVO" resultMap="ResultMap">
    <![CDATA[
		SELECT
		    srdt_srvc_pk, srdt_tpdt_pk, srdt_nentero, srdt_ndecimal, srdt_prmt_pk, srdt_srvc_dep_pk, srdt_fecha, srdt_cadena

		    , prmt_parametro

		    , srvc_anno, srvc_numero

		    , (SELECT prto_codigo FROM tbl_puerto_prto WHERE prto_pk = srvc_subp_pk) AS prto_codigo
        ]]>
		<if test="idioma != null">
        <![CDATA[
		    , (
		        CASE
		            WHEN
		                EXISTS (
		                    SELECT 1
		                    FROM tbl_tipo_parametro_tppr
		                    WHERE tppr_pk = prmt_tppr_pk
		                        AND tppr_es_i18n = 1
		                )
		            THEN (
		                SELECT i18n_text
		                FROM tbl_i18n_i18n
		                WHERE
		                    i18n_lang = #{idioma}
		                    AND i18n_pref = 'prvr'
		                    AND i18n_ext_pk = (
		                        SELECT prvr_pk
		                        FROM tbl_parametro_version_prvr
		                        WHERE
		                            prvr_prmt_pk = srdt_prmt_pk
		                            AND sql.srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, sql.srvc_fref)
		                    )
		            )

		            ELSE (
		                SELECT prdt_cadena
		                FROM tbl_parametro_dato_prdt
		                WHERE
		                    prdt_prvr_pk = (
		                        SELECT prvr_pk
		                        FROM tbl_parametro_version_prvr
		                        WHERE
		                            prvr_prmt_pk = srdt_prmt_pk
		                            AND sql.srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, sql.srvc_fref)
		                    )
		                    AND prdt_tpdt_pk = (
		                        SELECT tppr_tpdt_pk
		                        FROM tbl_tipo_parametro_tppr
		                        WHERE tppr_pk = prmt_tppr_pk
		                    )
		            )
		        END
		    ) AS p18n_texto
        ]]>
		</if>
    <![CDATA[
		FROM (
		    SELECT srvc_pk, srvc_fref
		    FROM tbl_servicio_srvc
    ]]>
		<where>
			<if test="id == null and ids == null">
				<include refid="xeredi.integra.model.servicio.dao.ServicioDAO.SelectWhere" />
			</if>
			<if test="id != null">
				AND srvc_pk = #{id}
			</if>
			<if test="ids != null">
				AND srvc_pk = ANY
				<foreach collection="ids" item="item" open="(" close=")" separator=",">#{item}
				</foreach>
			</if>
		</where>
    <![CDATA[
		) sql
		    INNER JOIN tbl_servicio_dato_srdt ON
		        srdt_srvc_pk = sql.srvc_pk
    ]]>
			<if test="soloDatosGrid">
       		<![CDATA[
			    AND srdt_tpdt_pk = ANY (
			        SELECT entd_tpdt_pk
			        FROM tbl_entidad_tipo_dato_entd
			        WHERE entd_enti_pk = #{entiId}
			            AND entd_gridable = 1
			    )
		    ]]>
			</if>
    <![CDATA[
		    LEFT JOIN tbl_parametro_prmt ON
		        prmt_pk = srdt_prmt_pk
		    LEFT JOIN tbl_servicio_srvc srvcDep ON
		        srvcDep.srvc_pk = srdt_srvc_dep_pk
   ]]>
	</select>

	<insert id="insert" parameterType="ItemDatoVO">
        <![CDATA[
        INSERT INTO tbl_servicio_dato_srdt (
            srdt_srvc_pk, srdt_tpdt_pk, srdt_nentero, srdt_ndecimal
            , srdt_fecha, srdt_prmt_pk, srdt_cadena, srdt_srvc_dep_pk
        ) VALUES (
            #{itemId}, #{tpdtId}, #{cantidadEntera}, #{cantidadDecimal}
            , #{fecha}, #{prmt.id}, #{cadena}, #{srvc.id}
        )
        ]]>
	</insert>

	<update id="update" parameterType="ItemDatoVO">
        <![CDATA[
        UPDATE tbl_servicio_dato_srdt SET
            srdt_nentero = #{cantidadEntera}
            , srdt_ndecimal = #{cantidadDecimal}
            , srdt_fecha = #{fecha}
            , srdt_prmt_pk = #{prmt.id}
            , srdt_cadena = #{cadena}
            , srdt_srvc_dep_pk = #{srvc.id}
        WHERE
        	srdt_srvc_pk = #{itemId}
        	AND srdt_tpdt_pk = #{tpdtId}
        ]]>
	</update>
</mapper>
