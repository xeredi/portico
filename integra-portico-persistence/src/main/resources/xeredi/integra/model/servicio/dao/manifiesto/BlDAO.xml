<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.servicio.dao.manifiesto.BlDAO">
	<update id="updateRecalcularEstado" parameterType="SubservicioCriterioVO">
        <![CDATA[
        UPDATE tbl_subservicio_ssrv ssrvBl SET
            ssrv_estado =
            	COALESCE (
					(
						WITH
							hijosBL AS (
								SELECT DISTINCT ssrv_estado
								FROM tbl_subservicio_ssrv ssrvHijoBl
								WHERE
									ssrvHijoBl.ssrv_tpss_pk IN (portico.getEntidad('PARTIDA'), portico.getEntidad('EQUIPAMIENTO'))
									AND EXISTS (
										SELECT 1
										FROM tbl_subserv_subserv_ssss
										WHERE ssss_ssrvh_pk = ssrvHijoBl.ssrv_pk
											AND ssss_ssrvp_pk = ssrvBl.ssrv_pk
									)
							)
						SELECT
							CASE
								WHEN NOT EXISTS (
									SELECT ssrv_estado FROM hijosBL
								)
								THEN 'S'

								WHEN 'B' = ANY (SELECT ssrv_estado FROM hijosBL)
								THEN 'B'

								WHEN 'A' = ALL (SELECT ssrv_estado FROM hijosBL)
								THEN 'A'

								ELSE 'I'
							END
						FROM hijosBL
					)
					, 'S'
				)
        WHERE
            ssrv_tpss_pk = portico.getEntidad('BL')
            AND ssrv_srvc_pk = #{srvc.id}
        ]]>
		<if test="id != null">
			AND ssrv_pk = #{id}
		</if>
		<if test="hijoId != null">
        <![CDATA[
			AND EXISTS (
				SELECT 1
				FROM tbl_subserv_subserv_ssss
				WHERE
					ssss_ssrvp_pk = ssrv_pk
					AND ssss_ssrvh_pk = #{hijoId}
			)
        ]]>
		</if>
	</update>
</mapper>

