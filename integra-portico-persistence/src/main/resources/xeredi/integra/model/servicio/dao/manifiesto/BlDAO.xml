<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.servicio.dao.manifiesto.BlDAO">
    <update id="updateRecalcularEstado" parameterType="Long">
        <![CDATA[
        UPDATE tbl_subservicio_ssrv SET
            ssrv_estado = (
                WITH sql AS (
                    SELECT ssrv_estado
                    FROM tbl_subservicio_ssrv
                    WHERE
                        ssrv_tpss_pk IN (portico.getEntidad('PARTIDA'), portico.getEntidad('EQUIPAMIENTO'))
                        AND EXISTS (
                            SELECT 1
                            FROM TBL_SUBSERV_SUBSERV_SSSS
                            WHERE
                                ssss_ssrvh_pk = ssrv_pk
                                AND ssss_ssrvp_pk = 1232119
                        )
                )
                SELECT
                    CASE
                        WHEN
                            'R' = ANY (SELECT ssrv_estado FROM sql)
                            AND NOT EXISTS (
                                SELECT 1
                                FROM sql
                                WHERE
                                    ssrv_estado NOT IN ('R', 'A')
                            )
                        THEN 'I'

        			    WHEN
					       'B' = ANY (SELECT ssrv_estado FROM sql)
        			    THEN 'B'

        			    WHEN
        				    NOT EXISTS (
        					   SELECT 1
        					   FROM sql
        				    )
        			    THEN 'S'

        			    WHEN
					       'A' = ALL (SELECT ssrv_estado FROM sql)
        			    THEN 'A'

        			    ELSE 'X'
                    END
                FROM tbl_subservicio_ssrv
                WHERE
                    ssrv_tpss_pk = portico.getEntidad('BL')
                    AND ssrv_pk = #{value}
            )
        WHERE
            ssrv_tpss_pk = portico.getEntidad('BL')
            AND ssrv_pk = #{value}
        ]]>
    </update>
</mapper>

