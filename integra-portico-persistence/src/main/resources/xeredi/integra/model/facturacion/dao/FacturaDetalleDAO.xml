<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.FacturaDetalleDAO">
	<resultMap type="FacturaDetalleVO" id="ResultMap">
		<id column="fctd_pk" />

		<result column="fctd_pk" property="id" />
		<result column="fctd_fctr_pk" property="fctrId" />
		<result column="fctd_fctl_pk" property="fctlId" />
		<result column="fctd_fini" property="fini" />
		<result column="fctd_ffin" property="ffin" />

		<result column="fctd_importe_base" property="importeBase" />
		<result column="fctd_importe" property="importe" />

		<result column="fctd_cuant1" property="cuant1" />
		<result column="fctd_cuant2" property="cuant2" />
		<result column="fctd_cuant3" property="cuant3" />
		<result column="fctd_cuant4" property="cuant4" />
		<result column="fctd_cuant5" property="cuant5" />
		<result column="fctd_cuant6" property="cuant6" />

		<result column="fctd_info1" property="info1" />
		<result column="fctd_info2" property="info2" />
		<result column="fctd_info3" property="info3" />
		<result column="fctd_info4" property="info4" />
		<result column="fctd_info5" property="info5" />
		<result column="fctd_info6" property="info6" />

		<association property="ssrv" javaType="SubservicioVO">
			<result column="fctd_ssrv_pk" property="id" />
			<result column="ssrv_numero" property="numero" />
			<result column="ssrv_tpss_pk" property="entiId" />
		</association>
	</resultMap>

	<sql id="SelectPrefix">
    <![CDATA[
		SELECT
		    fctd_pk, fctd_fctr_pk, fctd_fctl_pk, fctd_importe_base, fctd_importe, fctd_ssrv_pk, fctd_fini, fctd_ffin
		    , fctd_cuant1, fctd_cuant2, fctd_cuant3, fctd_cuant4, fctd_cuant5, fctd_cuant6
		    , fctd_info1, fctd_info2, fctd_info3, fctd_info4, fctd_info5, fctd_info6

		    , ssrv_numero, ssrv_tpss_pk
		FROM
		    tbl_factura_det_fctd
		    LEFT JOIN tbl_subservicio_ssrv ON
		        ssrv_pk = fctd_ssrv_pk
    ]]>
	</sql>

	<sql id="SelectWhere">
		<where>
			<if test="id != null">
				AND fctd_pk = #{id}
			</if>
			<if test="ids != null">
				AND fctd_pk IN
				<foreach collection="ids" item="item" open="(" close=")" separator=",">#{item}
				</foreach>
			</if>
			<if test="fctl != null">
				<if test="fctl.id != null">
					AND fctd_fctl_pk = #{fctl.id}
				</if>
				<if test="fctl.ids != null">
					AND fctd_fctl_pk IN
					<foreach collection="fctl.ids" item="item" open="(" close=")" separator=",">#{item}
					</foreach>
				</if>

				<if test="fctl.fctr != null">
					<if test="fctl.fctr.id != null">
						AND fctd_fctr_pk = #{fctl.fctr.id}
					</if>
					<if test="fctl.fctr.ids != null">
						AND fctd_fctr_pk IN
						<foreach collection="fctl.fctr.ids" item="item" open="(" close=")" separator=",">#{item}
						</foreach>
					</if>

					<if test="fctl.fctr.fcts != null">
						<if test="fctl.fctr.fcts.id != null">
                        <![CDATA[
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_factura_lin_fctl
                                WHERE
                                    fctl_pk = fctd_fctl_pk
                                    AND EXISTS (
                                        SELECT 1
                                        FROM tbl_factura_srv_fcts
                                        WHERE fcts_pk = fctl_fcts_pk
                                            AND fcts_pk = #{fctl.fctr.fcts.id}
                                    )
                            )
                        ]]>
						</if>
					</if>
				</if>
			</if>
		</where>
	</sql>

	<select id="selectObject" resultMap="ResultMap" parameterType="FacturaDetalleCriterioVO">
		<include refid="SelectPrefix" />
		<include refid="SelectWhere" />
	</select>

	<select id="selectList" resultMap="ResultMap" parameterType="FacturaDetalleCriterioVO">
		<include refid="SelectPrefix" />
		<include refid="SelectWhere" />
		ORDER BY fctd_fctr_pk, fctd_fctl_pk, fctd_pk
	</select>

	<select id="count" resultType="Integer" parameterType="FacturaDetalleCriterioVO">
		SELECT COUNT(1) FROM vw_factura_det_fctd
		<include refid="SelectWhere" />
	</select>

	<insert id="insert" parameterType="FacturaDetalleVO">
    <![CDATA[
        INSERT INTO tbl_factura_det_fctd (
            fctd_pk, fctd_fctr_pk, fctd_fctl_pk, fctd_importe_base, fctd_importe, fctd_ssrv_pk, fctd_fini, fctd_ffin
            , fctd_cuant1, fctd_cuant2, fctd_cuant3, fctd_cuant4, fctd_cuant5, fctd_cuant6
            , fctd_info1, fctd_info2, fctd_info3, fctd_info4, fctd_info5, fctd_info6
        ) VALUES (
            #{id}, #{fctrId}, #{fctlId}, #{importeBase}, #{importe}, #{ssrv.id}, #{fini}, #{ffin}
            , #{cuant1}, #{cuant2}, #{cuant3}, #{cuant4}, #{cuant5}, #{cuant6}
            , #{info1}, #{info2}, #{info3}, #{info4}, #{info5}, #{info6}
        )
    ]]>
	</insert>
</mapper>
