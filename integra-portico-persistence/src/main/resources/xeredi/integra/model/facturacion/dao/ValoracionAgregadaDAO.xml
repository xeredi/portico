<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.ValoracionAgregadaDAO">
    <resultMap type="ValoracionAgregadaVO" id="ResultMap">
        <id column="vlrc_srvc_pk" />
        <id column="vlrc_pagador_prmt_pk" />
        <id column="vlrc_es_suj_pasivo" />
        <id column="vlrc_cod_exen" />

        <association property="vlrc" resultMap="xeredi.integra.model.facturacion.dao.ValoracionDAO.ResultMap" />

        <collection property="vlrlList" ofType="ValoracionLineaAgregadaVO" javaType="ArrayList">
            <id column="vlrl_impuesto_prmt_pk" />
            <id column="vlrl_ssrv_pk" />

            <id column="vlrl_info1" />
            <id column="vlrl_info2" />
            <id column="vlrl_info3" />
            <id column="vlrl_info4" />
            <id column="vlrl_info5" />
            <id column="vlrl_info6" />

            <id column="vlrl_cuant1" />
            <id column="vlrl_cuant2" />
            <id column="vlrl_cuant3" />
            <id column="vlrl_cuant4" />
            <id column="vlrl_cuant5" />
            <id column="vlrl_cuant6" />

            <id column="rgla_pk" />

            <association property="vlrl" resultMap="xeredi.integra.model.facturacion.dao.ValoracionLineaDAO.ResultMap" />

            <collection property="vlrdList" resultMap="xeredi.integra.model.facturacion.dao.ValoracionDetalleDAO.ResultMap"
                javaType="ArrayList" />
        </collection>
    </resultMap>

    <select id="selectList" parameterType="ValoradorContextoVO" resultMap="ResultMap">
    <![CDATA[
        SELECT
            item.*
    ]]>

        <if test="aspc.aspv.cpathInfo1Sql != null">
            , (${aspc.aspv.cpathInfo1Sql}) AS vlrc_info1
        </if>
        <if test="aspc.aspv.cpathInfo2Sql != null">
            , (${aspc.aspv.cpathInfo2Sql}) AS vlrc_info2
        </if>
        <if test="aspc.aspv.cpathInfo3Sql != null">
            , (${aspc.aspv.cpathInfo3Sql}) AS vlrc_info3
        </if>
        <if test="aspc.aspv.cpathInfo4Sql != null">
            , (${aspc.aspv.cpathInfo4Sql}) AS vlrc_info4
        </if>
        <if test="aspc.aspv.cpathInfo5Sql != null">
            , (${aspc.aspv.cpathInfo5Sql}) AS vlrc_info5
        </if>
        <if test="aspc.aspv.cpathInfo6Sql != null">
            , (${aspc.aspv.cpathInfo6Sql}) AS vlrc_info6
        </if>

    <![CDATA[
        FROM (
            SELECT
                vlrt_srvc_pk AS vlrc_srvc_pk
                , vlrt_pagador_prmt_pk AS pagador_prmt_pk
                , vlrt_es_suj_pasivo AS vlrc_es_suj_pasivo
                , vlrt_cod_exen AS vlrc_cod_exen

                , vlrt_fliq AS vlrc_fliq
                , vlrt_fref AS vlrc_fref

                , rgla_pk
                , rgla_tipo
                , rgla_crgo_pk

                , vlrt_impuesto_prmt_pk AS impuesto_prmt_pk
    ]]>

        <if test="aspc.aspv.agrupaDetalles">
            <if test="aspc.aspv.lgrpInfo1">, vlrt_info1 AS vlrl_info1</if>
            <if test="!aspc.aspv.lgrpInfo1">, vlrt_info1 AS vlrd_info1</if>
            <if test="aspc.aspv.lgrpInfo2">, vlrt_info2 AS vlrl_info2</if>
            <if test="!aspc.aspv.lgrpInfo2">, vlrt_info2 AS vlrd_info2</if>
            <if test="aspc.aspv.lgrpInfo3">, vlrt_info3 AS vlrl_info3</if>
            <if test="!aspc.aspv.lgrpInfo3">, vlrt_info3 AS vlrd_info3</if>
            <if test="aspc.aspv.lgrpInfo4">, vlrt_info4 AS vlrl_info4</if>
            <if test="!aspc.aspv.lgrpInfo4">, vlrt_info4 AS vlrd_info4</if>
            <if test="aspc.aspv.lgrpInfo5">, vlrt_info5 AS vlrl_info5</if>
            <if test="!aspc.aspv.lgrpInfo5">, vlrt_info5 AS vlrd_info5</if>
            <if test="aspc.aspv.lgrpInfo6">, vlrt_info6 AS vlrl_info6</if>
            <if test="!aspc.aspv.lgrpInfo6">, vlrt_info6 AS vlrd_info6</if>

            <![CDATA[
                , vlrt_ssrv_pk AS vlrd_ssrv_pk
                , vlrt_fini AS vlrd_fini
                , vlrt_ffin AS vlrd_ffin

                , vlrt_cuant1 AS vlrd_cuant1
                , vlrt_cuant2 AS vlrd_cuant2
                , vlrt_cuant3 AS vlrd_cuant3
                , vlrt_cuant4 AS vlrd_cuant4
                , vlrt_cuant5 AS vlrd_cuant5
                , vlrt_cuant6 AS vlrd_cuant6
            ]]>
        </if>

        <if test="!aspc.aspv.agrupaDetalles">
        <![CDATA[
                , vlrt_ssrv_pk AS vlrl_ssrv_pk
                , vlrt_fini AS vlrl_fini
                , vlrt_ffin AS vlrl_ffin

                , vlrt_info1 AS vlrl_info1
                , vlrt_info2 AS vlrl_info2
                , vlrt_info3 AS vlrl_info3
                , vlrt_info4 AS vlrl_info4
                , vlrt_info5 AS vlrl_info5
                , vlrt_info6 AS vlrl_info6

                , vlrt_cuant1 AS vlrl_cuant1
                , vlrt_cuant2 AS vlrl_cuant2
                , vlrt_cuant3 AS vlrl_cuant3
                , vlrt_cuant4 AS vlrl_cuant4
                , vlrt_cuant5 AS vlrl_cuant5
                , vlrt_cuant6 AS vlrl_cuant6
        ]]>
        </if>
    <![CDATA[
                , vlrt_importe_base AS vlrd_importe_base
                , vlrt_importe AS vlrd_importe

                , (
                    CASE
                        WHEN rgla_tipo = 'T' THEN 1
                        WHEN rgla_tipo = 'C' THEN 2
                        ELSE 3
                    END
                ) AS regla_tipo_orden

                , vlrt_fref AS fref
                , vlrt_srvc_pk AS srvc_pk
            FROM
                tbl_valoracion_tmp_vlrt vlrt
                INNER JOIN tbl_regla_rgla rgla ON
                    rgla_pk = vlrt_rgla_pk
                INNER JOIN tbl_regla_version_rglv rglv ON
                    rglv_rgla_pk = rgla_pk
                    AND vlrt_fref BETWEEN rglv_fini AND COALESCE(rglv_ffin, vlrt_fref)
                LEFT JOIN tbl_subservicio_ssrv ssrv ON
                    ssrv_pk = vlrt_ssrv_pk
            WHERE
                EXISTS (
                    SELECT 1
                    FROM tbl_aspecto_cargo_ascr
                    WHERE
                        ascr_crgo_pk = vlrt_crgo_pk
                        AND ascr_aspv_pk = #{aspc.aspv.id}
                )
                AND vlrt_srvc_pk = #{srvc.id}
                AND vlrt_prbt_pk = #{prbt.id}
            ORDER BY vlrt_prbt_pk, vlrt_srvc_pk, vlrt_pagador_prmt_pk, vlrt_es_suj_pasivo, vlrt_cod_exen
                , ssrv_tpss_pk
    ]]>

        <if test="!aspc.aspv.agrupaDetalles">
            <if test="aspc.aspv.lgrpInfo1">, ssrv_orden</if>
        </if>

    <![CDATA[
                , vlrt_info1, vlrt_info2, vlrt_info3, vlrt_info4, vlrt_info5, vlrt_info6
                , vlrt_impuesto_prmt_pk, regla_tipo_orden, rglv_orden
        ) item
    ]]>
    </select>

</mapper>
