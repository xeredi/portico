<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.FacturaDAO">
    <resultMap type="FacturaVO" id="ResultMap">
        <id column="fctr_pk" />

        <result column="fctr_pk" property="id" />
        <result column="fctr_fref" property="fref" />
        <result column="fctr_falta" property="falta" />
        <result column="fctr_fini" property="fini" />
        <result column="fctr_ffin" property="ffin" />
        <result column="fctr_numero" property="numero" />
        <result column="fctr_importe" property="importe" />
        <result column="fctr_impuesto" property="impuesto" />

        <result column="fctr_info1" property="info1" />
        <result column="fctr_info2" property="info2" />
        <result column="fctr_info3" property="info3" />
        <result column="fctr_info4" property="info4" />
        <result column="fctr_info5" property="info5" />
        <result column="fctr_info6" property="info6" />

        <association property="aspc" resultMap="xeredi.integra.model.facturacion.dao.AspectoDAO.ResultMap" />
        <association property="fcsr" resultMap="xeredi.integra.model.facturacion.dao.FacturaSerieDAO.ResultMap" />
        <association property="pagador" resultMap="xeredi.integra.model.maestro.dao.ParametroDAO.ResultMap" />
    </resultMap>

    <insert id="insert" parameterType="FacturaVO">
    <![CDATA[
        INSERT INTO tbl_factura_fctr (
            fctr_pk, fctr_aspc_pk, fctr_pagador_prmt_pk, fctr_fcsr_pk, fctr_numero
            , fctr_fref, fctr_falta, fctr_fini, fctr_ffin
            , fctr_info1, fctr_info2, fctr_info3, fctr_info4, fctr_info5, fctr_info6
        ) VALUES (
            #{id}, #{aspc.id}, #{pagador.id}, #{fcsr.id}, #{numero}
            , #{fref}, #{falta}, #{fini}, #{ffin}
            , #{info1}, #{info2}, #{info3}, #{info4}, #{info5}, #{info6}
        )
    ]]>
    </insert>

    <sql id="SelectPrefix">
    <![CDATA[
        SELECT *
        FROM vw_factura_fctr
    ]]>
    </sql>

    <sql id="SelectWhere">
        <where>
            <if test="id != null">
                fctr_pk = #{id}
            </if>
            <if test="ids != null">
                AND fctr_pk IN
                <foreach collection="ids" item="item" open="(" close=")" separator=",">#{item}
                </foreach>
            </if>
        </where>
    </sql>

    <select id="select" resultMap="ResultMap" parameterType="Long">
        <include refid="SelectPrefix" />
        WHERE fctr_pk = #{value}
    </select>

    <select id="count" resultType="Integer" parameterType="FacturaCriterioVO">
        SELECT COUNT(1) FROM vw_factura_fctr
        <include refid="SelectWhere" />
    </select>

    <select id="selectList" resultMap="ResultMap" parameterType="FacturaCriterioVO">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="existsFacturaPosterior" parameterType="Long" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM
            tbl_factura_srv_fcts fcts1
            INNER JOIN tbl_factura_srv_fcts fcts2 ON
                fcts1.fcts_fctr_pk <> fcts2.fcts_fctr_pk
                AND fcts1.fcts_srvc_pk = fcts2.fcts_srvc_pk
                AND fcts2.fcts_fref > fcts1.fcts_fref
        WHERE
            fcts1.fcts_fctr_pk = #{value}
    ]]>
    </select>

    <select id="existsValoracionPosterior" parameterType="Long" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM
            tbl_valoracion_vlrc
            JOIN tbl_factura_srv_fcts ON
                fcts_srvc_pk = vlrc_srvc_pk
                AND vlrc_fref > fcts_fref
        WHERE
            fcts_fctr_pk = #{value}
    ]]>
    </select>
</mapper>
