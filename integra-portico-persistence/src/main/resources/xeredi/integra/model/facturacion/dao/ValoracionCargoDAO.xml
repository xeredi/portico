<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.ValoracionCargoDAO">
	<resultMap type="ValoracionCargoVO" id="ResultMap">
		<id column="vlrc_pk" />
		<id column="rgla_crgo_pk" />

		<result column="vlrc_pk" property="vlrcId" />
		<result column="vlrc_fref" property="fref" />
		<result column="vlrg_importe" property="importe" />

		<association property="crgo" javaType="CargoVO">
			<result column="rgla_crgo_pk" property="id" />
			<result column="crgo_codigo" property="codigo" />

			<association property="crgv" javaType="CargoVersionVO">
				<result column="crgv_descripcion" property="descripcion" />
			</association>
		</association>
	</resultMap>

	<select id="selectList" parameterType="ValoracionCriterioVO" resultMap="ResultMap">
    <![CDATA[
		SELECT
		    vlrc_pk, vlrc_fref
		    , rgla_crgo_pk
		    , (
		        SELECT crgo_codigo
		        FROM tbl_cargo_crgo
		        WHERE crgo_pk = rgla_crgo_pk
		    ) AS crgo_codigo
		    , SUM(vlrd_importe) AS vlrg_importe
    ]]>
		<if test="idioma != null">
	    <![CDATA[
		    , (
		        SELECT i18n_text
		        FROM tbl_i18n_i18n
		        WHERE
		            i18n_pref = 'crgv'
		            AND i18n_lang = #{idioma}
		            AND i18n_ext_pk = (
		                SELECT crgv_pk
		                FROM
		                    tbl_cargo_version_crgv
		                WHERE
		                    crgv_crgo_pk = rgla_crgo_pk
		                    AND vlrc_fref BETWEEN crgv_fini AND COALESCE(crgv_ffin, vlrc_fref)
		            )
		    ) AS crgv_descripcion
	    ]]>
		</if>
    <![CDATA[
		FROM
		    tbl_valoracion_vlrc
		    INNER JOIN tbl_valoracion_lin_vlrl ON
		        vlrl_vlrc_pk = vlrc_pk
		    INNER JOIN tbl_valoracion_det_vlrd ON
		        vlrd_vlrl_pk = vlrl_pk
		    INNER JOIN tbl_regla_rgla ON
		        rgla_pk = vlrl_rgla_pk
    ]]>
		<where>
			<if test="id != null">
				AND vlrc_pk = #{id}
			</if>
			<if test="ids != null">
				AND vlrc_pk IN
				<foreach collection="vlrcIds" item="item" open="(" close=")" separator=",">#{item}
				</foreach>
			</if>
		</where>
		GROUP BY vlrc_pk, vlrc_fref, rgla_crgo_pk
	</select>
</mapper>
