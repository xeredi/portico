<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.ReglaDAO">
    <resultMap type="ReglaVO" id="ResultMap">
        <id column="rglv_pk" />
        <result column="rgla_pk" property="id" />
        <result column="rgla_codigo" property="codigo" />

        <association property="rglv" javaType="ReglaVersionVO">
            <result column="rglv_pk" property="id" />
            <result column="rglv_fini" property="fini" />
            <result column="rglv_ffin" property="ffin" />
            <result column="rglv_tipo" property="tipo" />
            <result column="rglv_orden" property="orden" />
            <result column="rglv_importe_base" property="importeBase" />
            <result column="rglv_condicion" property="condicion" />
            <result column="rglv_formula" property="formula" />
            <result column="rglv_path_impuesto" property="pathImpuesto" />
            <result column="rglv_path_pagador" property="pathPagador" />
            <result column="rglv_path_es_suj_pasivo" property="pathEsSujPasivo" />
            <result column="rglv_path_cod_exen" property="pathCodExen" />

            <result column="rglv_path_info1" property="pathInfo1" />
            <result column="rglv_path_info2" property="pathInfo2" />
            <result column="rglv_path_info3" property="pathInfo3" />
            <result column="rglv_path_info4" property="pathInfo4" />
            <result column="rglv_path_info5" property="pathInfo5" />
            <result column="rglv_path_info6" property="pathInfo6" />

            <result column="rglv_etiq_info1" property="etiqInfo1" />
            <result column="rglv_etiq_info2" property="etiqInfo2" />
            <result column="rglv_etiq_info3" property="etiqInfo3" />
            <result column="rglv_etiq_info4" property="etiqInfo4" />
            <result column="rglv_etiq_info5" property="etiqInfo5" />
            <result column="rglv_etiq_info6" property="etiqInfo6" />

            <result column="rglv_path_cuant1" property="pathCuant1" />
            <result column="rglv_path_cuant2" property="pathCuant2" />
            <result column="rglv_path_cuant3" property="pathCuant3" />
            <result column="rglv_path_cuant4" property="pathCuant4" />
            <result column="rglv_path_cuant5" property="pathCuant5" />
            <result column="rglv_path_cuant6" property="pathCuant6" />

            <result column="rglv_etiq_cuant1" property="etiqCuant1" />
            <result column="rglv_etiq_cuant2" property="etiqCuant2" />
            <result column="rglv_etiq_cuant3" property="etiqCuant3" />
            <result column="rglv_etiq_cuant4" property="etiqCuant4" />
            <result column="rglv_etiq_cuant5" property="etiqCuant5" />
            <result column="rglv_etiq_cuant6" property="etiqCuant6" />

            <association property="enti" resultMap="xeredi.integra.model.metamodelo.dao.EntidadDAO.ResultMap" />
        </association>

        <association property="crgo" resultMap="xeredi.integra.model.facturacion.dao.CargoDAO.ResultMap" />
    </resultMap>

    <sql id="SelectPrefix">
    <![CDATA[
        SELECT *
        FROM portico.vw_regla_rgla
    ]]>
    </sql>

    <sql id="SelectWhere">
        <where>
            <if test="fechaVigencia != null">
                AND #{fechaVigencia} BETWEEN rglv_fini AND COALESCE(rglv_ffin, #{fechaVigencia})
            </if>

            <if test="id != null">
                AND rgla_pk = #{id}
            </if>

            <if test="ids != null">
                AND rgla_pk IN
                <foreach collection="ids" open="(" close=")" separator="," item="value">#{value}</foreach>
            </if>

            <if test="incompatibleId != null">
            <![CDATA[
            	AND EXISTS (
            		SELECT 1
            		FROM tbl_regla_inc_rgin
            		WHERE
            			rgin_rgla1_pk = rgla_pk
            ]]>
                <if test="fechaVigencia != null">
                <![CDATA[
            			AND EXISTS (
            				SELECT 1
            				FROM tbl_regla_inc_version_rgiv
            				WHERE rgiv_rgin_pk = rgin_pk
            					AND #{fechaVigencia} BETWEEN rgiv_fini AND COALESCE(rgiv_ffin, #{fechaVigencia})
            			)
                ]]>
                </if>
            <![CDATA[
                        AND  rgin_rgla2_pk = #{incompatibleId}
                )
            ]]>
            </if>

            <if test="rglvId != null">
                AND rglv_pk = #{rglvId}
            </if>

            <if test="crgoId != null">
                AND rgla_crgo_pk = #{crgoId}
            </if>

            <if test="crgvId != null">
            <![CDATA[
            	EXISTS (
            		SELECT 1
            		FROM tbl_cargo_version_crgv
            		WHERE
            			crgv_crgo_pk = rgla_crgo_pk
            			AND rglv_fini BETWEEN crgv_fini AND COALESCE(crgv_ffin, rglv_fini)
            			AND COALESCE(rglv_ffin, GETSYSDATETIME()) BETWEEN crgv_fini AND COALESCE(crgv_ffin, COALESCE(rglv_ffin, GETSYSDATETIME()))
                        AND crgv_pk = #{crgvId}
            	)
            ]]>
            </if>

            <if test="tipo != null">
                AND rglv_tipo = #{tipo}
            </if>

            <if test="vlrcId != null">
            <![CDATA[
            	AND EXISTS (
            		SELECT 1
            		FROM tbl_valoracion_vlrc
            		WHERE
            			EXISTS (
            				SELECT 1
            				FROM tbl_aspecto_version_aspv
            				WHERE aspv_aspc_pk = vlrc_aspc_pk
            					AND vlrc_fref BETWEEN aspv_fini AND COALESCE(aspv_ffin, vlrc_fref)
            					AND EXISTS (
            						SELECT 1
            						FROM tbl_aspecto_cargo_ascr
            						WHERE
            							ascr_aspv_pk = aspv_pk
            							AND ascr_crgo_pk = rgla_crgo_pk
            					)
            			)
            			AND vlrc_fref BETWEEN rglv_fini AND COALESCE(rglv_ffin, vlrc_fref)
            			AND vlrc_pk = #{vlrcId}
            	)
            ]]>
            </if>
        </where>
    </sql>

    <select id="selectList" parameterType="ReglaCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
        ORDER BY rgla_crgo_pk, rglv_enti_pk, rglv_orden
    </select>

    <select id="selectObject" parameterType="ReglaCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="count" parameterType="ReglaCriterioVO" resultType="Integer">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_regla_rgla
    ]]>
        <include refid="SelectWhere" />
    </select>

    <select id="exists" parameterType="ReglaVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM tbl_regla_rgla
        WHERE rgla_codigo = #{codigo}
            AND rgla_crgo_pk = #{crgo.id}
    ]]>
    </select>

    <select id="existsOverlap" parameterType="ReglaVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_regla_rgla
        WHERE
            rgla_pk = #{id}
            AND (
                #{rglv.fini} BETWEEN rglv_fini AND COALESCE(rglv_ffin, #{rglv.fini})
                OR COALESCE(#{rglv.ffin}, portico.getSysdateTime()) BETWEEN rglv_fini AND COALESCE(rglv_ffin, COALESCE(#{rglv.ffin}, portico.getSysdateTime()))
            )
    ]]>
        <if test="rglv.id != null">
        <![CDATA[
            AND rglv_pk <> #{rglv.id}
        ]]>
        </if>
    </select>

    <select id="selectId" parameterType="ReglaVO" resultType="Long">
    <![CDATA[
        SELECT rgla_pk
        FROM tbl_regla_rgla
        WHERE rgla_codigo = #{codigo}
            AND rgla_crgo_pk = #{crgo.id}
    ]]>
    </select>

    <insert id="insert" parameterType="ReglaVO">
    <![CDATA[
        INSERT INTO tbl_regla_rgla (rgla_pk, rgla_codigo, rgla_crgo_pk)
        VALUES (#{id}, #{codigo}, #{crgo.id})
    ]]>
    </insert>

    <insert id="insertVersion" parameterType="ReglaVO">
    <![CDATA[
        INSERT INTO tbl_regla_version_rglv (
            rglv_pk, rglv_rgla_pk, rglv_fini, rglv_ffin, rglv_enti_pk, rglv_tipo, rglv_orden, rglv_importe_base, rglv_condicion, rglv_formula
            , rglv_path_impuesto, rglv_path_pagador, rglv_path_es_suj_pasivo, rglv_path_cod_exen
            , rglv_path_info1, rglv_path_info2, rglv_path_info3, rglv_path_info4, rglv_path_info5, rglv_path_info6
            , rglv_etiq_info1, rglv_etiq_info2, rglv_etiq_info3, rglv_etiq_info4, rglv_etiq_info5, rglv_etiq_info6
            , rglv_path_cuant1, rglv_path_cuant2, rglv_path_cuant3, rglv_path_cuant4, rglv_path_cuant5, rglv_path_cuant6
            , rglv_etiq_cuant1, rglv_etiq_cuant2, rglv_etiq_cuant3, rglv_etiq_cuant4, rglv_etiq_cuant5, rglv_etiq_cuant6
        ) VALUES (
            #{rglv.id}, #{id}, #{rglv.fini}, #{rglv.ffin}, #{rglv.enti.id}, #{rglv.tipo}, #{rglv.orden}, #{rglv.importeBase}, #{rglv.condicion}, #{rglv.formula}
            , #{rglv.pathImpuesto}, #{rglv.pathPagador}, #{rglv.pathEsSujPasivo}, #{rglv.pathCodExen}
            , #{rglv.pathInfo1}, #{rglv.pathInfo2}, #{rglv.pathInfo3}, #{rglv.pathInfo4}, #{rglv.pathInfo5}, #{rglv.pathInfo6}
            , #{rglv.etiqInfo1}, #{rglv.etiqInfo2}, #{rglv.etiqInfo3}, #{rglv.etiqInfo4}, #{rglv.etiqInfo5}, #{rglv.etiqInfo6}
            , #{rglv.pathCuant1}, #{rglv.pathCuant2}, #{rglv.pathCuant3}, #{rglv.pathCuant4}, #{rglv.pathCuant5}, #{rglv.pathCuant6}
            , #{rglv.etiqCuant1}, #{rglv.etiqCuant2}, #{rglv.etiqCuant3}, #{rglv.etiqCuant4}, #{rglv.etiqCuant5}, #{rglv.etiqCuant6}
        )
    ]]>
    </insert>

    <update id="updateVersion" parameterType="ReglaVO">
    <![CDATA[
        UPDATE tbl_regla_version_rglv SET
            rglv_fini = #{rglv.fini}
            , rglv_ffin = #{rglv.ffin}
            , rglv_enti_pk = #{rglv.enti.id}
            , rglv_tipo = #{rglv.tipo}
            , rglv_orden = #{rglv.orden}
            , rglv_importe_base = #{rglv.importeBase}
            , rglv_condicion = #{rglv.condicion}
            , rglv_formula   = #{rglv.formula}
            , rglv_path_impuesto = #{rglv.pathImpuesto}
            , rglv_path_pagador = #{rglv.pathPagador}
            , rglv_path_es_suj_pasivo = #{rglv.pathEsSujPasivo}
            , rglv_path_cod_exen = #{rglv.pathCodExen}

            , rglv_path_info1 = #{rglv.pathInfo1}
            , rglv_path_info2 = #{rglv.pathInfo2}
            , rglv_path_info3 = #{rglv.pathInfo3}
            , rglv_path_info4 = #{rglv.pathInfo4}
            , rglv_path_info5 = #{rglv.pathInfo5}
            , rglv_path_info6 = #{rglv.pathInfo6}

            , rglv_etiq_info1 = #{rglv.etiqInfo1}
            , rglv_etiq_info2 = #{rglv.etiqInfo2}
            , rglv_etiq_info3 = #{rglv.etiqInfo3}
            , rglv_etiq_info4 = #{rglv.etiqInfo4}
            , rglv_etiq_info5 = #{rglv.etiqInfo5}
            , rglv_etiq_info6 = #{rglv.etiqInfo6}

            , rglv_path_cuant1 = #{rglv.pathCuant1}
            , rglv_path_cuant2 = #{rglv.pathCuant2}
            , rglv_path_cuant3 = #{rglv.pathCuant3}
            , rglv_path_cuant4 = #{rglv.pathCuant4}
            , rglv_path_cuant5 = #{rglv.pathCuant5}
            , rglv_path_cuant6 = #{rglv.pathCuant6}

            , rglv_etiq_cuant1 = #{rglv.etiqCuant1}
            , rglv_etiq_cuant2 = #{rglv.etiqCuant2}
            , rglv_etiq_cuant3 = #{rglv.etiqCuant3}
            , rglv_etiq_cuant4 = #{rglv.etiqCuant4}
            , rglv_etiq_cuant5 = #{rglv.etiqCuant5}
            , rglv_etiq_cuant6 = #{rglv.etiqCuant6}
        WHERE
            rglv_pk = #{rglv.id}
    ]]>
    </update>

    <delete id="deleteVersion" parameterType="ReglaVO">
    <![CDATA[
        DELETE FROM tbl_regla_version_rglv
        WHERE
            rglv_pk = #{rglv.id}
    ]]>
    </delete>
</mapper>
