<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.FacturaImpuestoDAO">
	<resultMap type="FacturaImpuestoVO" id="ResultMap">
		<id column="fcti_fctr_pk" />
		<id column="fcti_impuesto_prmt_pk" />
		<id column="fcti_porcentaje" />

		<result column="fcti_fctr_pk" property="fctrId" />
		<result column="fcti_porcentaje" property="porcentaje" />
		<result column="fcti_importe_base" property="importeBase" />
		<result column="fcti_importe_impuesto" property="importeImpuesto" />

		<association property="impuesto" javaType="ParametroVO">
			<result column="fcti_impuesto_prmt_pk" property="id" />
			<result column="fcti_impuesto_prmt" property="parametro" />
		</association>
	</resultMap>

	<select id="selectList" resultMap="ResultMap" parameterType="FacturaCriterioVO">
    <![CDATA[
		SELECT
		    fctl_fctr_pk AS fcti_fctr_pk
		    , fctl_impuesto_prmt_pk AS fcti_impuesto_prmt_pk
		    , (SELECT prmt_parametro FROM tbl_parametro_prmt WHERE prmt_pk = fctl_impuesto_prmt_pk) AS fcti_impuesto_prmt
		    , fcti_porcentaje
		    , SUM(fctl_importe) AS fcti_importe_base
		    , SUM(fctl_importe * fcti_porcentaje) / 100 AS fcti_importe_impuesto
		FROM (
		    WITH tipoIva AS (
		        SELECT
		            prvr_pk, prvr_prmt_pk, prvr_fini, prvr_ffin
		            , (SELECT prdt_ndecimal FROM tbl_parametro_dato_prdt
		                WHERE prdt_prvr_pk = prvr_pk AND prdt_tpdt_pk = portico.getTipoDato('DECIMAL_01')) AS prdt_ndecimal
		        FROM
		            tbl_parametro_version_prvr
		        WHERE
		            prvr_prmt_pk = ANY (
		                SELECT prmt_pk
		                FROM tbl_parametro_prmt
		                WHERE prmt_tppr_pk = portico.getEntidad('TIPO_IVA')
		            )
		    )
		    SELECT
		        fctl_pk, fctl_fctr_pk, fctl_impuesto_prmt_pk

		        , (
		            SELECT prdt_ndecimal
		            FROM tipoIva
		            WHERE
		                prvr_prmt_pk = fctl_impuesto_prmt_pk
		                AND fcts_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, fcts_fref)
		        ) AS fcti_porcentaje

		        , (
		            SELECT SUM(fctd_importe)
		            FROM
		                tbl_factura_det_fctd
		            WHERE
		                fctd_fctl_pk = fctl_pk
		        ) AS fctl_importe
		    FROM
		        tbl_factura_lin_fctl
		        INNER JOIN tbl_factura_srv_fcts ON
		            fcts_pk = fctl_fcts_pk
    ]]>
		<where>
			<if test="id != null">
		    <![CDATA[
				AND fctl_fctr_pk = #{id}
    		]]>
			</if>
		</where>
    <![CDATA[
		) sql
		GROUP BY fctl_fctr_pk, fctl_impuesto_prmt_pk, fcti_porcentaje
		ORDER BY fctl_fctr_pk, fcti_porcentaje DESC
    ]]>
	</select>
</mapper>
