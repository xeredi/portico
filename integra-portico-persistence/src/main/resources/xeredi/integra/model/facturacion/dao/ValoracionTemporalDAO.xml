<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.ValoracionTemporalDAO">
    <resultMap type="ValoracionTemporalVO" id="ResultMap">
        <result column="vlrt_pk" property="id" />
        <result column="vlrt_padre_pk" property="padreId" />
        <result column="vlrt_prbt_pk" property="prbtId" />
        <result column="vlrt_srvc_pk" property="srvcId" />
        <result column="vlrt_orden" property="orden" />
        <result column="vlrt_valor_base" property="valorBase" />
        <result column="vlrt_importe_base" property="importeBase" />
        <result column="vlrt_importe" property="importe" />
        <result column="vlrt_importe_inc" property="importeInc" />
        <result column="vlrt_es_suj_pasivo" property="sujPasivo" />
        <result column="vlrt_cod_exen" property="codExencion" />
        <result column="vlrt_fref" property="freferencia" />
        <result column="vlrt_fliq" property="fliquidacion" />
        <result column="vlrt_fini" property="finicio" />
        <result column="vlrt_ffin" property="ffin" />

        <result column="vlrt_cuant1" property="cuant1" />
        <result column="vlrt_cuant2" property="cuant2" />
        <result column="vlrt_cuant3" property="cuant3" />
        <result column="vlrt_cuant4" property="cuant4" />
        <result column="vlrt_cuant5" property="cuant5" />
        <result column="vlrt_cuant6" property="cuant6" />

        <result column="vlrt_info1" property="info1" />
        <result column="vlrt_info2" property="info2" />
        <result column="vlrt_info3" property="info3" />
        <result column="vlrt_info4" property="info4" />
        <result column="vlrt_info5" property="info5" />
        <result column="vlrt_info6" property="info6" />

        <association property="ssrv" columnPrefix="vlrt_"
            resultMap="xeredi.integra.model.servicio.dao.SubservicioDAO.ResultMap" />
        <association property="crgo" columnPrefix="vlrt_"
            resultMap="xeredi.integra.model.facturacion.dao.CargoDAO.ResultMap" />
        <association property="rgla" columnPrefix="vlrt_"
            resultMap="xeredi.integra.model.facturacion.dao.ReglaDAO.ResultMap" />
        <association property="impuesto" columnPrefix="vlrt_impuesto_"
            resultMap="xeredi.integra.model.maestro.dao.ParametroDAO.ResultMap" />
        <association property="pagador" columnPrefix="vlrt_pagador_"
            resultMap="xeredi.integra.model.maestro.dao.ParametroDAO.ResultMap" />
    </resultMap>

    <select id="selectAplicarReglaServicio" parameterType="ValoradorContextoVO" resultMap="ResultMap">
    <![CDATA[
    SELECT
        #{prbt.id} AS vlrt_prbt_pk
        , srvc_pk AS vlrt_srvc_pk
        , rgla_crgo_pk AS vlrt_crgo_pk
        , rgla_pk AS vlrt_rgla_pk
        , NULL AS vlrt_padre_pk
        , (SELECT rglv_importe_base FROM tbl_regla_version_rglv WHERE rglv_pk = #{rgla.rglv.id}) AS vlrt_valor_base
        , 0 AS vlrt_importe_base
        , (${rgla.rglv.formulaSql}) AS vlrt_importe
        , importe_inc AS vlrt_importe_inc
    ]]>

        <if test="rgla.rglv.pathCuant1Sql != null">
            , (${rgla.rglv.pathCuant1Sql}) AS vlrt_cuant1
        </if>
        <if test="rgla.rglv.pathCuant2Sql != null">
            , (${rgla.rglv.pathCuant2Sql}) AS vlrt_cuant2
        </if>
        <if test="rgla.rglv.pathCuant3Sql != null">
            , (${rgla.rglv.pathCuant3Sql}) AS vlrt_cuant3
        </if>
        <if test="rgla.rglv.pathCuant4Sql != null">
            , (${rgla.rglv.pathCuant4Sql}) AS vlrt_cuant4
        </if>
        <if test="rgla.rglv.pathCuant5Sql != null">
            , (${rgla.rglv.pathCuant5Sql}) AS vlrt_cuant5
        </if>
        <if test="rgla.rglv.pathCuant6Sql != null">
            , (${rgla.rglv.pathCuant6Sql}) AS vlrt_cuant6
        </if>

        <if test="rgla.rglv.pathInfo1Sql != null">
            , (${rgla.rglv.pathInfo1Sql}) AS vlrt_info1
        </if>
        <if test="rgla.rglv.pathInfo2Sql != null">
            , (${rgla.rglv.pathInfo2Sql}) AS vlrt_info2
        </if>
        <if test="rgla.rglv.pathInfo3Sql != null">
            , (${rgla.rglv.pathInfo3Sql}) AS vlrt_info3
        </if>
        <if test="rgla.rglv.pathInfo4Sql != null">
            , (${rgla.rglv.pathInfo4Sql}) AS vlrt_info4
        </if>
        <if test="rgla.rglv.pathInfo5Sql != null">
            , (${rgla.rglv.pathInfo5Sql}) AS vlrt_info5
        </if>
        <if test="rgla.rglv.pathInfo6Sql != null">
            , (${rgla.rglv.pathInfo6Sql}) AS vlrt_info6
        </if>

        <if test="rgla.rglv.pathImpuestoSql != null">
            , (${rgla.rglv.pathImpuestoSql}) AS vlrt_impuesto_prmt_pk
        </if>
        <if test="rgla.rglv.pathEsSujPasivoSql != null">
            , (${rgla.rglv.pathEsSujPasivoSql}) AS vlrt_es_suj_pasivo
        </if>
        <if test="rgla.rglv.pathPagadorSql != null">
            , (${rgla.rglv.pathPagadorSql}) AS vlrt_pagador_prmt_pk
        </if>
        <if test="rgla.rglv.pathCodExenSql != null">
            , (${rgla.rglv.pathCodExenSql}) AS vlrt_cod_exen
        </if>

    <![CDATA[
    FROM (
        SELECT item.*, rgla.*, srvc_fref AS fref
            , NULL AS importe_inc
        FROM
            portico.tbl_servicio_srvc item
            JOIN portico.tbl_tipo_servicio_tpsr tpsr ON
                tpsr_pk = srvc_tpsr_pk
            JOIN portico.tbl_regla_rgla rgla ON
                rgla_enti_pk = srvc_tpsr_pk
                AND rgla_pk = #{rgla.id}
        WHERE
            tpsr_es_facturable = 1
            AND (
                tpsr_tpdt_estado_pk IS NULL
                OR (

                    (tpsr_pk = portico.getEntidad('ESCALA') AND srvc_estado IN ('I', 'F'))

                )
            )
            AND (
                tpsr_es_exencionable = 0
                OR EXISTS (
                    SELECT 1
                    FROM portico.tbl_servicio_dato_srdt
                    WHERE srdt_srvc_pk = srvc_pk
                        AND srdt_tpdt_pk = portico.getTipoDato('COD_EXEN')
                        AND srdt_cadena IN ('0', '1')
                )
            )
    ]]>
        <if test="rgla.rglv.condicionSql != null">
    <![CDATA[
            AND (${rgla.rglv.condicionSql})
    ]]>
        </if>
    <![CDATA[
            AND NOT EXISTS (
                SELECT 1
                FROM portico.tbl_servicio_cargo_srcr
                WHERE
                    srcr_srvc_pk = srvc_pk
                    AND srcr_crgo_pk = rgla_crgo_pk
                    AND (srcr_vlrc_pk IS NOT NULL OR srcr_fctr_pk IS NOT NULL)
            )
            -- TODO Ojo lo de temporalidad

            AND srvc_pk = #{srvc.id}
    ) item
    ]]>
    </select>

    <select id="selectAplicarReglaDecoradorServicio" parameterType="ValoradorContextoVO" resultMap="ResultMap">
    <![CDATA[
    SELECT
        vlrt_prbt_pk
        , srvc_pk AS vlrt_srvc_pk
        , NULL AS vlrt_ssrv_pk
        , rgla_crgo_pk AS vlrt_crgo_pk
        , rgla_pk AS vlrt_rgla_pk
        , vlrt_padre_pk AS vlrt_padre_pk
        , NULL AS vlrt_orden
        , importe_base AS vlrt_importe_base
        , (
            CASE
                WHEN rgla_tipo = 'C'
                THEN importe_base * (valor_base - 1)
                WHEN rgla_tipo = 'B'
                THEN importe_base * (- valor_base) / 100
                ELSE 0
            END
        ) AS vlrt_importe
        , valor_base AS vlrt_valor_base
        , importe_inc AS vlrt_importe_inc

        , vlrt_cuant1, vlrt_cuant2, vlrt_cuant3, vlrt_cuant4, vlrt_cuant5, vlrt_cuant6
        , vlrt_info1, vlrt_info2, vlrt_info3, vlrt_info4, vlrt_info5, vlrt_info6
        , vlrt_impuesto_prmt_pk, vlrt_es_suj_pasivo, vlrt_pagador_prmt_pk, vlrt_cod_exen
    FROM (
        SELECT *
            , COALESCE(
                (
                    SELECT SUM(vlrt_importe)
                    FROM tbl_valoracion_tmp_vlrt
                    WHERE
                        vlrt_prbt_pk = #{prbt.id}
                        AND vlrt_srvc_pk = srvc_pk
                        AND vlrt_crgo_pk = rgla_crgo_pk
                        AND NOT EXISTS (
                            SELECT 1
                            FROM tbl_regla_inc_rgin
                            WHERE
                                rgin_rgla1_pk = vlrt_rgla_pk
                                AND rgin_rgla2_pk = rgla_pk
                                AND EXISTS (
                                    SELECT 1 FROM tbl_regla_inc_version_rgiv
                                    WHERE rgiv_rgin_pk = rgin_pk
                                        AND #{fref} BETWEEN rgiv_fini AND COALESCE(rgiv_ffin, #{fref})
                                )
                        )
                )
                , 0) AS importe_base
            , (
                SELECT SUM(vlrt_importe)
                FROM tbl_valoracion_tmp_vlrt
                WHERE
                    vlrt_prbt_pk = #{prbt.id}
                    AND vlrt_srvc_pk = srvc_pk
                    AND vlrt_crgo_pk = rgla_crgo_pk
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_regla_inc_rgin
                        WHERE
                            rgin_rgla1_pk = vlrt_rgla_pk
                            AND rgin_rgla2_pk = rgla_pk
                            AND EXISTS (
                                SELECT 1 FROM tbl_regla_inc_version_rgiv
                                WHERE rgiv_rgin_pk = rgin_pk
                                    AND #{fref} BETWEEN rgiv_fini AND COALESCE(rgiv_ffin, #{fref})
                            )
                    )
                ) AS importe_inc
            , (${rgla.rglv.formulaSql}) AS valor_base
        FROM tbl_servicio_srvc item
            JOIN tbl_regla_rgla ON
                rgla_enti_pk = srvc_tpsr_pk
                AND rgla_pk = #{rgla.id}
            JOIN tbl_valoracion_tmp_vlrt ON
                vlrt_srvc_pk = srvc_pk
                AND vlrt_prbt_pk = #{prbt.id}
                        AND vlrt_crgo_pk = rgla_crgo_pk
                AND vlrt_rgla_pk = ANY (
                    SELECT rgla_pk
                    FROM tbl_regla_rgla
                    WHERE rgla_crgo_pk = vlrt_crgo_pk
                    AND rgla_tipo = 'T'
                )
        WHERE
            srvc_pk = #{srvc.id}
    ]]>
        <if test="rgla.rglv.condicionSql != null">
    <![CDATA[
            AND (${rgla.rglv.condicionSql})
    ]]>
        </if>
    <![CDATA[
    ) item
    ]]>
    </select>

    <select id="selectAplicarReglaSubservicio" parameterType="ValoradorContextoVO" resultMap="ResultMap">
    <![CDATA[
    SELECT
        #{prbt.id} AS vlrt_prbt_pk
        , srvc_pk AS vlrt_srvc_pk
        , ssrv_pk AS vlrt_ssrv_pk
        , rgla_crgo_pk AS vlrt_crgo_pk
        , rgla_pk AS vlrt_rgla_pk
        , NULL AS vlrt_padre_pk
        , ssrv_numero AS vlrt_orden
        , (SELECT rglv_importe_base FROM tbl_regla_version_rglv WHERE rglv_pk = #{rgla.rglv.id}) AS vlrt_valor_base
        , 0 AS vlrt_importe_base
        , (${rgla.rglv.formulaSql}) AS vlrt_importe
        , importe_inc AS vlrt_importe_inc
    ]]>

        <if test="rgla.rglv.pathCuant1Sql != null">
            , (${rgla.rglv.pathCuant1Sql}) AS vlrt_cuant1
        </if>
        <if test="rgla.rglv.pathCuant2Sql != null">
            , (${rgla.rglv.pathCuant2Sql}) AS vlrt_cuant2
        </if>
        <if test="rgla.rglv.pathCuant3Sql != null">
            , (${rgla.rglv.pathCuant3Sql}) AS vlrt_cuant3
        </if>
        <if test="rgla.rglv.pathCuant4Sql != null">
            , (${rgla.rglv.pathCuant4Sql}) AS vlrt_cuant4
        </if>
        <if test="rgla.rglv.pathCuant5Sql != null">
            , (${rgla.rglv.pathCuant5Sql}) AS vlrt_cuant5
        </if>
        <if test="rgla.rglv.pathCuant6Sql != null">
            , (${rgla.rglv.pathCuant6Sql}) AS vlrt_cuant6
        </if>

        <if test="rgla.rglv.pathInfo1Sql != null">
            , (${rgla.rglv.pathInfo1Sql}) AS vlrt_info1
        </if>
        <if test="rgla.rglv.pathInfo2Sql != null">
            , (${rgla.rglv.pathInfo2Sql}) AS vlrt_info2
        </if>
        <if test="rgla.rglv.pathInfo3Sql != null">
            , (${rgla.rglv.pathInfo3Sql}) AS vlrt_info3
        </if>
        <if test="rgla.rglv.pathInfo4Sql != null">
            , (${rgla.rglv.pathInfo4Sql}) AS vlrt_info4
        </if>
        <if test="rgla.rglv.pathInfo5Sql != null">
            , (${rgla.rglv.pathInfo5Sql}) AS vlrt_info5
        </if>
        <if test="rgla.rglv.pathInfo6Sql != null">
            , (${rgla.rglv.pathInfo6Sql}) AS vlrt_info6
        </if>

        <if test="rgla.rglv.pathImpuestoSql != null">
            , (${rgla.rglv.pathImpuestoSql}) AS vlrt_impuesto_prmt_pk
        </if>
        <if test="rgla.rglv.pathEsSujPasivoSql != null">
            , (${rgla.rglv.pathEsSujPasivoSql}) AS vlrt_es_suj_pasivo
        </if>
        <if test="rgla.rglv.pathPagadorSql != null">
            , (${rgla.rglv.pathPagadorSql}) AS vlrt_pagador_prmt_pk
        </if>
        <if test="rgla.rglv.pathCodExenSql != null">
            , (${rgla.rglv.pathCodExenSql}) AS vlrt_cod_exen
        </if>

    <![CDATA[
    FROM (
        SELECT item.*, rgla.*, srvc.*, srvc_fref AS fref
            , NULL AS importe_inc
        FROM
            portico.tbl_subservicio_ssrv item
            JOIN portico.tbl_servicio_srvc srvc ON
                srvc_pk = ssrv_srvc_pk
            JOIN portico.tbl_tipo_subservicio_tpss tpss ON
                tpss_pk = ssrv_tpss_pk
            JOIN portico.tbl_tipo_servicio_tpsr tpsr ON
                tpsr_pk = srvc_tpsr_pk
            JOIN portico.tbl_regla_rgla rgla ON
                rgla_enti_pk = ssrv_tpss_pk
                AND rgla_pk = #{rgla.id}
        WHERE
            tpsr_es_facturable = 1
            AND tpss_es_facturable = 1
            AND (
                tpss_tpdt_estado_pk IS NULL
                OR (
                    (
                        tpss_pk = portico.getEntidad('PARTIDA')
                        AND ssrv_estado = 'R'
                        AND (
                            -- Regimen simplificado
                            EXISTS (
                                SELECT 1
                                FROM portico.tbl_subservicio_dato_ssdt
                                WHERE

                                    EXISTS (
                                        SELECT 1
                                        FROM portico.tbl_subservicio_ssrv
                                        WHERE
                                            ssrv_pk = ssdt_ssrv_pk
                                            AND ssrv_tpss_pk = portico.getEntidad('BL')
                                    )
                                    AND EXISTS (
                                        SELECT 1
                                        FROM portico.tbl_subserv_subserv_ssss
                                        WHERE
                                            ssss_ssrvp_pk = ssdt_ssrv_pk
                                            AND ssss_ssrvh_pk = item.ssrv_pk
                                    )
                                    AND (
                                        (ssdt_tpdt_pk = portico.getTipoDato('BOOLEANO_02') AND ssdt_nentero = 0)
                                        or (ssdt_tpdt_pk = portico.getTipoDato('TIPO_BL') AND ssdt_cadena = 'P')
                                    )
                            )
                            OR (
                                EXISTS (
                                    SELECT 1
                                    FROM
                                        portico.tbl_parametro_dato_prdt
                                    WHERE
                                        prdt_tpdt_pk = portico.getTipoDato('BOOLEANO_01')
                                        AND EXISTS (
                                            SELECT 1
                                            FROM portico.tbl_parametro_version_prvr
                                            WHERE
                                                prvr_pk = prdt_prvr_pk
                                                AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                                AND EXISTS (
                                                    SELECT 1
                                                    FROM portico.tbl_subservicio_dato_ssdt
                                                    WHERE
                                                        ssdt_prmt_pk = prvr_prmt_pk
                                                        AND ssdt_tpdt_pk = portico.getTipoDato('MERCANCIA')
                                                        AND ssdt_ssrv_pk = item.ssrv_pk
                                                )
                                        )
                                        AND prdt_nentero = 1
                                        -- TODO Falta ver que la mercancia de la unidad de carga sea nula
                                )
                            )
                        )
                    )

                    OR (tpss_pk = portico.getEntidad('EQUIPAMIENTO') AND ssrv_estado = 'R')

                    OR (tpss_pk = portico.getEntidad('PARTIDA_PESCA') AND ssrv_estado = 'R')

                    OR (tpss_pk = portico.getEntidad('ATRAQUE') AND ssrv_estado IN ('I', 'F'))
                )
            )
            AND (
                tpss_es_exencionable = 0
                OR EXISTS (
                    SELECT 1
                    FROM portico.tbl_subservicio_dato_ssdt
                    WHERE ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = portico.getTipoDato('COD_EXEN')
                        AND ssdt_cadena IN ('0', '1')
                )
            )
            AND (
                tpsr_es_exencionable = 0
                OR EXISTS (
                    SELECT 1
                    FROM portico.tbl_servicio_dato_srdt
                    WHERE srdt_srvc_pk = srvc_pk
                        AND srdt_tpdt_pk = portico.getTipoDato('COD_EXEN')
                        AND srdt_cadena IN ('0', '1')
                )
            )
    ]]>
        <if test="rgla.rglv.condicionSql != null">
    <![CDATA[
            AND (${rgla.rglv.condicionSql})
    ]]>
        </if>
    <![CDATA[
            AND (
                (
                    rgla_tipo = 'T'
                    AND NOT EXISTS (
                        SELECT 1
                        FROM portico.tbl_servicio_cargo_srcr
                        WHERE
                            srcr_srvc_pk = srvc_pk
                            AND srcr_ssrv_pk = ssrv_pk
                            AND srcr_crgo_pk = rgla_crgo_pk
                            AND (srcr_vlrc_pk IS NOT NULL OR srcr_fctr_pk IS NOT NULL)
                    )
                    -- TODO Ojo lo de temporalidad
                )
                OR (
                    rgla_tipo IN ('C', 'D')
                    AND EXISTS (
                        SELECT 1
                        FROM
                            portico.tbl_valoracion_tmp_vlrt
                        WHERE
                            vlrt_prbt_pk = #{prbt.id}
                            AND vlrt_srvc_pk = srvc_pk
                            AND vlrt_ssrv_pk = ssrv_pk
                            AND vlrt_crgo_pk = rgla_crgo_pk
                            AND vlrt_rgla_pk = ANY(
                                SELECT rgla_pk
                                FROM portico.tbl_regla_rgla
                                WHERE
                                    rgla_crgo_pk = vlrt_crgo_pk
                                    AND rgla_tipo = 'T'
                            )
                    )
                )
            )

            AND ssrv_srvc_pk = #{srvc.id}
    ) item
    ORDER BY ssrv_srvc_pk, ssrv_tpss_pk, ssrv_numero
    ]]>
    </select>

    <select id="selectAplicarReglaDecoradorSubservicio" parameterType="ValoradorContextoVO" resultMap="ResultMap">
    <![CDATA[
    SELECT
        vlrt_prbt_pk
        , ssrv_srvc_pk AS vlrt_srvc_pk
        , ssrv_pk AS vlrt_ssrv_pk
        , rgla_crgo_pk AS vlrt_crgo_pk
        , rgla_pk AS vlrt_rgla_pk
        , vlrt_pk AS vlrt_padre_pk
        , ssrv_numero AS vlrt_orden
        , importe_base AS vlrt_importe_base
        , (
            CASE
                WHEN rgla_tipo = 'C'
                THEN importe_base * (valor_base - 1)
                WHEN rgla_tipo = 'B'
                THEN importe_base * (- valor_base) / 100
                ELSE 0
            END
        ) AS vlrt_importe
        , valor_base AS vlrt_valor_base
        , importe_inc AS vlrt_importe_inc

        , vlrt_cuant1, vlrt_cuant2, vlrt_cuant3, vlrt_cuant4, vlrt_cuant5, vlrt_cuant6
        , vlrt_info1, vlrt_info2, vlrt_info3, vlrt_info4, vlrt_info5, vlrt_info6
        , vlrt_impuesto_prmt_pk, vlrt_es_suj_pasivo, vlrt_pagador_prmt_pk, vlrt_cod_exen
    FROM (
        SELECT *
            , COALESCE(
                (
                    SELECT SUM(vlrt_importe)
                    FROM tbl_valoracion_tmp_vlrt
                    WHERE
                        vlrt_prbt_pk = #{prbt.id}
                        AND vlrt_srvc_pk = ssrv_srvc_pk
                        AND vlrt_ssrv_pk = ssrv_pk
                        AND vlrt_crgo_pk = rgla_crgo_pk
                        AND NOT EXISTS (
                            SELECT 1
                            FROM tbl_regla_inc_rgin
                            WHERE
                                rgin_rgla1_pk = vlrt_rgla_pk
                                AND rgin_rgla2_pk = rgla_pk
                                AND EXISTS (
                                    SELECT 1 FROM tbl_regla_inc_version_rgiv
                                    WHERE rgiv_rgin_pk = rgin_pk
                                        AND #{fref} BETWEEN rgiv_fini AND COALESCE(rgiv_ffin, #{fref})
                                )
                        )
                )
            , 0) AS importe_base
            , (
                SELECT SUM(vlrt_importe)
                FROM tbl_valoracion_tmp_vlrt
                WHERE
                    vlrt_prbt_pk = #{prbt.id}
                    AND vlrt_srvc_pk = ssrv_srvc_pk
                    AND vlrt_ssrv_pk = ssrv_pk
                    AND vlrt_crgo_pk = rgla_crgo_pk
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_regla_inc_rgin
                        WHERE
                            rgin_rgla1_pk = vlrt_rgla_pk
                            AND rgin_rgla2_pk = rgla_pk
                            AND EXISTS (
                                SELECT 1 FROM tbl_regla_inc_version_rgiv
                                WHERE rgiv_rgin_pk = rgin_pk
                                    AND #{fref} BETWEEN rgiv_fini AND COALESCE(rgiv_ffin, #{fref})
                            )
                    )
            ) AS importe_inc
            , (${rgla.rglv.formulaSql}) AS valor_base
        FROM tbl_subservicio_ssrv item
            JOIN tbl_regla_rgla ON
                rgla_enti_pk = ssrv_tpss_pk
                AND rgla_pk = #{rgla.id}
            JOIN tbl_valoracion_tmp_vlrt ON
                vlrt_srvc_pk = ssrv_srvc_pk
                AND vlrt_ssrv_pk = ssrv_pk
                AND vlrt_prbt_pk = #{prbt.id}
                        AND vlrt_crgo_pk = rgla_crgo_pk
                AND vlrt_rgla_pk = ANY (
                    SELECT rgla_pk
                    FROM tbl_regla_rgla
                    WHERE rgla_crgo_pk = vlrt_crgo_pk
                    AND rgla_tipo = 'T'
                )
        WHERE
            ssrv_srvc_pk = #{srvc.id}
    ]]>
        <if test="rgla.rglv.condicionSql != null">
    <![CDATA[
            AND (${rgla.rglv.condicionSql})
    ]]>
        </if>
    <![CDATA[
    ) item
    ORDER BY ssrv_srvc_pk, ssrv_tpss_pk, ssrv_numero
    ]]>
    </select>

    <insert id="insert" parameterType="ValoracionTemporalVO">
    <![CDATA[
    INSERT INTO tbl_valoracion_tmp_vlrt (
        vlrt_pk, vlrt_padre_pk, vlrt_prbt_pk, vlrt_srvc_pk, vlrt_ssrv_pk, vlrt_crgo_pk, vlrt_rgla_pk, vlrt_rgla_tipo, vlrt_impuesto_prmt_pk, vlrt_pagador_prmt_pk
        , vlrt_orden, vlrt_valor_base, vlrt_importe_base, vlrt_importe, vlrt_es_suj_pasivo, vlrt_cod_exen
        , vlrt_fref, vlrt_fliq, vlrt_fini, vlrt_ffin
        , vlrt_cuant1, vlrt_cuant2, vlrt_cuant3, vlrt_cuant4, vlrt_cuant5, vlrt_cuant6
        , vlrt_info1, vlrt_info2, vlrt_info3, vlrt_info4, vlrt_info5, vlrt_info6
    ) VALUES (
        #{id}, #{padreId}, #{prbtId}, #{srvcId}, #{ssrv.id}, #{crgo.id}, #{rgla.id}, #{rgla.tipo}, #{impuesto.id}, #{pagador.id}
        , #{orden}, #{valorBase}, #{importeBase}, #{importe}, #{sujPasivo, jdbcType=INTEGER, javaType=Boolean}, #{codExencion}
        , #{freferencia}, #{fliquidacion}, #{finicio}, #{ffin}
        , #{cuant1}, #{cuant2}, #{cuant3}, #{cuant4}, #{cuant5}, #{cuant6}
        , #{info1}, #{info2}, #{info3}, #{info4}, #{info5}, #{info6}
    )
    ]]>
    </insert>

    <select id="existsPendiente" parameterType="ValoradorContextoVO" resultType="boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM
            tbl_valoracion_tmp_vlrt
        WHERE
            vlrt_prbt_pk = #{prbt.id}
    ]]>
    </select>

    <delete id="deleteList" parameterType="ValoradorContextoVO">
    <![CDATA[
        DELETE FROM
            tbl_valoracion_tmp_vlrt
        WHERE
            EXISTS (
                SELECT 1
                FROM tbl_aspecto_cargo_ascr
                WHERE
                    ascr_crgo_pk = vlrt_crgo_pk
                    AND ascr_aspv_pk = #{aspc.aspv.id}
            )
            AND vlrt_srvc_pk = #{srvc.id}
            AND vlrt_prbt_pk = #{prbt.id}
    ]]>
    </delete>

    <delete id="deleteIncompatibilidadList" parameterType="ValoracionTemporalVO">
        <![CDATA[
        DELETE FROM
            tbl_valoracion_tmp_vlrt
        WHERE
        	vlrt_prbt_pk = #{prbtId}
        	AND vlrt_srvc_pk = #{srvcId}
        	AND vlrt_crgo_pk = #{crgo.id}
        	AND EXISTS (
        		SELECT 1
        		FROM tbl_regla_inc_rgin
        		WHERE
        			rgin_rgla2_pk = vlrt_rgla_pk
        			AND rgin_rgla1_pk = #{rgla.id}
        			AND EXISTS (
        				SELECT 1
        				FROM tbl_regla_inc_version_rgiv
        				WHERE rgiv_rgin_pk = rgin_pk
        					AND #{freferencia} BETWEEN rgiv_fini AND COALESCE(rgiv_ffin, #{freferencia})
        			)
        	)
        ]]>

        <if test="ssrv != null and ssrv.id != null">
        <![CDATA[
            AND vlrt_ssrv_pk = #{ssrv.id}
        ]]>
        </if>
    </delete>

    <update id="updateRecalcularCargo" parameterType="ValoradorContextoVO">
        <![CDATA[
        UPDATE tbl_valoracion_tmp_vlrt vlrt SET
        	vlrt_importe_base = sql.importe_base_corr
        	, vlrt_importe = (
                CASE
                    WHEN vlrt_rgla_tipo = 'C'
                    THEN sql.importe_base_corr * (vlrt_valor_base - 1)

                    WHEN vlrt_rgla_tipo = 'D'
                    THEN sql.importe_base_corr * (- vlrt_valor_base) / 100
                END
        	)
        FROM
        	(
        		SELECT vlrt.vlrt_pk
        			, SUM(vlrtAux.vlrt_importe) AS importe_base_corr
        		FROM
        			tbl_valoracion_tmp_vlrt vlrt
        			JOIN tbl_valoracion_tmp_vlrt vlrtAux ON
        				vlrtAux.vlrt_padre_pk = vlrt.vlrt_padre_pk
        				AND vlrtAux.vlrt_pk < vlrt.vlrt_pk
        		WHERE
        			vlrt.vlrt_prbt_pk = #{prbt.id}
        			AND vlrt.vlrt_srvc_pk = #{srvc.id}
        			AND vlrt.vlrt_crgo_pk = #{crgo.id}
        			AND vlrt.vlrt_rgla_tipo <> 'T'
        		GROUP BY vlrt.vlrt_pk
        	) sql
        WHERE
        	vlrt.vlrt_pk = sql.vlrt_pk
        ]]>
    </update>
</mapper>
