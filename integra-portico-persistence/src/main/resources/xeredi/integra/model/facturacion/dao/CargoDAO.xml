<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.CargoDAO">
    <resultMap type="CargoVO" id="ResultMap">
        <id column="crgv_pk" />
        <id column="crgo_pk" />

        <result column="crgo_pk" property="id" />
        <result column="crgo_codigo" property="codigo" />

        <association property="crgv" javaType="CargoVersionVO">
            <result column="crgv_pk" property="id" />
            <result column="crgv_fini" property="fini" />
            <result column="crgv_ffin" property="ffin" />
            <result column="crgv_codigo_norm" property="codigoNormalizado" />
            <result column="crgv_es_principal" property="principal" />
            <result column="crgv_es_temporal" property="temporal" />
            <result column="crgv_tipo" property="tipo" />
            <result column="crgv_descripcion" property="descripcion" />
        </association>

        <association property="tpsr" javaType="TipoServicioVO">
            <result column="crgo_tpsr_pk" property="id" />
            <result column="enti_codigo" property="codigo" />
            <result column="enti_nombre" property="nombre" />
        </association>
    </resultMap>

    <sql id="SelectPrefix">
    <![CDATA[
        SELECT *
        FROM vw_cargo_crgo
    ]]>
    </sql>

    <sql id="SelectWhere">
        <where>
            <if test="fechaVigencia != null">
                AND #{fechaVigencia} BETWEEN crgv_fini AND COALESCE(crgv_ffin, #{fechaVigencia})
            </if>

            <if test="id != null">
                AND crgo_pk = #{id}
            </if>

            <if test="ids != null">
                AND crgo_pk IN
                <foreach collection="ids" open="(" close=")" separator="," item="value">#{value}</foreach>
            </if>

            <if test="tpsrId != null">
                AND crgo_tpsr_pk = #{tpsrId}
            </if>

            <if test="crgvId != null">
                AND crgv_pk = #{crgvId}
            </if>

            <if test="padreId != null">
            <![CDATA[
                AND EXISTS (
                    SELECT 1
                    FROM tbl_cargo_dep_crdp
                    WHERE crdp_crgoh_pk = crgo_pk
                        AND crdp_crgop_pk = #{padreId}
            ]]>
                <if test="fechaVigencia != null">
                <![CDATA[
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_cargo_dep_version_crdv
                            WHERE crdv_crdp_pk = crdp_pk
                                AND #{fechaVigencia} BETWEEN crdv_fini AND COALESCE(crdv_ffin, #{fechaVigencia})
                        )
                ]]>
                </if>
            <![CDATA[
                )
            ]]>
            </if>

            <if test="padreIds != null">
            <![CDATA[
                AND EXISTS (
                    SELECT 1
                    FROM tbl_cargo_dep_crdp
                    WHERE crdp_crgoh_pk = crgo_pk
                        AND crdp_crgop_pk IN
            ]]>
                <foreach collection="padreIds" open="(" close=")" separator="," item="value">#{value}</foreach>
                <if test="fechaVigencia != null">
                <![CDATA[
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_cargo_dep_version_crdv
                            WHERE crdv_crdp_pk = crdp_pk
                                AND #{fechaVigencia} BETWEEN crdv_fini AND COALESCE(crdv_ffin, #{fechaVigencia})
                        )
                ]]>
                </if>
            <![CDATA[
                )
            ]]>
            </if>

            <if test="soloPrincipales">
                AND crgv_es_principal = 1
            </if>

            <if test="soloDependientes">
                AND crgv_es_principal = 0
            </if>

            <if test="codigo != null">
                AND crgo_codigo LIKE #{codigo}
            </if>

            <if test="codigoNormalizado != null">
                AND crgv_codigo_norm LIKE #{codigoNormalizado}
            </if>
        </where>
    </sql>

    <select id="count" parameterType="CargoCriterioVO" resultType="Integer">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_cargo_crgo
    ]]>
        <include refid="SelectWhere" />
    </select>

    <select id="exists" parameterType="CargoVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM tbl_cargo_crgo
        WHERE crgo_codigo = #{codigo}
            AND crgo_tpsr_pk = #{tpsr.id}
    ]]>
    </select>

    <select id="existsOverlap" parameterType="CargoVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_cargo_crgo
        WHERE
            crgo_pk = #{id}
            AND (
        		#{crgv.fini} BETWEEN crgv_fini AND COALESCE(crgv_ffin, #{crgv.fini})
        		OR COALESCE(#{crgv.ffin}, portico.getSysdateTime()) BETWEEN crgv_fini AND COALESCE(crgv_ffin, COALESCE(#{crgv.ffin}, portico.getSysdateTime()))
            )
    ]]>
        <if test="crgv.id != null">
        <![CDATA[
            AND crgv_pk <> #{crgv.id}
        ]]>
        </if>
    </select>

    <select id="selectId" parameterType="CargoVO" resultType="Long">
    <![CDATA[
        SELECT crgo_pk
        FROM tbl_cargo_crgo
        WHERE crgo_codigo = #{codigo}
            AND crgo_tpsr_pk = #{tpsr.id}
    ]]>
    </select>

    <select id="selectList" parameterType="CargoCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
        ORDER BY crgo_tpsr_pk, crgo_codigo
    </select>

    <select id="selectObject" parameterType="CargoCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <insert id="insert" parameterType="CargoVO">
    <![CDATA[
        INSERT INTO tbl_cargo_crgo (crgo_pk, crgo_codigo, crgo_tpsr_pk)
        VALUES (
            #{id}, #{codigo}, #{tpsr.id})
    ]]>
    </insert>

    <insert id="insertVersion" parameterType="CargoVO">
    <![CDATA[
        INSERT INTO tbl_cargo_version_crgv (crgv_pk, crgv_crgo_pk, crgv_fini, crgv_ffin, crgv_codigo_norm, crgv_es_principal, crgv_es_temporal, crgv_tipo, crgv_descripcion)
        VALUES (#{crgv.id}, #{id}, #{crgv.fini}, #{crgv.ffin}, #{crgv.codigoNormalizado}
            , #{crgv.principal, jdbcType=INTEGER, javaType=Boolean}
            , #{crgv.temporal, jdbcType=INTEGER, javaType=Boolean}
            , #{crgv.tipo}, #{crgv.descripcion})
    ]]>
    </insert>

    <update id="updateVersion" parameterType="CargoVO">
    <![CDATA[
        UPDATE tbl_cargo_version_crgv SET
            crgv_fini = #{crgv.fini}
            , crgv_ffin = #{crgv.ffin}
            , crgv_codigo_norm = #{crgv.codigoNormalizado}
            , crgv_es_principal = #{crgv.principal, jdbcType=INTEGER, javaType=Boolean}
            , crgv_es_temporal = #{crgv.temporal, jdbcType=INTEGER, javaType=Boolean}
            , crgv_tipo = #{crgv.tipo}
            , crgv_descripcion = #{crgv.descripcion}
        WHERE
            crgv_pk = #{crgv.id}
    ]]>
    </update>

    <insert id="deleteVersion" parameterType="CargoVO">
    <![CDATA[
        DELETE FROM tbl_cargo_version_crgv
        WHERE crgv_pk = #{crgv.id}
    ]]>
    </insert>
</mapper>
