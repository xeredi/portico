<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.AspectoDAO">
    <resultMap type="AspectoVO" id="ResultMap">
        <id column="aspv_pk" />
        <id column="aspc_pk" />

        <result column="aspc_pk" property="id" />
        <result column="aspc_codigo" property="codigo" />

        <association property="tpsr" resultMap="xeredi.integra.model.metamodelo.dao.TipoServicioDAO.ResultMap" />

        <association property="aspv" javaType="AspectoVersionVO">
            <result column="aspv_pk" property="id" />
            <result column="aspv_fini" property="fini" />
            <result column="aspv_ffin" property="ffin" />
            <result column="aspv_descripcion" property="descripcion" />
            <result column="aspv_prioridad" property="prioridad" />

            <result column="aspv_cpath_info1" property="cpathInfo1" />
            <result column="aspv_cpath_info2" property="cpathInfo2" />
            <result column="aspv_cpath_info3" property="cpathInfo3" />
            <result column="aspv_cpath_info4" property="cpathInfo4" />
            <result column="aspv_cpath_info5" property="cpathInfo5" />
            <result column="aspv_cpath_info6" property="cpathInfo6" />

            <result column="aspv_cetiq_info1" property="cetiqInfo1" />
            <result column="aspv_cetiq_info2" property="cetiqInfo2" />
            <result column="aspv_cetiq_info3" property="cetiqInfo3" />
            <result column="aspv_cetiq_info4" property="cetiqInfo4" />
            <result column="aspv_cetiq_info5" property="cetiqInfo5" />
            <result column="aspv_cetiq_info6" property="cetiqInfo6" />

            <result column="aspv_cgrp_info1" property="cgrpInfo1" />
            <result column="aspv_cgrp_info2" property="cgrpInfo2" />
            <result column="aspv_cgrp_info3" property="cgrpInfo3" />
            <result column="aspv_cgrp_info4" property="cgrpInfo4" />
            <result column="aspv_cgrp_info5" property="cgrpInfo5" />
            <result column="aspv_cgrp_info6" property="cgrpInfo6" />

            <result column="aspv_lsum_cuant1" property="lsumCuant1" />
            <result column="aspv_lsum_cuant2" property="lsumCuant2" />
            <result column="aspv_lsum_cuant3" property="lsumCuant3" />
            <result column="aspv_lsum_cuant4" property="lsumCuant4" />
            <result column="aspv_lsum_cuant5" property="lsumCuant5" />
            <result column="aspv_lsum_cuant6" property="lsumCuant6" />

            <result column="aspv_lgrp_info1" property="lgrpInfo1" />
            <result column="aspv_lgrp_info2" property="lgrpInfo2" />
            <result column="aspv_lgrp_info3" property="lgrpInfo3" />
            <result column="aspv_lgrp_info4" property="lgrpInfo4" />
            <result column="aspv_lgrp_info5" property="lgrpInfo5" />
            <result column="aspv_lgrp_info6" property="lgrpInfo6" />
        </association>
    </resultMap>

    <sql id="SelectPrefix">
        SELECT aspc.*
        <if test="idioma != null">
        <![CDATA[
            , (
                SELECT i18n_text FROM tbl_i18n_i18n
                WHERE i18n_pref = 'aspv'
                    AND i18n_ext_pk = aspv_pk
                    AND i18n_lang = #{idioma}
            ) AS aspv_descripcion
        ]]>
        </if>
        FROM vw_aspecto_aspc aspc
    </sql>

    <sql id="SelectWhere">
        <where>
            <if test="fechaVigencia != null">
            <![CDATA[
                AND #{fechaVigencia} BETWEEN aspv_fini AND COALESCE(aspv_ffin, #{fechaVigencia})
            ]]>
            </if>

            <if test="id != null">
                AND aspc_pk = #{id}
            </if>

            <if test="aspvId != null">
                AND aspv_pk = #{aspvId}
            </if>

            <if test="tpsrId != null">
                AND aspc_tpsr_pk = #{tpsrId}
            </if>

            <if test="codigo != null">
                AND aspc_codigo LIKE #{codigo}
            </if>

            <if test="srvcId != null">
            <![CDATA[
                AND EXISTS (
            		SELECT 1
            		FROM tbl_servicio_srvc
            		WHERE srvc_tpsr_pk = aspc_tpsr_pk
            			AND srvc_pk = #{srvcId}
            	)
            ]]>
            </if>
        </where>
    </sql>

    <select id="selectList" parameterType="AspectoCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
        ORDER BY aspc_tpsr_pk, aspv_prioridad
    </select>

    <select id="selectObject" parameterType="AspectoCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="count" parameterType="AspectoCriterioVO" resultType="Integer">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_aspecto_aspc
    ]]>
        <include refid="SelectWhere" />
    </select>

    <select id="isInaplicable" parameterType="FacturadorContextoVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM tbl_valoracion_cargo_vlrg
        WHERE
        	NOT EXISTS (
        		SELECT 1
        		FROM tbl_aspecto_cargo_ascr
        		WHERE
        			ascr_crgo_pk = vlrg_crgo_pk
        			AND EXISTS (
        				SELECT 1
        				FROM tbl_aspecto_version_aspv
        				WHERE
        					aspv_aspc_pk = ascr_aspc_pk
        					AND #{fechaFacturacion} BETWEEN aspv_fini AND COALESCE(aspv_ffin, #{fechaFacturacion})
        					AND aspv_aspc_pk = #{aspc.id}
        			)
        	)
            AND vlrg_vlrc_pk IN
    ]]>
        <foreach collection="vlrcIds" item="item" open="(" close=")" separator=",">#{item}
        </foreach>
    </select>

    <select id="exists" parameterType="AspectoVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM tbl_aspecto_aspc
        WHERE aspc_codigo = #{codigo} AND aspc_tpsr_pk = #{tpsr.id}
    ]]>
    </select>

    <select id="existsOverlap" parameterType="CargoVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_aspecto_aspc
        WHERE
            aspc_pk = #{id}
            AND (
                #{aspv.fini} BETWEEN aspv_fini AND COALESCE(aspv_ffin, #{aspv.fini})
                OR COALESCE(#{aspv.ffin, jdbcType=TIMESTAMP, javaType=java.util.Date}, portico.getSysdateTime())
                    BETWEEN aspv_fini AND COALESCE(aspv_ffin, COALESCE(#{aspv.ffin, jdbcType=TIMESTAMP, javaType=java.util.Date}, portico.getSysdateTime()))
            )
    ]]>
        <if test="aspv.id != null">
        <![CDATA[
            AND aspv_pk <> #{aspv.id}
        ]]>
        </if>
    </select>

    <select id="selectId" parameterType="AspectoVO" resultType="Long">
    <![CDATA[
        SELECT aspc_pk
        FROM tbl_aspecto_aspc
        WHERE aspc_codigo = #{codigo}
    ]]>
    </select>

    <insert id="insert" parameterType="AspectoVO">
    <![CDATA[
        INSERT INTO tbl_aspecto_aspc (aspc_pk, aspc_codigo, aspc_tpsr_pk)
        VALUES (#{id}, #{codigo}, #{tpsr.id})
    ]]>
    </insert>

    <insert id="insertVersion" parameterType="AspectoVO">
    <![CDATA[
        INSERT INTO tbl_aspecto_version_aspv (
            aspv_pk, aspv_aspc_pk, aspv_fini, aspv_ffin, aspv_prioridad
            , aspv_cpath_info1, aspv_cpath_info2, aspv_cpath_info3, aspv_cpath_info4, aspv_cpath_info5, aspv_cpath_info6
            , aspv_cetiq_info1, aspv_cetiq_info2, aspv_cetiq_info3, aspv_cetiq_info4, aspv_cetiq_info5, aspv_cetiq_info6
            , aspv_cgrp_info1, aspv_cgrp_info2, aspv_cgrp_info3, aspv_cgrp_info4, aspv_cgrp_info5, aspv_cgrp_info6
            , aspv_lsum_cuant1, aspv_lsum_cuant2, aspv_lsum_cuant3, aspv_lsum_cuant4, aspv_lsum_cuant5, aspv_lsum_cuant6
            , aspv_lgrp_info1, aspv_lgrp_info2, aspv_lgrp_info3, aspv_lgrp_info4, aspv_lgrp_info5, aspv_lgrp_info6
        ) VALUES (
            #{aspv.id}, #{id}, #{aspv.fini}, #{aspv.ffin}, #{aspv.prioridad}
            , #{aspv.cpathInfo1}, #{aspv.cpathInfo2}, #{aspv.cpathInfo3}, #{aspv.cpathInfo4}, #{aspv.cpathInfo5}, #{aspv.cpathInfo6}
            , #{aspv.cetiqInfo1}, #{aspv.cetiqInfo2}, #{aspv.cetiqInfo3}, #{aspv.cetiqInfo4}, #{aspv.cetiqInfo5}, #{aspv.cetiqInfo6}
            , #{aspv.cgrpInfo1, jdbcType=INTEGER, javaType=Boolean}, #{aspv.cgrpInfo2, jdbcType=INTEGER, javaType=Boolean}, #{aspv.cgrpInfo3, jdbcType=INTEGER, javaType=Boolean}
            , #{aspv.cgrpInfo4, jdbcType=INTEGER, javaType=Boolean}, #{aspv.cgrpInfo5, jdbcType=INTEGER, javaType=Boolean}, #{aspv.cgrpInfo6, jdbcType=INTEGER, javaType=Boolean}
            , #{aspv.lsumCuant1, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lsumCuant2, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lsumCuant3, jdbcType=INTEGER, javaType=Boolean}
            , #{aspv.lsumCuant4, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lsumCuant5, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lsumCuant6, jdbcType=INTEGER, javaType=Boolean}
            , #{aspv.lgrpInfo1, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lgrpInfo2, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lgrpInfo3, jdbcType=INTEGER, javaType=Boolean}
            , #{aspv.lgrpInfo4, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lgrpInfo5, jdbcType=INTEGER, javaType=Boolean}, #{aspv.lgrpInfo6, jdbcType=INTEGER, javaType=Boolean}
        )
    ]]>
    </insert>

    <update id="updateVersion" parameterType="AspectoVO">
    <![CDATA[
        UPDATE tbl_aspecto_version_aspv SET
            aspv_fini = #{aspv.fini}, aspv_ffin = #{aspv.ffin}, aspv_prioridad = #{aspv.prioridad}
            , aspv_cpath_info1 = #{aspv.cpathInfo1}, aspv_cpath_info2 = #{aspv.cpathInfo2}, aspv_cpath_info3 = #{aspv.cpathInfo3}
            , aspv_cpath_info4 = #{aspv.cpathInfo4}, aspv_cpath_info5 = #{aspv.cpathInfo5}, aspv_cpath_info6 = #{aspv.cpathInfo6}
            , aspv_cetiq_info1 = #{aspv.cetiqInfo1}, aspv_cetiq_info2 = #{aspv.cetiqInfo2}, aspv_cetiq_info3 = #{aspv.cetiqInfo3}
            , aspv_cetiq_info4 = #{aspv.cetiqInfo4}, aspv_cetiq_info5 = #{aspv.cetiqInfo5}, aspv_cetiq_info6 = #{aspv.cetiqInfo6}
            , aspv_cgrp_info1 = #{aspv.cgrpInfo1, jdbcType=INTEGER, javaType=Boolean}, aspv_cgrp_info2 = #{aspv.cgrpInfo2, jdbcType=INTEGER, javaType=Boolean}
            , aspv_cgrp_info3 = #{aspv.cgrpInfo3, jdbcType=INTEGER, javaType=Boolean}, aspv_cgrp_info4 = #{aspv.cgrpInfo4, jdbcType=INTEGER, javaType=Boolean}
            , aspv_cgrp_info5 = #{aspv.cgrpInfo5, jdbcType=INTEGER, javaType=Boolean}, aspv_cgrp_info6 = #{aspv.cgrpInfo6, jdbcType=INTEGER, javaType=Boolean}
            , aspv_lsum_cuant1 = #{aspv.lsumCuant1, jdbcType=INTEGER, javaType=Boolean}, aspv_lsum_cuant2 = #{aspv.lsumCuant2, jdbcType=INTEGER, javaType=Boolean}
            , aspv_lsum_cuant3 = #{aspv.lsumCuant3, jdbcType=INTEGER, javaType=Boolean}, aspv_lsum_cuant4 = #{aspv.lsumCuant4, jdbcType=INTEGER, javaType=Boolean}
            , aspv_lsum_cuant5 = #{aspv.lsumCuant5, jdbcType=INTEGER, javaType=Boolean}, aspv_lsum_cuant6 = #{aspv.lsumCuant6, jdbcType=INTEGER, javaType=Boolean}
            , aspv_lgrp_info1 = #{aspv.lgrpInfo1, jdbcType=INTEGER, javaType=Boolean}, aspv_lgrp_info2 = #{aspv.lgrpInfo2, jdbcType=INTEGER, javaType=Boolean}
            , aspv_lgrp_info3 = #{aspv.lgrpInfo3, jdbcType=INTEGER, javaType=Boolean}, aspv_lgrp_info4 = #{aspv.lgrpInfo4, jdbcType=INTEGER, javaType=Boolean}
            , aspv_lgrp_info5 = #{aspv.lgrpInfo5, jdbcType=INTEGER, javaType=Boolean}, aspv_lgrp_info6 = #{aspv.lgrpInfo6, jdbcType=INTEGER, javaType=Boolean}
        WHERE aspv_pk = #{aspv.id}
    ]]>
    </update>
</mapper>
