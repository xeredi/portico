<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.ValoracionLineaDAO">
    <resultMap type="ValoracionLineaVO" id="ResultMap">
        <id column="vlrl_pk" />
        <id column="vlrl_padre_pk" />
        <id column="vlrl_vlrc_pk" />
        <id column="vlrl_fini" />
        <id column="vlrl_ffin" />

        <result column="vlrl_pk" property="id" />
        <result column="vlrl_padre_pk" property="padreId" />
        <result column="vlrl_vlrc_pk" property="vlrcId" />
        <result column="vlrl_fref" property="fref" />
        <result column="vlrl_fini" property="fini" />
        <result column="vlrl_ffin" property="ffin" />

        <result column="vlrl_importe_base" property="importeBase" />
        <result column="vlrl_importe" property="importe" />

        <result column="vlrl_info1" property="info1" />
        <result column="vlrl_info2" property="info2" />
        <result column="vlrl_info3" property="info3" />
        <result column="vlrl_info4" property="info4" />
        <result column="vlrl_info5" property="info5" />
        <result column="vlrl_info6" property="info6" />

        <result column="vlrl_cuant1" property="cuant1" />
        <result column="vlrl_cuant2" property="cuant2" />
        <result column="vlrl_cuant3" property="cuant3" />
        <result column="vlrl_cuant4" property="cuant4" />
        <result column="vlrl_cuant5" property="cuant5" />
        <result column="vlrl_cuant6" property="cuant6" />

        <association property="ssrv" resultMap="xeredi.integra.model.servicio.dao.SubservicioDAO.ResultMap" />
        <association property="rgla" resultMap="xeredi.integra.model.facturacion.dao.ReglaDAO.ResultMap" />
        <association property="impuesto" resultMap="xeredi.integra.model.maestro.dao.ParametroDAO.ResultMap" />
    </resultMap>

    <insert id="insert" parameterType="ValoracionLineaVO">
    <![CDATA[
        INSERT INTO tbl_valoracion_lin_vlrl (
            vlrl_pk, vlrl_padre_pk, vlrl_vlrc_pk, vlrl_rgla_pk
            , vlrl_impuesto_prmt_pk, vlrl_ssrv_pk, vlrl_fini, vlrl_ffin
            , vlrl_cuant1, vlrl_cuant2, vlrl_cuant3, vlrl_cuant4, vlrl_cuant5, vlrl_cuant6
            , vlrl_info1, vlrl_info2, vlrl_info3, vlrl_info4, vlrl_info5, vlrl_info6
        )
        VALUES (
            #{id}, #{padreId}, #{vlrcId}, #{rgla.id}
            , #{impuesto.id}, #{ssrv.id}, #{fini}, #{ffin}
            , #{cuant1}, #{cuant2}, #{cuant3}, #{cuant4}, #{cuant5}, #{cuant6}
            , #{info1}, #{info2}, #{info3}, #{info4}, #{info5}, #{info6}
        )
    ]]>
    </insert>

    <delete id="delete" parameterType="ValoracionLineaCriterioVO">
    <![CDATA[
        DELETE FROM tbl_valoracion_lin_vlrl
    ]]>
        <include refid="SelectWhere" />
    </delete>

    <sql id="SelectPrefix">
    <![CDATA[
        SELECT *
        FROM vw_valoracion_lin_vlrl
    ]]>
    </sql>

    <sql id="SelectWhere">
        <where>
            <if test="id != null">
                AND vlrl_pk = #{id}
            </if>
            <if test="vlrc != null">
                <if test="vlrc.id != null">
                    AND vlrl_vlrc_pk = #{vlrc.id}
                </if>
                <if test="vlrc.ids != null">
                    AND vlrl_vlrc_pk IN
                    <foreach collection="vlrc.ids" item="item" open="(" close=")" separator=",">#{item}
                    </foreach>
                </if>
            </if>
        </where>
    </sql>

    <select id="select" parameterType="Long" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        WHERE vlrl_pk = #{value}
    </select>

    <select id="selectList" parameterType="ValoracionLineaCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
        ORDER BY vlrl_vlrc_pk, vlrl_padre_pk, vlrl_pk
    </select>

    <select id="count" parameterType="ValoracionLineaCriterioVO" resultType="Integer">
        SELECT COUNT(1)
        FROM vw_valoracion_lin_vlrl
        <include refid="SelectWhere" />
    </select>

    <select id="existsDependencia" parameterType="Long" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_valoracion_lin_vlrl
        WHERE vlrl_padre_pk = #{value}
            AND vlrl_pk <> #{value}
    ]]>
    </select>

    <select id="isRglaValida" parameterType="ValoracionLineaVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM tbl_regla_rgla
        WHERE
            EXISTS (
                SELECT 1
                FROM
                    tbl_regla_version_rglv
                WHERE
                    rglv_rgla_pk = rgla_pk
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_valoracion_vlrc
                        WHERE
                            vlrc_fref BETWEEN rglv_fini AND COALESCE(rglv_ffin, vlrc_fref)
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_aspecto_version_aspv
                                WHERE
                                    aspv_aspc_pk = vlrc_aspc_pk
                                    AND vlrc_fref BETWEEN aspv_fini AND COALESCE(aspv_ffin, vlrc_fref)
                                    AND EXISTS (
                                        SELECT 1
                                        FROM tbl_aspecto_cargo_ascr
                                        WHERE
                                            ascr_aspc_pk = aspv_aspc_pk
                                            AND ascr_crgo_pk = rgla_crgo_pk
                                    )
                            )
                            AND vlrc_pk = #{vlrcId}

                    )
            )
            AND rgla_pk = #{rgla.id}
    ]]>
    </select>
</mapper>
