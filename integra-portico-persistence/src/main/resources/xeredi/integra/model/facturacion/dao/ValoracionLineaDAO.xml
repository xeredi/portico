<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.ValoracionLineaDAO">
	<resultMap type="ValoracionLineaVO" id="ResultMap">
		<id column="vlrl_pk" />
		<id column="vlrl_padre_pk" />
		<id column="vlrl_vlrc_pk" />
		<id column="vlrl_fini" />
		<id column="vlrl_ffin" />

		<result column="vlrl_pk" property="id" />
		<result column="vlrl_padre_pk" property="padreId" />
		<result column="vlrl_vlrc_pk" property="vlrcId" />
		<result column="vlrl_fref" property="fref" />
		<result column="vlrl_fini" property="fini" />
		<result column="vlrl_ffin" property="ffin" />

		<result column="vlrl_importe_base" property="importeBase" />
		<result column="vlrl_importe" property="importe" />

		<result column="vlrl_info1" property="info1" />
		<result column="vlrl_info2" property="info2" />
		<result column="vlrl_info3" property="info3" />
		<result column="vlrl_info4" property="info4" />
		<result column="vlrl_info5" property="info5" />
		<result column="vlrl_info6" property="info6" />

		<result column="vlrl_cuant1" property="cuant1" />
		<result column="vlrl_cuant2" property="cuant2" />
		<result column="vlrl_cuant3" property="cuant3" />
		<result column="vlrl_cuant4" property="cuant4" />
		<result column="vlrl_cuant5" property="cuant5" />
		<result column="vlrl_cuant6" property="cuant6" />

		<association property="ssrv" javaType="SubservicioVO">
			<result column="ssrv_pk" property="id" />
		</association>

		<association property="rgla" javaType="ReglaVO">
			<result column="rgla_pk" property="id" />
			<result column="rgla_codigo" property="codigo" />

			<association property="rglv" javaType="ReglaVersionVO">
				<result column="rglv_tipo" property="tipo" />

				<result column="rglv_etiq_info1" property="etiqInfo1" />
				<result column="rglv_etiq_info2" property="etiqInfo2" />
				<result column="rglv_etiq_info3" property="etiqInfo3" />
				<result column="rglv_etiq_info4" property="etiqInfo4" />
				<result column="rglv_etiq_info5" property="etiqInfo5" />
				<result column="rglv_etiq_info6" property="etiqInfo6" />

				<result column="rglv_etiq_cuant1" property="etiqCuant1" />
				<result column="rglv_etiq_cuant2" property="etiqCuant2" />
				<result column="rglv_etiq_cuant3" property="etiqCuant3" />
				<result column="rglv_etiq_cuant4" property="etiqCuant4" />
				<result column="rglv_etiq_cuant5" property="etiqCuant5" />
				<result column="rglv_etiq_cuant6" property="etiqCuant6" />

				<association property="enti" javaType="EntidadVO">
					<result column="rglv_enti_pk" property="id" />
					<result column="enti_tipo" property="tipo" />
				</association>
			</association>
		</association>

		<association property="impuesto" javaType="ParametroVO">
			<result column="prmt_pk" property="id" />
			<result column="prmt_parametro" property="parametro" />
			<result column="prmt_tppr_pk" property="entiId" />
			<result column="p18n_texto" property="texto" />
		</association>
	</resultMap>

	<sql id="SelectPrefix">
    <![CDATA[
        SELECT
			vlrl_pk, vlrl_padre_pk, vlrl_vlrc_pk, vlrl_fref, vlrl_fini, vlrl_ffin, vlrl_importe_base, vlrl_importe
			, vlrl_info1, vlrl_info2, vlrl_info3, vlrl_info4, vlrl_info5, vlrl_info6
			, vlrl_cuant1, vlrl_cuant2, vlrl_cuant3, vlrl_cuant4, vlrl_cuant5, vlrl_cuant6

			, ssrv_pk

			, rgla_pk, rgla_codigo
			, rglv_tipo, rglv_enti_pk, enti_tipo
			, rglv_etiq_info1, rglv_etiq_info2, rglv_etiq_info3, rglv_etiq_info4, rglv_etiq_info5, rglv_etiq_info6
			, rglv_etiq_cuant1, rglv_etiq_cuant2, rglv_etiq_cuant3, rglv_etiq_cuant4, rglv_etiq_cuant5, rglv_etiq_cuant6

			, prmt_pk, prmt_parametro, prmt_tppr_pk
        FROM vw_valoracion_lin_vlrl
    ]]>
	</sql>

	<sql id="SelectWhere">
		<where>
			<if test="id != null">
				AND vlrl_pk = #{id}
			</if>
			<if test="vlrc != null">
				<if test="vlrc.id != null">
					AND vlrl_vlrc_pk = #{vlrc.id}
				</if>
				<if test="vlrc.ids != null">
					AND vlrl_vlrc_pk IN
					<foreach collection="vlrc.ids" item="item" open="(" close=")" separator=",">#{item}
					</foreach>
				</if>
			</if>
		</where>
	</sql>

	<select id="select" parameterType="Long" resultMap="ResultMap">
		<include refid="SelectPrefix" />
		WHERE vlrl_pk = #{value}
	</select>

	<select id="selectList" parameterType="ValoracionLineaCriterioVO" resultMap="ResultMap">
		<include refid="SelectPrefix" />
		<include refid="SelectWhere" />
		ORDER BY vlrl_vlrc_pk, vlrl_padre_pk, vlrl_pk
	</select>

	<select id="selectPaginatedList" parameterType="ValoracionLineaCriterioVO" resultMap="ResultMap">
		<include refid="SelectPrefix" />
		<include refid="SelectWhere" />
		ORDER BY vlrl_vlrc_pk, vlrl_padre_pk, vlrl_pk
	</select>

	<select id="count" parameterType="ValoracionLineaCriterioVO" resultType="Integer">
		SELECT COUNT(1)
		FROM vw_valoracion_lin_vlrl
		<include refid="SelectWhere" />
	</select>

	<select id="existsDependencia" parameterType="Long" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM vw_valoracion_lin_vlrl
        WHERE vlrl_padre_pk = #{value}
            AND vlrl_pk <> #{value}
    ]]>
	</select>

	<select id="isRglaValida" parameterType="ValoracionLineaVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM tbl_regla_rgla
        WHERE
            EXISTS (
                SELECT 1
                FROM
                    tbl_regla_version_rglv
                WHERE
                    rglv_rgla_pk = rgla_pk
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_valoracion_vlrc
                        WHERE
                            vlrc_fref BETWEEN rglv_fini AND COALESCE(rglv_ffin, vlrc_fref)
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_aspecto_version_aspv
                                WHERE
                                    aspv_aspc_pk = vlrc_aspc_pk
                                    AND vlrc_fref BETWEEN aspv_fini AND COALESCE(aspv_ffin, vlrc_fref)
                                    AND EXISTS (
                                        SELECT 1
                                        FROM tbl_aspecto_cargo_ascr
                                        WHERE
                                            ascr_aspc_pk = aspv_aspc_pk
                                            AND ascr_crgo_pk = rgla_crgo_pk
                                    )
                            )
                            AND vlrc_pk = #{vlrcId}

                    )
            )
            AND rgla_pk = #{rgla.id}
    ]]>
	</select>

	<insert id="insert" parameterType="ValoracionLineaVO">
    <![CDATA[
        INSERT INTO tbl_valoracion_lin_vlrl (
            vlrl_pk, vlrl_padre_pk, vlrl_vlrc_pk, vlrl_rgla_pk
            , vlrl_impuesto_prmt_pk, vlrl_ssrv_pk, vlrl_fini, vlrl_ffin
            , vlrl_cuant1, vlrl_cuant2, vlrl_cuant3, vlrl_cuant4, vlrl_cuant5, vlrl_cuant6
            , vlrl_info1, vlrl_info2, vlrl_info3, vlrl_info4, vlrl_info5, vlrl_info6
        )
        VALUES (
            #{id}, #{padreId}, #{vlrcId}, #{rgla.id}
            , #{impuesto.id}, #{ssrv.id}, #{fini}, #{ffin}
            , #{cuant1}, #{cuant2}, #{cuant3}, #{cuant4}, #{cuant5}, #{cuant6}
            , #{info1}, #{info2}, #{info3}, #{info4}, #{info5}, #{info6}
        )
    ]]>
	</insert>

	<delete id="delete" parameterType="ValoracionLineaCriterioVO">
		DELETE FROM tbl_valoracion_lin_vlrl
		<include refid="SelectWhere" />
	</delete>
</mapper>
