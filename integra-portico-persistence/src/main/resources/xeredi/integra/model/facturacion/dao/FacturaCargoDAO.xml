<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.facturacion.dao.FacturaCargoDAO">
	<resultMap type="FacturaCargoVO" id="ResultMap">
		<id column="fctg_fctr_pk" />
		<id column="fctg_crgo_pk" />

		<result column="fctg_fctr_pk" property="fctrId" />
		<result column="fctg_importe" property="importe" />

		<association property="crgo" javaType="CargoVO">
			<result column="fctg_crgo_pk" property="id" />
			<result column="fctg_crgo_codigo" property="codigo" />
		</association>
	</resultMap>

	<select id="selectList" resultMap="ResultMap" parameterType="FacturaCriterioVO">
    <![CDATA[
		SELECT
		    fctl_fctr_pk AS fctg_fctr_pk
		    , rgla_crgo_pk AS fctg_crgo_pk
		    , (SELECT crgo_codigo FROM tbl_cargo_crgo WHERE crgo_pk = rgla_crgo_pk) AS fctg_crgo_codigo
		    , SUM(fctl_importe) AS fctg_importe
		FROM (
		    SELECT
		        fctl_pk, fctl_fctr_pk

		        , (
		            SELECT rgla_crgo_pk
		            FROM tbl_regla_rgla
		            WHERE
		                rgla_pk = fctl_rgla_pk
		        ) AS rgla_crgo_pk

		        , (
		            SELECT SUM(fctd_importe)
		            FROM
		                tbl_factura_det_fctd
		            WHERE
		                fctd_fctl_pk = fctl_pk
		        ) AS fctl_importe
		    FROM
		        tbl_factura_lin_fctl
    ]]>
    	<where>
    		<if test="id != null">
		    <![CDATA[
    			AND fctl_fctr_pk = #{id}
    		]]>
    		</if>
    	</where>
    <![CDATA[
		) sql
		GROUP BY fctl_fctr_pk, rgla_crgo_pk
		ORDER BY fctl_fctr_pk, fctg_crgo_codigo
    ]]>
	</select>
</mapper>
