<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.estadistica.dao.EstadisticaDAO">
    <resultMap type="EstadisticaVO" id="ResultMap">
        <id column="estd_pk" property="id" />
        <result column="estd_tpes_pk" property="entiId" />
        <result column="pepr_freferencia" property="fref" />

        <association property="subp" javaType="ParametroVO">
            <result column="prmt_pk" property="id" />
            <result column="prmt_parametro" property="parametro" />

            <association property="i18n" javaType="ParametroI18nVO">
                <result column="p18n_texto" property="texto" />
            </association>
        </association>

        <association property="pepr" javaType="PeriodoProcesoVO">
            <result column="estd_pepr_pk" property="id" />
            <result column="pepr_anio" property="anio" />
            <result column="pepr_mes" property="mes" />
            <result column="pepr_freferencia" property="freferencia" />

            <association property="autp" javaType="ParametroVO">
                <result column="pepr_autp_pk" property="id" />
                <result column="pepr_autp" property="parametro" />
            </association>
        </association>
    </resultMap>

    <sql id="SelectPrefix">
        <![CDATA[
        SELECT *
            , (SELECT prmt_parametro FROM tbl_parametro_prmt
                WHERE prmt_pk = pepr_autp_pk) AS pepr_autp
        ]]>
        <if test="idioma != null">
        <![CDATA[
        	, (
        		SELECT p18n_texto
        		FROM tbl_parametro_i18n_p18n
        		WHERE
        			p18n_prvr_pk = ANY (
        				SELECT prvr_pk
        				FROM tbl_parametro_version_prvr
        				WHERE
        					prvr_prmt_pk = estd_subp_pk
        					AND pepr_freferencia BETWEEN prvr_fini AND COALESCE(prvr_ffin, pepr_freferencia)
        			)
        			AND p18n_idioma = #{idioma}
            ) AS p18n_texto
        ]]>
        </if>
        <include refid="SelectPrefixSpecific" />
        FROM vw_estadistica_estd
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="postgres">
        , NULL AS rownumVar
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="sqlserver">
        , NULL AS rownumVar
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="oracle">
        , ROWNUM AS rownumVar
    </sql>

    <sql id="SelectCountPrefix">
    <![CDATA[
    SELECT
        COUNT(1)
    FROM
        vw_estadistica_estd
    ]]>
    </sql>

    <sql id="SelectWhere">
        <if test="id != null">
            AND estd_pk = #{id}
        </if>
        <if test="entiId != null">
            AND estd_tpes_pk = #{entiId}
        </if>
        <if test="pepr != null">
            <if test="pepr.id != null">
                AND estd_pepr_pk = #{pepr.id}
            </if>
            <if test="pepr.autpId != null">
                AND pepr_autp_pk = #{pepr.autpId}
            </if>
        </if>
        <if test="subpId != null">
            AND estd_subp_pk = #{subpId}
        </if>
        <if test="itdtMap != null and !itdtMap.empty">
            <foreach collection="itdtMap" index="key" item="itdt">
                <!-- FIXME ojo, faltan las fechas -->
                <if
                    test="(itdt.prmt != null and itdt.prmt.id != null) or itdt.cantidadDecimal != null or itdt.cantidadEntera != null or (itdt.cadena != null and !itdt.cadena.empty) ">
                    <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            esdt_estd_pk = estd_pk
                            AND esdt_tpdt_pk = #{itdt.tpdtId}
                    ]]>
                    <if test="itdt.prmt != null and itdt.prmt.id != null">
                        AND esdt_prmt_pk = #{itdt.prmt.id}
                    </if>
                    <if test="itdt.cantidadEntera != null">
                        AND esdt_nentero = #{itdt.cantidadEntera}
                    </if>
                    <if test="itdt.cantidadDecimal != null">
                        AND esdt_ndecimal = #{itdt.cantidadDecimal}
                    </if>
                    <if test="itdt.cadena != null and !itdt.cadena.empty">
                        AND esdt_cadena LIKE #{itdt.cadena}
                    </if>
                    )
                </if>
            </foreach>
        </if>
    </sql>

    <select id="selectCount" parameterType="EstadisticaCriterioVO" resultType="Integer">
        <include refid="SelectCountPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="selectList" parameterType="EstadisticaCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="selectPaginatedList" parameterType="EstadisticaCriterioVO" resultMap="ResultMap" databaseId="postgres">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        OFFSET ${offset} ROWS FETCH NEXT ${limit} ROWS ONLY
    </select>

    <select id="selectPaginatedList" parameterType="EstadisticaCriterioVO" resultMap="ResultMap" databaseId="sqlserver">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        OFFSET ${offset} ROWS FETCH NEXT ${limit} ROWS ONLY
    </select>

    <select id="selectPaginatedList" parameterType="EstadisticaCriterioVO" resultMap="ResultMap" databaseId="oracle">
        SELECT * FROM (
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        <![CDATA[
        ) WHERE rownumVar >= ${offset} AND rownumVar < (${offset} + ${limit})
        ]]>
    </select>

    <select id="selectObject" parameterType="EstadisticaCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <insert id="insert" parameterType="EstadisticaVO">
        <![CDATA[
        INSERT INTO tbl_estadistica_estd (estd_pk, estd_tpes_pk, estd_pepr_pk, estd_subp_pk)
        VALUES (#{id}, #{entiId}, #{pepr.id}, #{subp.id})
        ]]>
    </insert>

    <delete id="delete" parameterType="Long">
        <![CDATA[
        DELETE FROM tbl_estadistica_estd
        WHERE estd_pepr_pk = #{value}
        ]]>
    </delete>
</mapper>
