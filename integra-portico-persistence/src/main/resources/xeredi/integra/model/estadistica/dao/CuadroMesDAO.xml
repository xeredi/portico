<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.estadistica.dao.CuadroMesDAO">
    <resultMap type="CuadroMesVO" id="ResultMap">
        <id column="cdms_pk" property="id" />
        <result column="cdms_pepr_pk" property="peprId" />
        <result column="cdms_cantidad" property="cantidad" />

        <association property="cocu" javaType="ParametroVO">
            <result column="cdms_cocu_pk" property="id" />
            <result column="cdms_cocu" property="parametro" />
        </association>
        <association property="opet" javaType="ParametroVO">
            <result column="cdms_opet_pk" property="id" />
            <result column="cdms_opet" property="parametro" />
        </association>
        <association property="navt" javaType="ParametroVO">
            <result column="cdms_navt_pk" property="id" />
            <result column="cdms_navt" property="parametro" />
        </association>
        <association property="pais" javaType="ParametroVO">
            <result column="cdms_pais_pk" property="id" />
            <result column="cdms_pais" property="parametro" />
        </association>
    </resultMap>

    <sql id="SelectPrefix">
    <![CDATA[
    SELECT
        cdms.cdms_pk
        , cdms.cdms_pepr_pk
        , cdms.cdms_cantidad
        , cdms.cdms_cocu_pk
        , (SELECT prmt_parametro FROM tbl_parametro_prmt
            WHERE prmt_pk = cdms.cdms_cocu_pk) AS cdms_cocu
        , cdms.cdms_opet_pk
        , (SELECT prmt_parametro FROM tbl_parametro_prmt
            WHERE prmt_pk = cdms.cdms_opet_pk) AS cdms_opet
        , cdms.cdms_navt_pk
        , (SELECT prmt_parametro FROM tbl_parametro_prmt
            WHERE prmt_pk = cdms.cdms_navt_pk) AS cdms_navt
        , cdms.cdms_pais_pk
        , (SELECT prmt_parametro FROM tbl_parametro_prmt
            WHERE prmt_pk = cdms.cdms_pais_pk) AS cdms_pais
    FROM tbl_cuadro_mes_cdms cdms
    ]]>
    </sql>

    <select id="exists" parameterType="Long" resultType="boolean">
    <![CDATA[
        SELECT COUNT(1)
        WHERE EXISTS (
            SELECT 1
            FROM tbl_cuadro_mes_cdms
            WHERE cdms_pepr_pk = #{value}
        )
    ]]>
    </select>

    <select id="selectList" parameterType="Long" resultMap="ResultMap">
        <include refid="SelectPrefix"/>
        <![CDATA[
        WHERE cdms_pepr_pk = #{value}
        ORDER BY cdms_pk
        ]]>
    </select>

    <delete id="delete" parameterType="Long">
    <![CDATA[
        DELETE FROM tbl_cuadro_mes_cdms
        WHERE cdms_pepr_pk = #{value}
    ]]>
    </delete>

    <sql id="InsertPrefix">
    <![CDATA[
        INSERT INTO tbl_cuadro_mes_cdms(
            cdms_pk, cdms_pepr_pk, cdms_cocu_pk, cdms_opet_pk, cdms_navt_pk, cdms_pais_pk, cdms_cantidad
        )
        VALUES (
            #{cdmsId}
            , #{peprId}
            , (SELECT prmt_pk FROM tbl_parametro_prmt WHERE prmt_tppr_pk = portico.getEntidad('CONCEPTO_CUADRO_EST') AND prmt_parametro = #{cocu})
            , (SELECT prmt_pk FROM tbl_parametro_prmt WHERE prmt_tppr_pk = portico.getEntidad('TIPO_OPERACION_BL') AND prmt_parametro = #{opet})
            , (SELECT prmt_pk FROM tbl_parametro_prmt WHERE prmt_tppr_pk = portico.getEntidad('TIPO_NAVEGACION') AND prmt_parametro = #{navt})
            , (SELECT prmt_pk FROM tbl_parametro_prmt WHERE prmt_tppr_pk = portico.getEntidad('PAIS') AND prmt_parametro = #{pais})
            , (
    ]]>
    </sql>

    <sql id="InsertSuffix">
    <![CDATA[
            )
        )
    ]]>
    </sql>
    <!-- PESCA -->
    <insert id="CM_PESCAF" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
            SELECT COALESCE(SUM(esdt_nentero), 0) / 1000 AS value
            FROM tbl_estadistica_dato_esdt
            WHERE
                esdt_tpdt_pk = #{tipoDato.id}
                AND EXISTS (
                    SELECT 1
                    FROM tbl_estadistica_estd
                    WHERE
                        estd_pk = esdt_estd_pk
                        AND estd_pepr_pk = #{peprId}
                        AND estd_tpes_pk = portico.getEntidad('ACTIVIDAD_PESQUERA')
                )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <!-- AVITUALLAMIENTO -->
    <insert id="CM_AVPPET" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_nentero), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('AVITUALLAMIENTO')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_SUM')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE '4%'
                                    )
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_AVOTRO" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_nentero), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('AVITUALLAMIENTO')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_SUM')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE '1%'
                                        OR prmt_parametro LIKE '2%'
                                        OR prmt_parametro LIKE '3%'
                                        OR prmt_parametro LIKE '5%'
                                    )
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <!-- AGREGACION ESCALAS -->
    <insert id="CM_BUQUNI_BUQGT_ES" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_nentero), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('AGREGACION_ESCALA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_BUQUE')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro NOT IN ('BG', 'XX', '**')
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('PAIS')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE 'ES'
                                    )
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_BUQUNI_BUQGT_ZZ" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_nentero), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('AGREGACION_ESCALA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_BUQUE')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro NOT IN ('BG', 'XX', '**')
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('PAIS')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro NOT LIKE 'ES'
                                    )
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_CRUBUQ" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_nentero), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('AGREGACION_ESCALA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_BUQUE')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE 'UC'
                                    )
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_GLPETR_GLGASN_GLPREF_GLOTRO" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_ndecimal), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{campoAdicionalParam}
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_GSIESP_GSNIES" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_ndecimal), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('INST_ESP')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{campoAdicionalParam}
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_version_prvr
                                WHERE
                                    prvr_prmt_pk = esdt_prmt_pk
                                    AND (
                                        (
                                            SELECT pepr_freferencia FROM tbl_periodo_proceso_pepr
                                            WHERE pepr_pk = #{peprId}
                                        )
                                        BETWEEN prvr_fini AND COALESCE(prvr_ffin, portico.getSysDatetime())
                                    )
                                    AND EXISTS (
                                        SELECT 1 FROM tbl_parametro_dato_prdt
                                        WHERE prdt_prvr_pk = prvr_pk
                                            AND prdt_tpdt_pk = portico.getTipoDato('TIPO_MERC_EST')
                                            AND prdt_prmt_pk = (
                                                select prmt_pk
                                                from tbl_parametro_prmt
                                                WHERE prmt_tppr_pk = portico.getEntidad('TIPO_MERCANCIA_EST') and PRMT_PARAMETRO LIKE 'SG'
                                            )
                                    )
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_MG_PASAJE_VET2" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(COALESCE(esdt_ndecimal, esdt_nentero)), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_version_prvr
                                WHERE
                                    prvr_prmt_pk = esdt_prmt_pk
                                    AND (
                                        (
                                            SELECT pepr_freferencia FROM tbl_periodo_proceso_pepr
                                            WHERE pepr_pk = #{peprId}
                                        )
                                        between prvr_fini AND COALESCE(prvr_ffin, portico.getSysDatetime())
                                    )
                                    AND EXISTS (
                                        SELECT 1 FROM tbl_parametro_dato_prdt
                                        WHERE prdt_prvr_pk = prvr_pk
                                            AND prdt_tpdt_pk = portico.getTipoDato('TIPO_MERC_EST')
                                            AND prdt_prmt_pk = (
                                                select prmt_pk
                                                from tbl_parametro_prmt
                                                WHERE prmt_tppr_pk = portico.getEntidad('TIPO_MERCANCIA_EST')
                                                	and PRMT_PARAMETRO LIKE #{campoAdicionalParam}
                                            )
                                    )
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_PASCRU" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_nentero), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_version_prvr
                                WHERE
                                    prvr_prmt_pk = esdt_prmt_pk
                                    AND (
                                        (
                                            SELECT pepr_freferencia FROM tbl_periodo_proceso_pepr
                                            WHERE pepr_pk = #{peprId}
                                        )
                                        BETWEEN prvr_fini AND COALESCE(prvr_ffin, portico.getSysDatetime())
                                    )
                                    AND EXISTS (
                                        SELECT 1 FROM tbl_parametro_dato_prdt
                                        WHERE prdt_prvr_pk = prvr_pk
                                            AND prdt_tpdt_pk = portico.getTipoDato('TIPO_MERC_EST')
                                            AND prdt_prmt_pk = (
                                                SELECT prmt_pk
                                                FROM tbl_parametro_prmt
                                                WHERE prmt_tppr_pk = portico.getEntidad('TIPO_MERCANCIA_EST')
                                                	AND prmt_parametro LIKE 'PS'
                                            )
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('MERCANCIA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro IN (${campoAdicionalParam})
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_CNUMCA" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_nentero), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE '3%'
                                        OR prmt_parametro LIKE 'CP%'
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('MERCANCIA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro IN ('86091', '86092', '86093', '86094', '86095', '86096', '86097', '8609T')
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_CTONCA" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_ndecimal), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE '3%'
                                        OR prmt_parametro LIKE 'CP%'
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('MERCANCIA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro NOT LIKE '8609*'
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
<!--
                                    AND prmt_parametro IN (
                                        '86091', '86092', '86093', '86094', '86095'
                                        , '86096', '86097', '8609T', '8609A'
                                    )
 -->
    </insert>

    <insert id="CM_CNUMVA_CTONVA_CTEUS" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(COALESCE(esdt_nentero, esdt_ndecimal)), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE '3%'
                                        OR prmt_parametro LIKE 'CP%'
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('MERCANCIA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{campoAdicionalParam}
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_RRTEUS_RRTONC" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_ndecimal), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro LIKE '3%'
                                        OR prmt_parametro LIKE 'CP%'
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('BOOLEANO_01')
                            AND esdt_nentero = 1
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_RRTONO" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_ndecimal), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
        ]]>
        <if test="navtParam != null">
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
        ]]>
        </if>
        <![CDATA[
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('UNIDAD_CARGA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND (
                                        prmt_parametro NOT LIKE '3%'
                                        AND prmt_parametro NOT LIKE 'CP%'
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('BOOLEANO_01')
                            AND esdt_nentero = 1
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('MERCANCIA')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro NOT LIKE '000%'
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <insert id="CM_TRALOC" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT COALESCE(SUM(esdt_ndecimal), 0) AS value
        FROM tbl_estadistica_dato_esdt
        WHERE
            esdt_tpdt_pk = #{tipoDato.id}
            AND EXISTS (
                SELECT 1
                FROM tbl_estadistica_estd
                WHERE
                    estd_pk = esdt_estd_pk
                    AND estd_pepr_pk = #{peprId}
                    AND estd_tpes_pk = portico.getEntidad('MOVIMIENTO_MERCANCIA')
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_OP_BL')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{opetParam}
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_estadistica_dato_esdt
                        WHERE
                            estd_pk = esdt_estd_pk
                            AND esdt_tpdt_pk = portico.getTipoDato('TIPO_NAV')
                            AND EXISTS (
                                SELECT 1 FROM tbl_parametro_prmt
                                WHERE
                                    prmt_pk = esdt_prmt_pk
                                    AND prmt_parametro LIKE #{navtParam}
                            )
                    )
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>

    <!-- CONSULTAS RESUMEN DE CUADRO MES -->
    <insert id="CM_MCONV" parameterType="CuadroMesParametroVO">
        <include refid="InsertPrefix" />
        <![CDATA[
        SELECT cdms_cantidad
        	- (
        		SELECT SUM(cdms2.cdms_cantidad)
        		FROM tbl_cuadro_mes_cdms cdms2
        		WHERE cdms2.cdms_pepr_pk = cdms.cdms_pepr_pk
        			AND cdms2.cdms_opet_pk = cdms.cdms_opet_pk
        			AND cdms2.cdms_navt_pk = cdms.cdms_navt_pk
        			AND cdms2.cdms_pais_pk = cdms.cdms_pais_pk
        			AND EXISTS (
        				SELECT 1 from tbl_parametro_prmt
        				WHERE prmt_pk = cdms_cocu_pk
        					AND prmt_parametro IN ('CTONCA', 'CTONVA')
        			)
        	)
        FROM tbl_cuadro_mes_cdms cdms
        WHERE
        	cdms_pepr_pk = #{peprId}
        	AND EXISTS (
        		SELECT 1 from tbl_parametro_prmt
        		WHERE prmt_pk = cdms_cocu_pk
        			AND prmt_parametro = 'MG'
        	)
            AND EXISTS (
                SELECT 1 from tbl_parametro_prmt
                WHERE prmt_pk = cdms_opet_pk
                    AND prmt_parametro = #{opetParam}
            )
            AND EXISTS (
                SELECT 1 from tbl_parametro_prmt
                WHERE prmt_pk = cdms_navt_pk
                    AND prmt_parametro = #{navtParam}
            )
            AND EXISTS (
                SELECT 1 from tbl_parametro_prmt
                WHERE prmt_pk = cdms_pais_pk
                    AND prmt_parametro = 'ZZ'
            )
        ]]>
        <include refid="InsertSuffix" />
    </insert>
</mapper>
