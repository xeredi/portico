<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.dao.estadistica.EstadisticaAgregadoDAO">
    <resultMap id="ResultMapActividadPesquera" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="TIPO_CAPTURA_PESCA" />
        <id column="ARTE_PESCA" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="TIPO_CAPTURA_PESCA" property="TIPO_CAPTURA_PESCA" />
            <result column="ENTERO_01" property="ENTERO_01" />
            <result column="DECIMAL_01" property="DECIMAL_01" />
            <result column="ARTE_PESCA" property="ARTE_PESCA" />
        </association>
    </resultMap>

    <select id="selectActividadPesquera" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapActividadPesquera">
    <![CDATA[
        SELECT srvc_subp_pk, TIPO_CAPTURA_PESCA, SUM(ENTERO_01) AS ENTERO_01, SUM(DECIMAL_01) AS DECIMAL_01
        FROM (
            WITH srvcs AS (
        		SELECT srvc_pk, srvc_subp_pk, srvc_fref
                FROM
                    tbl_servicio_srvc
                WHERE
                    srvc_tpsr_pk = getEntidad('MANIFIESTO_PESCA')
                    AND srvc_fref >= #{finicio}
                    AND srvc_fref < #{ffin}
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_servicio_dato_srdt
                        WHERE srdt_srvc_pk = srvc_pk
                            AND srdt_tpdt_pk = getTipoDato('COD_EXEN')
                            AND srdt_cadena IN ('0', '2')
                    )
            )
            SELECT
                srvc_subp_pk
                , (
                    SELECT srdt_prmt_pk
                    FROM tbl_servicio_dato_srdt
                    WHERE srdt_srvc_pk = srvc_pk
                        AND srdt_tpdt_pk = getTipoDato('TIPO_OP_PESCA')
                ) AS TIPO_OP_PESCA
                , (
                    SELECT srdt_prmt_pk
                    FROM tbl_servicio_dato_srdt
                    WHERE srdt_srvc_pk = srvc_pk
                        AND srdt_tpdt_pk = getTipoDato('ARTE_PESCA')
                ) AS ARTE_PESCA
                , (
                    SELECT srdt_prmt_pk
                    FROM tbl_servicio_dato_srdt
                    WHERE srdt_srvc_pk = srvc_pk
                        AND srdt_tpdt_pk = getTipoDato('ZONA_PESCA')
                ) AS ZONA_PESCA
                , (
                    SELECT srdt_prmt_pk
                    FROM tbl_servicio_dato_srdt
                    WHERE srdt_srvc_pk = srvc_pk
                        AND srdt_tpdt_pk = getTipoDato('ORGA')
                ) AS ORGA
                , (
                    SELECT ssdt_prmt_pk
                    FROM tbl_subservicio_dato_ssdt
                    WHERE ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('ESPECIE_PESCA')
                ) AS ESPECIE_PESCA
                , (
                    SELECT prdt_prmt_pk
                    FROM tbl_parametro_dato_prdt
                    WHERE
                        prdt_tpdt_pk = getTipoDato('TIPO_CAPTURA_PESCA')
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_parametro_version_prvr
                            WHERE prvr_pk = prdt_prvr_pk
                                AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                AND EXISTS (
                                    SELECT 1
                                    FROM tbl_subservicio_dato_ssdt
                                    WHERE ssdt_ssrv_pk = ssrv_pk
                                        AND ssdt_tpdt_pk = getTipoDato('ESPECIE_PESCA')
                                        AND ssdt_prmt_pk = prvr_prmt_pk
                                )
                        )
                ) AS TIPO_CAPTURA_PESCA
                , (
                    SELECT ssdt_ndecimal
                    FROM tbl_subservicio_dato_ssdt
                    WHERE ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('DECIMAL_02')
                ) AS ENTERO_01
                , (
                    SELECT ssdt_ndecimal
                    FROM tbl_subservicio_dato_ssdt
                    WHERE ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('DECIMAL_04')
                ) AS DECIMAL_01
            FROM
                srvcs
                INNER JOIN tbl_subservicio_ssrv ON
                    ssrv_srvc_pk = srvc_pk
                    AND ssrv_tpss_pk = getEntidad('PARTIDA_PESCA')
        ) sql
        GROUP BY srvc_subp_pk, TIPO_CAPTURA_PESCA
    ]]>
    </select>

    <resultMap id="ResultMapAvituallamiento" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="TIPO_SUM" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="TIPO_SUM" property="TIPO_SUM" />
            <result column="ENTERO_01" property="ENTERO_01" />
        </association>
    </resultMap>

    <select id="selectAvituallamiento" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapAvituallamiento">
    <![CDATA[
        SELECT srvc_subp_pk, TIPO_SUM, SUM(ENTERO_01) / 1000 AS ENTERO_01
        FROM (
            WITH srvcs AS (
                SELECT srvc_pk, srvc_subp_pk, srvc_fref
                FROM
                    tbl_servicio_srvc
                WHERE
                    srvc_tpsr_pk = getEntidad('MANIFIESTO')
                    AND srvc_fref >= #{finicio}
                    AND srvc_fref < #{ffin}
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_servicio_dato_srdt
                        WHERE srdt_srvc_pk = srvc_pk
                            AND srdt_tpdt_pk = getTipoDato('COD_EXEN')
                            AND srdt_cadena IN ('0', '2')
                    )
            )
            SELECT srvc_pk, srvc_subp_pk
                , (
                    SELECT ssdt_prmt_pk
                    FROM tbl_subservicio_dato_ssdt
                    WHERE ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('TIPO_SUM')
                ) AS TIPO_SUM
                , (
                    SELECT COALESCE(ssdt_nentero, 0)
                    FROM tbl_subservicio_dato_ssdt
                    WHERE ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('ENTERO_04')
                ) AS ENTERO_01
            FROM srvcs
                JOIN tbl_subservicio_ssrv ON
                    ssrv_tpss_pk = getEntidad('PARTIDA')
                    AND ssrv_srvc_pk = srvc_pk
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_subservicio_dato_ssdt
                        WHERE ssdt_ssrv_pk = ssrv_pk
                            AND ssdt_tpdt_pk = getTipoDato('COD_EXEN')
                            AND ssdt_cadena IN ('0', '2')
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_subservicio_dato_ssdt
                        WHERE ssdt_ssrv_pk = ssrv_pk
                            AND ssdt_tpdt_pk = getTipoDato('TIPO_SUM')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_version_prvr
                                WHERE prvr_prmt_pk = ssdt_prmt_pk
                                    AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                    AND EXISTS (
                                        SELECT 1
                                        FROM tbl_parametro_dato_prdt
                                        WHERE prdt_prvr_pk = prvr_pk
                                            AND prdt_tpdt_pk = getTipoDato('BOOLEANO_01')
                                            AND prdt_nentero = 1
                                    )
                            )
                    )
        ) sql
        GROUP BY srvc_subp_pk, TIPO_SUM
    ]]>
    </select>

    <resultMap id="ResultMapAgregacionSuperficie" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="ZONA_DEP" />
        <id column="UNID_SUP" />
        <id column="TIPO_MERC_EST" />
        <id column="TIPO_OP_SUP" />
        <id column="ORGA" />
        <id column="BOOLEANO_01" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="ZONA_DEP" property="ZONA_DEP" />
            <result column="UNID_SUP" property="UNID_SUP" />
            <result column="TIPO_MERC_EST" property="TIPO_MERC_EST" />
            <result column="TIPO_OP_SUP" property="TIPO_OP_SUP" />
            <result column="ORGA" property="ORGA" />
            <result column="BOOLEANO_01" property="BOOLEANO_01" />
            <result column="ENTERO_01" property="ENTERO_01" />
        </association>
    </resultMap>

    <select id="selectAgregacionSuperficie" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapAgregacionSuperficie">
    <![CDATA[
        SELECT srvc_subp_pk, ZONA_DEP, UNID_SUP, TIPO_MERC_EST, TIPO_OP_SUP, ORGA, BOOLEANO_01, SUM(ENTERO_01) AS ENTERO_01
        FROM (
        	WITH ssrvs AS (
        		SELECT *
        		FROM
        			tbl_servicio_srvc
        			JOIN tbl_subservicio_ssrv ON
        				ssrv_srvc_pk = srvc_pk
        		WHERE
        			srvc_tpsr_pk = getEntidad('OCUPACION_SUPERFICIE')
        			AND ssrv_tpss_pk = getEntidad('OCUPACION_SUPERFICIE_LINEA')
        			AND ssrv_ffin >= #{finicio}
        			AND ssrv_ffin < #{ffin}
        			AND EXISTS (
        				SELECT 1
        				FROM tbl_servicio_dato_srdt
        				WHERE srdt_srvc_pk = srvc_pk
        					AND srdt_tpdt_pk = getTipoDato('COD_EXEN')
        					AND srdt_cadena IN ('0', '2')
        			)
        	)
        	SELECT srvc_pk, srvc_subp_pk, ssrv_fini, ssrv_ffin
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('ZONA_DEP')
        		) AS ZONA_DEP
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('UNID_SUP')
        		) AS UNID_SUP
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('TIPO_MERC_EST')
        		) AS TIPO_MERC_EST
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('TIPO_OP_SUP')
        		) AS TIPO_OP_SUP
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('ORGA')
        		) AS ORGA
        		, (
        			SELECT srdt_nentero
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('BOOLEANO_02')
        		) AS BOOLEANO_01
        		, (
        			SELECT (ssdt_nentero * EXTRACT (EPOCH FROM ((ssrv_ffin - ssrv_fini)))) / (60*60*24)
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_02')
        		) AS ENTERO_01
        	FROM ssrvs
        ) sql
        GROUP BY srvc_subp_pk, ZONA_DEP, UNID_SUP, TIPO_MERC_EST, TIPO_OP_SUP, ORGA, BOOLEANO_01
    ]]>
    </select>

    <resultMap id="ResultMapAgregacionEscala" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="TIPO_BUQUE" />
        <id column="PAIS" />
        <id column="TIPO_NAV" />
        <id column="TIPO_NAV_2" />
        <id column="TIPO_ACT" />
        <id column="BUQUE" />
        <id column="TIPO_ESTAN_ESC" />
        <id column="SERV_TRAF" />
        <id column="ACUERDO" />
        <id column="ORGA" />
        <id column="TIPO_BUQUE_GT" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="TIPO_BUQUE" property="TIPO_BUQUE" />
            <result column="PAIS" property="PAIS" />
            <result column="TIPO_NAV" property="TIPO_NAV" />
            <result column="TIPO_NAV_2" property="TIPO_NAV_2" />
            <result column="TIPO_ACT" property="TIPO_ACT" />
            <result column="BUQUE" property="BUQUE" />
            <result column="TIPO_ESTAN_ESC" property="TIPO_ESTAN_ESC" />
            <result column="SERV_TRAF" property="SERV_TRAF" />
            <result column="ACUERDO" property="ACUERDO" />
            <result column="ORGA" property="ORGA" />
            <result column="TIPO_BUQUE_GT" property="TIPO_BUQUE_GT" />
            <result column="ENTERO_01" property="ENTERO_01" />
            <result column="ENTERO_02" property="ENTERO_02" />
        </association>
    </resultMap>

    <select id="selectAgregacionEscala" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapAgregacionEscala">
    <![CDATA[
        SELECT srvc_subp_pk, TIPO_BUQUE, PAIS, TIPO_NAV, TIPO_NAV_2, TIPO_ACT, BUQUE, TIPO_ESTAN_ESC, SERV_TRAF, ACUERDO, ORGA, TIPO_BUQUE_GT
            , COUNT(1) AS ENTERO_01, SUM(ENTERO_02) AS ENTERO_02
        FROM (
        	WITH srvcs AS (
        		SELECT *
        			, (
        				SELECT ssrv_pk
        				FROM tbl_subservicio_ssrv
        				WHERE ssrv_srvc_pk = srvc_pk
        					AND ssrv_tpss_pk = getEntidad('ATRAQUE')
        					AND EXISTS (
        						SELECT 1
        						FROM tbl_subservicio_dato_ssdt
        						WHERE ssdt_ssrv_pk = ssrv_pk
        							AND ssdt_tpdt_pk = getTipoDato('TIPO_ATR_3')
        							AND NOT EXISTS (
        								SELECT 1
        								FROM tbl_parametro_prmt
        								WHERE prmt_tppr_pk = getEntidad('TIPO_ATRAQUE')
        									AND prmt_parametro = 'F'
        									AND prmt_pk = ssdt_prmt_pk
        							)
        					)
        			) AS ssrv_pk
        			, (
        				SELECT srdt_prmt_pk
        				FROM tbl_servicio_dato_srdt
        				WHERE srdt_srvc_pk = srvc_pk
        					AND srdt_tpdt_pk = getTipoDato('BUQUE')
        			) AS prmt_buque_pk
        			, (
        				SELECT prvr_pk
        				FROM tbl_parametro_version_prvr
        				WHERE
        					EXISTS (
        						SELECT 1
        						FROM tbl_servicio_dato_srdt
        						WHERE srdt_srvc_pk = srvc_pk
        							AND srdt_tpdt_pk = getTipoDato('BUQUE')
        							AND srdt_prmt_pk = prvr_prmt_pk
        					)
        					AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        			) AS prvr_buque_pk
        		FROM
        			tbl_servicio_srvc
        		WHERE
        			srvc_tpsr_pk = getEntidad('ESCALA')
        			AND srvc_ffin >= #{finicio}
        			AND srvc_ffin < #{ffin}
        			AND EXISTS (
        				SELECT 1
        				FROM tbl_servicio_dato_srdt
        				WHERE srdt_srvc_pk = srvc_pk
        					AND srdt_tpdt_pk = getTipoDato('COD_EXEN')
        					AND srdt_cadena IN ('0', '2')
        			)
        			AND EXISTS (
        				SELECT 1
        				FROM tbl_subservicio_ssrv
        				WHERE ssrv_srvc_pk = srvc_pk
        					AND ssrv_tpss_pk = getEntidad('ATRAQUE')
        					AND EXISTS (
        						SELECT 1
        						FROM tbl_subservicio_dato_ssdt
        						WHERE ssdt_ssrv_pk = ssrv_pk
        							AND ssdt_tpdt_pk = getTipoDato('TIPO_ATR_3')
        							AND NOT EXISTS (
        								SELECT 1
        								FROM tbl_parametro_prmt
        								WHERE prmt_tppr_pk = getEntidad('TIPO_ATRAQUE')
        									AND prmt_parametro = 'F'
        									AND prmt_pk = ssdt_prmt_pk
        							)
        					)
        			)
        	)
        	SELECT srvc_pk, srvc_subp_pk
        		, (
        			SELECT prdt_prmt_pk
        			FROM tbl_parametro_dato_prdt
        			WHERE prdt_prvr_pk = prvr_buque_pk
        				AND prdt_tpdt_pk = getTipoDato('TIPO_BUQUE')
        		) AS TIPO_BUQUE
        		, (
        			SELECT prdt_prmt_pk
        			FROM tbl_parametro_dato_prdt
        			WHERE prdt_prvr_pk = prvr_buque_pk
        				AND prdt_tpdt_pk = getTipoDato('PAIS')
        		) AS PAIS
        		, (
        			SELECT prdt_nentero
        			FROM tbl_parametro_dato_prdt
        			WHERE prdt_prvr_pk = prvr_buque_pk
        				AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
        		) AS ENTERO_02
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('TIPO_NAV')
        		) AS TIPO_NAV
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('TIPO_NAV_2')
        		) AS TIPO_NAV_2
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('TIPO_ACT')
        		) AS TIPO_ACT
        		, prmt_buque_pk AS BUQUE
        		, (
        			SELECT srdt_cadena
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('TIPO_ESTAN_ESC')
        		) AS TIPO_ESTAN_ESC
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('SERV_TRAF')
        		) AS SERV_TRAF
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('ACUERDO')
        		) AS ACUERDO
        		, (
        			SELECT srdt_prmt_pk
        			FROM tbl_servicio_dato_srdt
        			WHERE srdt_srvc_pk = srvc_pk
        				AND srdt_tpdt_pk = getTipoDato('ORGA_3')
        		) AS ORGA
        		, (
        			SELECT prmt_pk
        			FROM tbl_parametro_prmt
        			WHERE
        				prmt_tppr_pk = getEntidad('TIPO_BUQUE_GT')
        				AND EXISTS (
        					SELECT 1
        					FROM tbl_parametro_version_prvr
        					WHERE
        						prvr_prmt_pk = prmt_pk
        						AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        						AND EXISTS (
        							SELECT 1
        							FROM tbl_parametro_dato_prdt
        							WHERE prdt_prvr_pk = prvr_pk
        								AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
        								AND prdt_nentero = (
        									SELECT MIN (prdt_nentero)
        									FROM tbl_parametro_dato_prdt
        									WHERE
        										EXISTS (
        											SELECT 1
        											FROM tbl_parametro_version_prvr
        											WHERE prvr_pk = prdt_prvr_pk
        												AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        												AND EXISTS (
        													SELECT 1
        													FROM tbl_parametro_prmt
        													WHERE prmt_pk = prvr_prmt_pk
        														AND prmt_tppr_pk = getEntidad('TIPO_BUQUE_GT')
        												)
        										)
        										AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
        										AND prdt_nentero >= (
        											SELECT prdt_nentero
        											FROM tbl_parametro_dato_prdt
        											WHERE prdt_prvr_pk = prvr_buque_pk
        												AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
        										)
        								)
        						)
        				)
        		) AS TIPO_BUQUE_GT
        	FROM srvcs
        ) sql
        GROUP BY srvc_subp_pk, TIPO_BUQUE, PAIS, TIPO_NAV, TIPO_NAV_2, TIPO_ACT, BUQUE, TIPO_ESTAN_ESC, SERV_TRAF, ACUERDO, ORGA, TIPO_BUQUE_GT
    ]]>
    </select>

    <resultMap id="ResultMapMovimientoTipoBuqueEEE" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="TIPO_BUQUE_EEE" />
        <id column="TIPO_BUQUE_GT_EEE" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="TIPO_BUQUE_EEE" property="TIPO_BUQUE_EEE" />
            <result column="TIPO_BUQUE_GT_EEE" property="TIPO_BUQUE_GT_EEE" />
            <result column="ENTERO_01" property="ENTERO_01" />
            <result column="ENTERO_02" property="ENTERO_02" />
        </association>
    </resultMap>

    <select id="selectMovimientoTipoBuqueEEE" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapMovimientoTipoBuqueEEE">
    <![CDATA[
        SELECT srvc_subp_pk, TIPO_BUQUE_EEE, TIPO_BUQUE_GT_EEE
            , COUNT(1) AS ENTERO_01, SUM(ENTERO_02) AS ENTERO_02
        FROM (
            WITH srvcs AS (
                SELECT *
                    , (
                        SELECT srdt_prmt_pk
                        FROM tbl_servicio_dato_srdt
                        WHERE srdt_srvc_pk = srvc_pk
                            AND srdt_tpdt_pk = getTipoDato('BUQUE')
                    ) AS prmt_buque_pk
                    , (
                        SELECT prvr_pk
                        FROM tbl_parametro_version_prvr
                        WHERE
                            EXISTS (
                                SELECT 1
                                FROM tbl_servicio_dato_srdt
                                WHERE srdt_srvc_pk = srvc_pk
                                    AND srdt_tpdt_pk = getTipoDato('BUQUE')
                                    AND srdt_prmt_pk = prvr_prmt_pk
                            )
                            AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                    ) AS prvr_buque_pk
                FROM
                    tbl_servicio_srvc
                WHERE
                    srvc_tpsr_pk = getEntidad('ESCALA')
                    AND srvc_ffin >= #{finicio}
                    AND srvc_ffin < #{ffin}
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_servicio_dato_srdt
                        WHERE srdt_srvc_pk = srvc_pk
                            AND srdt_tpdt_pk = getTipoDato('COD_EXEN')
                            AND srdt_cadena IN ('0', '2')
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_subservicio_ssrv
                        WHERE ssrv_srvc_pk = srvc_pk
                            AND ssrv_tpss_pk = getEntidad('ATRAQUE')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_subservicio_dato_ssdt
                                WHERE ssdt_ssrv_pk = ssrv_pk
                                    AND ssdt_tpdt_pk = getTipoDato('TIPO_ATR_3')
                                    AND NOT EXISTS (
                                        SELECT 1
                                        FROM tbl_parametro_prmt
                                        WHERE prmt_tppr_pk = getEntidad('TIPO_ATRAQUE')
                                            AND prmt_parametro = 'F'
                                            AND prmt_pk = ssdt_prmt_pk
                                    )
                            )
                    )
            )
            SELECT srvc_pk, srvc_subp_pk
                , (
                    SELECT prdt_prmt_pk
                    FROM tbl_parametro_dato_prdt
                    WHERE
                        prdt_tpdt_pk = getTipoDato('TIPO_BUQUE_EEE')
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_parametro_version_prvr
                            WHERE prvr_pk = prdt_prvr_pk
                                AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                AND prvr_prmt_pk = (
                                    SELECT prdt_prmt_pk
                                    FROM tbl_parametro_dato_prdt
                                    WHERE
                                        prdt_tpdt_pk = getTipoDato('TIPO_BUQUE_EST')
                                        AND EXISTS (
                                            SELECT 1
                                            FROM tbl_parametro_version_prvr
                                            WHERE prvr_pk = prdt_prvr_pk
                                                AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                                AND prvr_prmt_pk = (
                                                    SELECT prdt_prmt_pk
                                                    FROM tbl_parametro_dato_prdt
                                                    WHERE
                                                        prdt_tpdt_pk = getTipoDato('TIPO_BUQUE')
                                                        AND prdt_prvr_pk = prvr_buque_pk
                                                )
                                        )
                                )
                        )
                    ) AS TIPO_BUQUE_EEE
                , (
                    SELECT prmt_pk
                    FROM tbl_parametro_prmt
                    WHERE
                        prmt_tppr_pk = getEntidad('TIPO_BUQUE_GT_EEE')
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_parametro_version_prvr
                            WHERE
                                prvr_prmt_pk = prmt_pk
                                AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                AND EXISTS (
                                    SELECT 1
                                    FROM tbl_parametro_dato_prdt
                                    WHERE prdt_prvr_pk = prvr_pk
                                        AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
                                        AND prdt_nentero = (
                                            SELECT MAX (prdt_nentero)
                                            FROM tbl_parametro_dato_prdt
                                            WHERE
                                                EXISTS (
                                                    SELECT 1
                                                    FROM tbl_parametro_version_prvr
                                                    WHERE prvr_pk = prdt_prvr_pk
                                                        AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                                        AND EXISTS (
                                                            SELECT 1
                                                            FROM tbl_parametro_prmt
                                                            WHERE prmt_pk = prvr_prmt_pk
                                                                AND prmt_tppr_pk = getEntidad('TIPO_BUQUE_GT_EEE')
                                                        )
                                                )
                                                AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
                                                AND prdt_nentero <= (
                                                    SELECT prdt_nentero
                                                    FROM tbl_parametro_dato_prdt
                                                    WHERE prdt_prvr_pk = prvr_buque_pk
                                                        AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
                                                )
                                        )
                                )
                        )
                ) AS TIPO_BUQUE_GT_EEE
                , (
                    SELECT prdt_nentero
                    FROM tbl_parametro_dato_prdt
                    WHERE prdt_prvr_pk = prvr_buque_pk
                        AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
                ) AS ENTERO_02
            FROM srvcs
        ) sql
        GROUP BY srvc_subp_pk, TIPO_BUQUE_EEE, TIPO_BUQUE_GT_EEE
    ]]>
    </select>

    <resultMap id="ResultMapBuqueFondeadoAtracado" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="TIPO_ATR" />
        <id column="ORGA" />
        <id column="BUQUE" />
        <id column="SERV_TRAF" />
        <id column="ALIN" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="TIPO_ATR" property="TIPO_ATR" />
            <result column="ORGA" property="ORGA" />
            <result column="BUQUE" property="BUQUE" />
            <result column="SERV_TRAF" property="SERV_TRAF" />
            <result column="ALIN" property="ALIN" />
            <result column="ENTERO_01" property="ENTERO_01" />
            <result column="ENTERO_02" property="ENTERO_02" />
            <result column="ENTERO_03" property="ENTERO_03" />
            <result column="ENTERO_04" property="ENTERO_04" />
            <result column="ENTERO_05" property="ENTERO_05" />
        </association>
    </resultMap>

    <select id="selectBuqueFondeadoAtracado" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapBuqueFondeadoAtracado">
    <![CDATA[
        SELECT srvc_subp_pk, TIPO_ATR, ORGA, BUQUE, SERV_TRAF, ALIN
            , COUNT(1) AS ENTERO_01
            , SUM(ENTERO_02) AS ENTERO_02
            , SUM(ENTERO_02 * dias) AS ENTERO_03
            , SUM(ENTERO_04) AS ENTERO_04
            , SUM(ENTERO_04 * dias) AS ENTERO_05
        FROM (
            WITH ssrvs AS (
                SELECT *
                    , (
                        SELECT srdt_prmt_pk
                        FROM tbl_servicio_dato_srdt
                        WHERE srdt_srvc_pk = srvc_pk
                            AND srdt_tpdt_pk = getTipoDato('BUQUE')
                    ) AS prmt_buque_pk
                    , (
                        SELECT prvr_pk
                        FROM tbl_parametro_version_prvr
                        WHERE
                            EXISTS (
                                SELECT 1
                                FROM tbl_servicio_dato_srdt
                                WHERE srdt_srvc_pk = srvc_pk
                                    AND srdt_tpdt_pk = getTipoDato('BUQUE')
                                    AND srdt_prmt_pk = prvr_prmt_pk
                            )
                            AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                    ) AS prvr_buque_pk
                    , EXTRACT (EPOCH FROM (ssrv_ffin - ssrv_fini)) / (60*60*24) AS dias
                FROM
                    tbl_servicio_srvc
                    JOIN tbl_subservicio_ssrv ON
                        ssrv_srvc_pk = srvc_pk
                        AND ssrv_tpss_pk = getEntidad('ATRAQUE')
                        AND ssrv_estado IN ('I', 'F')
                WHERE
                    srvc_tpsr_pk = getEntidad('ESCALA')
                    AND srvc_ffin >= #{finicio}
                    AND srvc_ffin < #{ffin}
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_servicio_dato_srdt
                        WHERE srdt_srvc_pk = srvc_pk
                            AND srdt_tpdt_pk = getTipoDato('COD_EXEN')
                            AND srdt_cadena IN ('0', '2')
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_servicio_dato_srdt
                        WHERE srdt_srvc_pk = srvc_pk
                            AND srdt_tpdt_pk = getTipoDato('BUQUE')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_version_prvr
                                WHERE prvr_prmt_pk = srdt_prmt_pk
                                    AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                    AND EXISTS (
                                        SELECT 1
                                        FROM tbl_parametro_dato_prdt
                                        WHERE prdt_prvr_pk = prvr_pk
                                            AND prdt_tpdt_pk = getTipoDato('TIPO_BUQUE')
                                            AND prdt_prmt_pk NOT IN (
                                                SELECT prmt_pk
                                                FROM tbl_parametro_prmt
                                                WHERE prmt_tppr_pk = getEntidad('TIPO_BUQUE')
                                                    AND (
                                                        prmt_parametro LIKE 'P%'
                                                        OR prmt_parametro LIKE 'O%'
                                                        OR prmt_parametro LIKE 'BG'
                                                    )
                                            )
                                    )
                            )
                    )
                    AND EXISTS (
                        SELECT 1
                        FROM tbl_subservicio_dato_ssdt
                        WHERE ssdt_ssrv_pk = ssrv_pk
                            AND ssdt_tpdt_pk = getTipoDato('TIPO_ACT_3')
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_version_prvr
                                WHERE prvr_prmt_pk = ssdt_prmt_pk
                                    AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
                                    AND EXISTS (
                                        SELECT 1
                                        FROM tbl_parametro_dato_prdt
                                        WHERE prdt_prvr_pk = prvr_pk
                                            AND prdt_tpdt_pk = getTipoDato('TIPO_ACT_EST')
                                            AND prdt_cadena LIKE 'SI'
                                    )
                            )
                    )
            )
            SELECT srvc_pk, srvc_subp_pk, dias
                , (
                    SELECT ssdt_prmt_pk
                    FROM tbl_subservicio_dato_ssdt
                    WHERE
                        ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('TIPO_ATR')
                ) AS TIPO_ATR
                , (
                    SELECT ssdt_prmt_pk
                    FROM tbl_subservicio_dato_ssdt
                    WHERE
                        ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('ORGA_2')
                ) AS ORGA
                , prmt_buque_pk AS BUQUE
                , (
                    SELECT srdt_prmt_pk
                    FROM tbl_servicio_dato_srdt
                    WHERE
                        srdt_srvc_pk = srvc_pk
                        AND srdt_tpdt_pk = getTipoDato('SERV_TRAF')
                ) AS SERV_TRAF
                , (
                    SELECT ssdt_prmt_pk
                    FROM tbl_subservicio_dato_ssdt
                    WHERE
                        ssdt_ssrv_pk = ssrv_pk
                        AND ssdt_tpdt_pk = getTipoDato('ALIN_2')
                ) AS ALIN
                , (
                    SELECT prdt_ndecimal
                    FROM tbl_parametro_dato_prdt
                    WHERE
                        prdt_prvr_pk = prvr_buque_pk
                        AND prdt_tpdt_pk = getTipoDato('DECIMAL_03')
                ) AS ENTERO_02
                , (
                    SELECT prdt_nentero
                    FROM tbl_parametro_dato_prdt
                    WHERE
                        prdt_prvr_pk = prvr_buque_pk
                        AND prdt_tpdt_pk = getTipoDato('ENTERO_01')
                ) AS ENTERO_04
            FROM ssrvs
        ) sql
        GROUP BY srvc_subp_pk, TIPO_ATR, ORGA, BUQUE, SERV_TRAF, ALIN
    ]]>
    </select>

    <resultMap id="ResultMapMovimientoMercancia" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="TIPO_OP_BL" />
        <id column="UNLOCODE" />
        <id column="UNLOCODE_2" />
        <id column="ALIN" />
        <id column="UNLOCODE_3" />
        <id column="UNLOCODE_4" />
        <id column="MERCANCIA" />
        <id column="TIPO_NAV" />
        <id column="UNIDAD_CARGA" />
        <id column="INST_ESP" />
        <id column="TIPO_TRANSPORTE" />
        <id column="BOOLEANO_01" />
        <id column="ORGA" />
        <id column="ORGA_2" />
        <id column="BUQUE" />
        <id column="SERV_TRAF" />
        <id column="ACUERDO" />
        <id column="TERMINAL" />
        <id column="CADENA_01" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="TIPO_OP_BL" property="TIPO_OP_BL" />
            <result column="UNLOCODE" property="UNLOCODE" />
            <result column="UNLOCODE_2" property="UNLOCODE_2" />
            <result column="ALIN" property="ALIN" />
            <result column="UNLOCODE_3" property="UNLOCODE_3" />
            <result column="UNLOCODE_4" property="UNLOCODE_4" />
            <result column="MERCANCIA" property="MERCANCIA" />
            <result column="TIPO_NAV" property="TIPO_NAV" />
            <result column="UNIDAD_CARGA" property="UNIDAD_CARGA" />
            <result column="INST_ESP" property="INST_ESP" />
            <result column="TIPO_TRANSPORTE" property="TIPO_TRANSPORTE" />
            <result column="BOOLEANO_01" property="BOOLEANO_01" />
            <result column="ORGA" property="ORGA" />
            <result column="ORGA_2" property="ORGA_2" />
            <result column="BUQUE" property="BUQUE" />
            <result column="SERV_TRAF" property="SERV_TRAF" />
            <result column="ACUERDO" property="ACUERDO" />
            <result column="TERMINAL" property="TERMINAL" />
            <result column="CADENA_01" property="CADENA_01" />
            <result column="DECIMAL_01" property="DECIMAL_01" />
            <result column="ENTERO_01" property="ENTERO_01" />
            <result column="DECIMAL_02" property="DECIMAL_02" />
        </association>
    </resultMap>

    <select id="selectMovimientoMercancia" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapMovimientoMercancia">
    <![CDATA[
        SELECT
        	srvc_subp_pk, TIPO_OP_BL, UNLOCODE, UNLOCODE_2, ALIN, UNLOCODE_3, UNLOCODE_4, MERCANCIA, TIPO_NAV, UNIDAD_CARGA, INST_ESP, TIPO_TRANSPORTE
        	, BOOLEANO_01, ORGA, ORGA_2, BUQUE, SERV_TRAF, ACUERDO, TERMINAL, CADENA_01
        	, SUM(DECIMAL_01) AS DECIMAL_01, SUM(ENTERO_01) AS ENTERO_01, SUM(DECIMAL_02) AS DECIMAL_02
        FROM (
        	WITH ssrvs AS (
        		SELECT ssrv_pk, srvc_pk, srvc_subp_pk, srvc_fref
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_tpdt_pk = getTipoDato('ORGA')
        					AND EXISTS (
        						SELECT 1
        						FROM tbl_subservicio_ssrv ssrvMaco
        						WHERE
        							ssrv_tpss_pk = getEntidad('MANIFIESTO_CONSIGNATARIO')
        							AND EXISTS (
        								SELECT 1
        								FROM tbl_subservicio_subservicio_ssss
        								WHERE
        									ssss_ssrvp_pk = ssrvMaco.ssrv_pk
        									AND ssss_ssrvh_pk = ssrvBl.ssrv_pk
        							)
        							AND ssrv_pk = ssdt_ssrv_pk
        					)
        			) AS ORGA_2
        			, (
        				SELECT srdt_prmt_pk
        				FROM tbl_servicio_dato_srdt srdtEsca
        				WHERE
        					srdt_tpdt_pk = getTipoDato('BUQUE')
        					AND EXISTS (
        						SELECT 1
        						FROM tbl_servicio_dato_srdt srdtMani
        						WHERE
        							srdtMani.srdt_tpdt_pk = getTipoDato('ESCALA')
        							AND srdtMani.srdt_srvc_pk = srvc_pk
        							AND srdtMani.srdt_srvc_dep_pk = srdtEsca.srdt_srvc_pk
        					)
        			) AS BUQUE
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('TIPO_OP_BL')
        			) AS TIPO_OP_BL
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('UNLOCODE_2')
        			) AS UNLOCODE
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('UNLOCODE_3')
        			) AS UNLOCODE_2
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('UNLOCODE')
        			) AS UNLOCODE_3
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('UNLOCODE_4')
        			) AS UNLOCODE_4
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('ALIN')
        			) AS ALIN
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('TIPO_NAV')
        			) AS TIPO_NAV
        			, (
        				SELECT ssdt_cadena
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('TIPO_TRANSPORTE')
        			) AS TIPO_TRANSPORTE
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_tpdt_pk = getTipoDato('SERV_TRAF')
        					AND ssdt_ssrv_pk = ssrv_pk
        			) AS SERV_TRAF
        		FROM
        			tbl_servicio_srvc
        			JOIN tbl_subservicio_ssrv ssrvBl ON
        				ssrv_srvc_pk = srvc_pk
        				AND ssrv_tpss_pk = getEntidad('BL')
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_subservicio_dato_ssdt
                            WHERE ssdt_ssrv_pk = ssrv_pk
                                AND ssdt_tpdt_pk = getTipoDato('TIPO_OP_BL')
                                AND ssdt_prmt_pk <> (
                                    SELECT prmt_pk
                                    FROM tbl_parametro_prmt
                                    WHERE prmt_tppr_pk = getEntidad('TIPO_OPERACION_BL')
                                        AND prmt_parametro LIKE 'TE'
                                )
                        )
        		WHERE
        			srvc_tpsr_pk = getEntidad('MANIFIESTO')
        			AND srvc_fref >= #{finicio}
        			AND srvc_fref < #{ffin}
        	)

        	SELECT
        		srvc_subp_pk, TIPO_OP_BL, UNLOCODE, UNLOCODE_2, ALIN, UNLOCODE_3, UNLOCODE_4
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('MERCANCIA')
        		) AS MERCANCIA
        		, TIPO_NAV
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('UNIDAD_CARGA')
        		) AS UNIDAD_CARGA
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('INST_ESP')
        		) AS INST_ESP
        		, TIPO_TRANSPORTE
        		, (
        			SELECT ssdt_nentero
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('BOOLEANO_02')
        		) AS BOOLEANO_01
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ORGA')
        		) AS ORGA
        		, ORGA_2, BUQUE, SERV_TRAF
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ACUERDO')
        		) AS ACUERDO
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('TERMINAL')
        		) AS TERMINAL
        		, NULL AS CADENA_01
        		, (
        			SELECT COALESCE(ssdt_nentero, 0)/1000.0
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_04')
        		) AS DECIMAL_01
        		, (
        			SELECT COALESCE(ssdt_nentero, 0)
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_03')
        		) AS ENTERO_01
        		, 0 AS DECIMAL_02
        	FROM ssrvs
        		JOIN tbl_subservicio_ssrv ssrvPart ON
        			ssrvPart.ssrv_srvc_pk = ssrvs.srvc_pk
        			AND ssrvPart.ssrv_tpss_pk = getEntidad('PARTIDA')
        		JOIN tbl_subservicio_subservicio_ssss ON
        			ssss_ssrvp_pk = ssrvs.ssrv_pk
        			AND ssss_ssrvh_pk = ssrvPart.ssrv_pk
        	WHERE
        		EXISTS (
        			SELECT 1
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('COD_EXEN')
        				AND ssdt_cadena IN ('0', '2')
        		)
        		AND NOT EXISTS (
        			SELECT 1
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('BOOLEANO_01')
        				AND ssdt_nentero = 1
        		)

        	UNION ALL

        	SELECT srvc_subp_pk, TIPO_OP_BL, UNLOCODE, UNLOCODE_2, ALIN, UNLOCODE_3, UNLOCODE_4, MERCANCIA, TIPO_NAV, UNIDAD_CARGA
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = part_asociada_pk
        				AND ssdt_tpdt_pk = getTipoDato('INST_ESP')
        		) AS INST_ESP
        		, TIPO_TRANSPORTE, BOOLEANO_01
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = part_asociada_pk
        				AND ssdt_tpdt_pk = getTipoDato('ORGA')
        		) AS ORGA
        		, ORGA_2, BUQUE, SERV_TRAF
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = part_asociada_pk
        				AND ssdt_tpdt_pk = getTipoDato('ACUERDO')
        		) AS ACUERDO
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE
        				ssdt_ssrv_pk = part_asociada_pk
        				AND ssdt_tpdt_pk = getTipoDato('TERMINAL')
        		) AS TERMINAL
        		, NULL AS CADENA_01
        		, DECIMAL_01
        		, ENTERO_01
        		, (
        			SELECT prdt_ndecimal
        			FROM tbl_parametro_dato_prdt
        			WHERE
        				prdt_tpdt_pk = getTipoDato('DECIMAL_01')
        				AND EXISTS (
        					SELECT 1
        					FROM tbl_parametro_version_prvr
        					WHERE prvr_pk = prdt_prvr_pk
        						AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        						AND prvr_prmt_pk = UNIDAD_CARGA
        				)
        		) AS DECIMAL_02
        	FROM (
        		SELECT ssrvs.*
        			, (
        				SELECT prdt_prmt_pk
        				FROM tbl_parametro_dato_prdt
        				WHERE
        					prdt_tpdt_pk = getTipoDato('MERCANCIA')
        					AND EXISTS (
        						SELECT 1
        						FROM tbl_parametro_version_prvr
        						WHERE prvr_pk = prdt_prvr_pk
        							AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        							AND prvr_prmt_pk = (
        								SELECT ssdt_prmt_pk
        								FROM tbl_subservicio_dato_ssdt
        								WHERE
        									ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        									AND ssdt_tpdt_pk = getTipoDato('TIPO_EQUI')
        							)
        					)
        			) AS MERCANCIA
        			, (
        				SELECT ssdt_prmt_pk
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('UNIDAD_CARGA')
        			) AS UNIDAD_CARGA
        			, (
        				SELECT ssdt_nentero
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('BOOLEANO_01')
        			) AS BOOLEANO_01
        			, (
        				SELECT COALESCE(ssdt_nentero, 0)/1000.0
        				FROM tbl_subservicio_dato_ssdt
        				WHERE
        					ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        					AND ssdt_tpdt_pk = getTipoDato('ENTERO_02')
        			) AS DECIMAL_01
        			, (
        				CASE
        					WHEN '4' = (
        						SELECT ssdt_cadena
        						FROM tbl_subservicio_dato_ssdt
        						WHERE
        							ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        							AND ssdt_tpdt_pk = getTipoDato('CADENA_02')

        					)
        					THEN (
        						SELECT ssdt_nentero
        						FROM tbl_subservicio_dato_ssdt
        						WHERE
        							ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        							AND ssdt_tpdt_pk = getTipoDato('ENTERO_01')
        					)
        					ELSE 1
        				END
        			) AS ENTERO_01
        			, (
        				SELECT ssrv_pk
        				FROM tbl_subservicio_ssrv part
        				WHERE part.ssrv_srvc_pk = ssrvEqui.ssrv_srvc_pk
        					AND part.ssrv_tpss_pk = getEntidad('PARTIDA')
        					AND EXISTS (
        						SELECT 1
        						FROM tbl_subservicio_subservicio_ssss ssssPart
        						WHERE ssssPart.ssss_ssrvp_pk = part.ssrv_pk
        							AND EXISTS (
        								SELECT 1
        								FROM tbl_subservicio_subservicio_ssss ssssEqui
        								WHERE ssssEqui.ssss_ssrvp_pk = ssrvEqui.ssrv_pk
        									AND ssssEqui.ssss_ssrvh_pk = ssssPart.ssss_ssrvh_pk
        							)
        					)
        			) AS part_asociada_pk
        		FROM ssrvs
        			JOIN tbl_subservicio_ssrv ssrvEqui ON
        				ssrvEqui.ssrv_srvc_pk = ssrvs.srvc_pk
        				AND ssrvEqui.ssrv_tpss_pk = getEntidad('EQUIPAMIENTO')
        			JOIN tbl_subservicio_subservicio_ssss ON
        				ssss_ssrvp_pk = ssrvs.ssrv_pk
        				AND ssss_ssrvh_pk = ssrvEqui.ssrv_pk
			WHERE
				EXISTS (
					SELECT 1
					FROM tbl_subservicio_dato_ssdt
					WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
						AND ssdt_tpdt_pk = getTipoDato('COD_EXEN')
						AND ssdt_cadena IN ('0', '2')
				)
				AND EXISTS (
					SELECT 1
					FROM tbl_subservicio_dato_ssdt
					WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
						AND ssdt_tpdt_pk = getTipoDato('TIPO_EQUI')
						AND EXISTS (
							select 1
							from
								tbl_parametro_version_prvr
								JOIN tbl_parametro_dato_prdt ON
									prdt_prvr_pk = prvr_pk
									AND prdt_tpdt_pk = getTipoDato('MERCANCIA')
							WHERE
								srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
								AND prdt_prmt_pk IS NOT NULL
								AND prvr_prmt_pk = ssdt_prmt_pk
						)
				)
        	) ssrvs
        ) sql
        GROUP BY
        	srvc_subp_pk, TIPO_OP_BL, UNLOCODE, UNLOCODE_2, ALIN, UNLOCODE_3, UNLOCODE_4, MERCANCIA, TIPO_NAV, UNIDAD_CARGA, INST_ESP, TIPO_TRANSPORTE
        	, BOOLEANO_01, ORGA, ORGA_2, BUQUE, SERV_TRAF, ACUERDO, TERMINAL, CADENA_01
    ]]>
    </select>

    <resultMap id="ResultMapMovimientoMercanciaEEE" type="EstadisticaAgregadoVO">
        <id column="srvc_subp_pk" property="subpId" />
        <id column="UNLOCODE" />
        <id column="MERCANCIA" />
        <id column="UNIDAD_CARGA" />
        <id column="GRUPO_NST" />
        <id column="REG_TBUQUE_EEE" />
        <id column="DIREC_MERC" />
        <id column="BOOLEANO_01" />

        <association property="esdtMap" javaType="java.util.Map">
            <result column="UNLOCODE" property="UNLOCODE" />
            <result column="MERCANCIA" property="MERCANCIA" />
            <result column="UNIDAD_CARGA" property="UNIDAD_CARGA" />
            <result column="GRUPO_NST" property="GRUPO_NST" />
            <result column="REG_TBUQUE_EEE" property="REG_TBUQUE_EEE" />
            <result column="DIREC_MERC" property="DIREC_MERC" />
            <result column="BOOLEANO_01" property="BOOLEANO_01" />

            <result column="DECIMAL_01" property="DECIMAL_01" />
            <result column="ENTERO_01" property="ENTERO_01" />
            <result column="ENTERO_02" property="ENTERO_02" />
            <result column="ENTERO_03" property="ENTERO_03" />
            <result column="ENTERO_04" property="ENTERO_04" />
            <result column="ENTERO_05" property="ENTERO_05" />
        </association>
    </resultMap>

    <select id="selectMovimientoMercanciaEEE" parameterType="EstadisticaAgregadoCriterioVO"
        resultMap="ResultMapMovimientoMercanciaEEE">
    <![CDATA[
        SELECT srvc_subp_pk, UNLOCODE, MERCANCIA, UNIDAD_CARGA, GRUPO_NST, REG_TBUQUE_EEE, DIREC_MERC, BOOLEANO_01
        	, COALESCE(SUM(DECIMAL_01), 0) AS DECIMAL_01, COALESCE(SUM(ENTERO_01), 0) AS ENTERO_01
        	, COALESCE(SUM(ENTERO_02), 0) AS ENTERO_02, COALESCE(SUM(ENTERO_03), 0) AS ENTERO_03
        	, COALESCE(SUM(ENTERO_04), 0) AS ENTERO_04, COALESCE(SUM(ENTERO_05), 0) AS ENTERO_05
        FROM (
        	with ssrvs AS (
        		SELECT
        			srvc_pk, srvc_subp_pk, srvc_fref, ssrv_pk
        			, (
        				CASE
        					WHEN
        						EXISTS (
        							SELECT 1
        							FROM tbl_subservicio_dato_ssdt
        							WHERE
        								ssdt_ssrv_pk = ssrv_pk
        								AND ssdt_tpdt_pk = getTipoDato('TIPO_OP_BL')
        								AND ssdt_prmt_pk = ANY (
        									SELECT prmt_pk
        									FROM tbl_parametro_prmt
        									WHERE prmt_tppr_pk = getEntidad('TIPO_OPERACION_BL')
        										AND prmt_parametro LIKE 'E%'
        								)
        						)
        					THEN 'E'
        					ELSE 'S'
        				END
        			) as DIREC_MERC
        			, (
        				SELECT prdt_prmt_pk
        				FROM
        					tbl_parametro_dato_prdt
        					JOIN tbl_parametro_version_prvr ON
        						prvr_pk = prdt_prvr_pk
        						AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        				WHERE
        					prdt_tpdt_pk = getTipoDato('REG_TBUQUE_EEE')
        					AND prvr_prmt_pk = (
        						SELECT prdt_prmt_pk
        						FROM
        							tbl_parametro_dato_prdt
        							JOIN tbl_parametro_version_prvr ON
        								prvr_pk = prdt_prvr_pk
        								AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        						WHERE
        							prdt_tpdt_pk = getTipoDato('REG_TBUQUE')
        							AND prvr_prmt_pk = (
        								SELECT srdt_prmt_pk
        								FROM tbl_servicio_dato_srdt
        								WHERE
        									srdt_tpdt_pk = getTipoDato('BUQUE')
        									AND srdt_srvc_pk = (
        										SELECT srdt_srvc_dep_pk
        										FROM tbl_servicio_dato_srdt
        										WHERE srdt_srvc_pk = srvc_pk
        											AND srdt_tpdt_pk = getTipoDato('ESCALA')
        									)
        							)
        					)
        			) AS REG_TBUQUE_EEE
        		FROM
        			tbl_servicio_srvc
        			JOIN tbl_subservicio_ssrv ssrvBl ON
        				ssrv_srvc_pk = srvc_pk
        				AND ssrv_tpss_pk = getEntidad('BL')
        				AND NOT EXISTS (
        					SELECT 1
        					FROM tbl_subservicio_dato_ssdt
        					WHERE
        						ssdt_tpdt_pk = getTipoDato('TIPO_OP_BL')
        						AND EXISTS (
        							SELECT prmt_pk
        							FROM tbl_parametro_prmt
        							WHERE prmt_tppr_pk = getEntidad('TIPO_OPERACION_BL')
        								AND prmt_parametro LIKE 'TE'
        								AND prmt_pk = ssdt_prmt_pk
        						)
        						AND ssdt_ssrv_pk = ssrv_pk
        				)
        				AND NOT EXISTS (
        					SELECT 1
        					FROM tbl_subservicio_dato_ssdt
        					WHERE
        						ssdt_tpdt_pk = getTipoDato('TIPO_NAV')
        						AND EXISTS (
        							SELECT prmt_pk
        							FROM tbl_parametro_prmt
        							WHERE prmt_tppr_pk = getEntidad('TIPO_NAVEGACION')
        								AND prmt_parametro LIKE 'I'
        								AND prmt_pk = ssdt_prmt_pk
        						)
        						AND ssdt_ssrv_pk = ssrv_pk
        				)
        		WHERE
        			srvc_tpsr_pk = getEntidad('MANIFIESTO')
        			AND srvc_fref >= #{finicio}
        			AND srvc_fref < #{ffin}
        			AND EXISTS (
        				SELECT 1
        				FROM tbl_servicio_dato_srdt
        				WHERE srdt_srvc_pk = srvc_pk
        					AND srdt_tpdt_pk = getTipoDato('ESCALA')
        					AND srdt_srvc_dep_pk IS NOT NULL
        			)
        	)

        	SELECT srvc_pk, srvc_subp_pk, srvc_fref, ssrvs.ssrv_pk, DIREC_MERC, REG_TBUQUE_EEE
        		, (
        			CASE
        				WHEN DIREC_MERC = 'E'
        				THEN (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvs.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('UNLOCODE_3')
        				)
        				ELSE (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvs.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('UNLOCODE_2')
        				)
        			END
        		) AS UNLOCODE
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('MERCANCIA')
        		) as MERCANCIA
        		, (
        			SELECT prdt_prmt_pk
        			FROM
        				tbl_parametro_dato_prdt
        				JOIN tbl_parametro_version_prvr ON
        					prvr_pk = prdt_prvr_pk
        					AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        			WHERE
        				prdt_tpdt_pk = getTipoDato('GRUPO_NST')
        				AND prvr_prmt_pk = (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('MERCANCIA')
        				)
        		) as GRUPO_NST
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('UNIDAD_CARGA')
        		) AS UNIDAD_CARGA
        		, (
        			SELECT ssdt_nentero
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('BOOLEANO_02')
        		) AS BOOLEANO_01
        		, (
        			SELECT COALESCE(ssdt_nentero, 0)/1000.0
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_04')
        		) AS DECIMAL_01
        		, (
        			SELECT coalesce(ssdt_nentero, 0)
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_03')
        				AND EXISTS (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('MERCANCIA')
        						AND EXISTS (
        							SELECT prmt_pk
        							FROM tbl_parametro_prmt
        							WHERE prmt_tppr_pk = getEntidad('MERCANCIA')
        								AND (
        									prmt_parametro LIKE '0001%'
        									OR prmt_parametro LIKE '0002%'
        								)
        								AND prmt_pk = ssdt_prmt_pk
        						)
        				)
        		) AS ENTERO_01
        		, 0 AS ENTERO_02
        		, 0 AS ENTERO_03
        		, (
        			SELECT coalesce(ssdt_nentero, 0)
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_03')
        				AND EXISTS (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('MERCANCIA')
        						AND EXISTS (
        							SELECT prmt_pk
        							FROM tbl_parametro_prmt
        							WHERE prmt_tppr_pk = getEntidad('MERCANCIA')
        								AND prmt_parametro IN ('0001C', '0002C')
        								AND prmt_pk = ssdt_prmt_pk
        						)
        				)
        		) AS ENTERO_04
        		, (
        			SELECT coalesce(ssdt_nentero, 0)
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_03')
        				AND EXISTS (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('MERCANCIA')
        						AND exists (
        							SELECT prmt_pk
        							FROM tbl_parametro_prmt
        							WHERE prmt_tppr_pk = getEntidad('MERCANCIA')
        								AND prmt_parametro IN ('0001X', '0002X')
        								AND prmt_pk = ssdt_prmt_pk
        						)
        				)
        		) AS ENTERO_05
        	FROM ssrvs
        		join tbl_subservicio_ssrv ssrvPart ON
        			ssrvPart.ssrv_tpss_pk = getEntidad('PARTIDA')
        			AND ssrvPart.ssrv_srvc_pk = srvc_pk
        		JOIN tbl_subservicio_subservicio_ssss ON
        			ssss_ssrvp_pk = ssrvs.ssrv_pk
        			AND ssss_ssrvh_pk = ssrvPart.ssrv_pk
        	WHERE
        		EXISTS (
        			SELECT 1
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('COD_EXEN')
        				AND ssdt_cadena IN ('0', '2')
        		)
        		AND NOT EXISTS (
        			SELECT 1
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvPart.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('BOOLEANO_01')
        				AND ssdt_nentero = 1
        		)

        	UNION ALL

        	SELECT srvc_pk, srvc_subp_pk, srvc_fref, ssrvs.ssrv_pk, DIREC_MERC, REG_TBUQUE_EEE
        		, (
        			CASE
        				WHEN DIREC_MERC = 'E'
        				THEN (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvs.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('UNLOCODE_3')
        				)
        				ELSE (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvs.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('UNLOCODE_2')
        				)
        			END
        		) AS UNLOCODE
        		, (
        			SELECT prdt_prmt_pk
        			FROM
        				tbl_parametro_dato_prdt
        				JOIN tbl_parametro_version_prvr ON
        					prvr_pk = prdt_prvr_pk
        					AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        			WHERE
        				prdt_tpdt_pk = getTipoDato('MERCANCIA')
        				AND prvr_prmt_pk = (
        					SELECT ssdt_prmt_pk
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('TIPO_EQUI')
        				)
        		) as MERCANCIA
        		, (
        			SELECT prdt_prmt_pk
        			FROM
        				tbl_parametro_dato_prdt
        				JOIN tbl_parametro_version_prvr ON
        					prvr_pk = prdt_prvr_pk
        					AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        			WHERE
        				prdt_tpdt_pk = getTipoDato('GRUPO_NST')
        				AND prvr_prmt_pk = (
        					SELECT prdt_prmt_pk
        					FROM
        						tbl_parametro_dato_prdt
        						JOIN tbl_parametro_version_prvr ON
        							prvr_pk = prdt_prvr_pk
        							AND srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        					WHERE
        						prdt_tpdt_pk = getTipoDato('MERCANCIA')
        						AND prvr_prmt_pk = (
        							SELECT ssdt_prmt_pk
        							FROM tbl_subservicio_dato_ssdt
        							WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        								AND ssdt_tpdt_pk = getTipoDato('TIPO_EQUI')
        						)
        				)
        		) as GRUPO_NST
        		, (
        			SELECT ssdt_prmt_pk
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('UNIDAD_CARGA')
        		) AS UNIDAD_CARGA
        		, (
        			SELECT ssdt_nentero
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('BOOLEANO_01')
        		) AS BOOLEANO_01
        		, (
        			SELECT COALESCE(ssdt_nentero, 0)/1000.0
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_02')
        		) AS DECIMAL_01
        		, 0 AS ENTERO_01
        		, (
        			CASE
        				WHEN EXISTS (
        					SELECT 1
        					FROM tbl_subservicio_dato_ssdt
        					WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        						AND ssdt_tpdt_pk = getTipoDato('CADENA_02')
        						AND ssdt_cadena = '4'
        				)
        				THEN 0
        				ELSE 1
        			END
        		) AS ENTERO_02
        		, (
        			SELECT COALESCE(ssdt_nentero, 0)
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('ENTERO_01')
        		) AS ENTERO_03
        		, 0 AS ENTERO_04
        		, 0 AS ENTERO_05
        	FROM ssrvs
        		join tbl_subservicio_ssrv ssrvEqui ON
        			ssrvEqui.ssrv_tpss_pk = getEntidad('EQUIPAMIENTO')
        			AND ssrvEqui.ssrv_srvc_pk = srvc_pk
        		JOIN tbl_subservicio_subservicio_ssss on
        			ssss_ssrvp_pk = ssrvs.ssrv_pk
        			AND ssss_ssrvh_pk = ssrvEqui.ssrv_pk
        	WHERE
        		EXISTS (
        			SELECT 1
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('COD_EXEN')
        				AND ssdt_cadena IN ('0', '2')
        		)
        		AND EXISTS (
        			SELECT 1
        			FROM tbl_subservicio_dato_ssdt
        			WHERE ssdt_ssrv_pk = ssrvEqui.ssrv_pk
        				AND ssdt_tpdt_pk = getTipoDato('TIPO_EQUI')
        				AND EXISTS (
        					select 1
        					from
        						tbl_parametro_version_prvr
        						JOIN tbl_parametro_dato_prdt ON
        							prdt_prvr_pk = prvr_pk
        							AND prdt_tpdt_pk = getTipoDato('MERCANCIA')
        					WHERE
        						srvc_fref BETWEEN prvr_fini AND COALESCE(prvr_ffin, srvc_fref)
        						AND prdt_prmt_pk IS NOT NULL
        						AND prvr_prmt_pk = ssdt_prmt_pk
        				)
        		)
        ) sql
        GROUP BY srvc_subp_pk, UNLOCODE, MERCANCIA, UNIDAD_CARGA, GRUPO_NST, REG_TBUQUE_EEE, DIREC_MERC, BOOLEANO_01
    ]]>
    </select>
</mapper>
