<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.dao.proceso.ProcesoDAO">
	<resultMap type="ProcesoVO" id="ResultMap">
		<id column="prbt_pk" property="id" />
		<result column="prbt_modulo" property="modulo" />
		<result column="prbt_tipo" property="tipo" />
		<result column="prbt_estado" property="estado" />
		<result column="prbt_falta" property="falta" />
		<result column="prbt_finicio" property="finicio" />
		<result column="prbt_ffin" property="ffin" />
		<result column="prbt_errores_cnt" property="erroresCnt" />
		<result column="prbt_alertas_cnt" property="alertasCnt" />
		<result column="prbt_mensajes_cnt" property="mensajesCnt" />
	</resultMap>

	<sql id="SelectPrefix">
    <![CDATA[
    SELECT
        prbt.prbt_pk
        , prbt.prbt_modulo
        , prbt.prbt_tipo
        , prbt.prbt_estado
        , prbt.prbt_falta
        , prbt.prbt_finicio
        , prbt.prbt_ffin
        , (SELECT COUNT(1) FROM tbl_proceso_mensaje_prmn
            WHERE prmn_prbt_pk = prbt_pk
                AND prmn_nivel = 'E') AS prbt_errores_cnt
        , (SELECT COUNT(1) FROM tbl_proceso_mensaje_prmn
            WHERE prmn_prbt_pk = prbt_pk
                AND prmn_nivel = 'W') AS prbt_alertas_cnt
        , (SELECT COUNT(1) FROM tbl_proceso_mensaje_prmn
            WHERE prmn_prbt_pk = prbt_pk
                AND prmn_nivel = 'I') AS prbt_mensajes_cnt
    FROM
        tbl_proceso_batch_prbt prbt
    ]]>
	</sql>

	<sql id="SelectCountPrefix">
    <![CDATA[
    SELECT
        COUNT(1)
    FROM
        tbl_proceso_batch_prbt prbt
    ]]>
	</sql>

	<sql id="SelectWhere">
		<where>
			<if test="modulo != null">
				AND prbt.prbt_modulo = #{modulo}
			</if>
			<if test="tipo != null">
				AND prbt.prbt_tipo = #{tipo}
			</if>
			<if test="estado != null">
				AND prbt.prbt_estado = #{estado}
			</if>
		</where>
	</sql>

	<select id="selectCount" parameterType="ProcesoCriterioVO"
		resultType="Integer">
		<include refid="SelectCountPrefix" />
		<include refid="SelectWhere" />
	</select>

	<select id="selectList" parameterType="ProcesoCriterioVO"
		resultMap="ResultMap">
		<include refid="SelectPrefix" />
		<include refid="SelectWhere" />
		ORDER BY prbt.prbt_falta DESC
	</select>

	<select id="selectObject" parameterType="ProcesoCriterioVO"
		resultMap="ResultMap">
		<include refid="SelectPrefix" />
		<include refid="SelectWhere" />
		LIMIT 1
	</select>

	<select id="select" parameterType="Long" resultMap="ResultMap">
		<include refid="SelectPrefix" />
		WHERE prbt_pk = #{value}
	</select>

	<insert id="insert" parameterType="ProcesoVO">
        <![CDATA[
        INSERT INTO tbl_proceso_batch_prbt(prbt_pk, prbt_modulo, prbt_tipo, prbt_estado, prbt_falta, prbt_finicio, prbt_ffin)
        VALUES (#{id}, #{modulo}, #{tipo}, 'C', getSysDatetime(), NULL, NULL)
        ]]>
	</insert>

	<update id="updateIniciar" parameterType="Long">
        <![CDATA[
        UPDATE tbl_proceso_batch_prbt SET
            prbt_estado = 'E'
            , prbt_finicio = getSysDatetime()
        WHERE
            prbt_pk = #{value}
            AND prbt_estado = 'C'
            AND prbt_finicio IS NULL
        ]]>
	</update>

	<update id="updateFinalizar" parameterType="Long">
        <![CDATA[
        UPDATE tbl_proceso_batch_prbt SET
            prbt_estado = 'F'
            , prbt_ffin = getSysDatetime()
        WHERE
            prbt_pk = #{value}
            AND prbt_estado = 'E'
            AND prbt_ffin IS NULL
        ]]>
	</update>

	<delete id="delete" parameterType="Long">
        <![CDATA[
        DELETE FROM tbl_proceso_batch_prbt
        WHERE
            prbt_pk = #{value}
            AND prbt_estado <> 'E'
        ]]>
	</delete>
</mapper>
