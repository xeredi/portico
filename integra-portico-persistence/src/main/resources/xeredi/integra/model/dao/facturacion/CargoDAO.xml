<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.dao.facturacion.CargoDAO">
    <resultMap type="CargoVO" id="ResultMap">
        <id column="crgv_pk" />
        <result column="crgo_pk" property="id" />
        <result column="crgo_codigo" property="codigo" />
        <result column="crgo_codigo_norm" property="codigoNormalizado" />
        <result column="crgo_es_principal" property="principal" />
        <result column="crgo_es_temporal" property="temporal" />
        <result column="crgo_tipo" property="tipo" />
        <result column="crgo_descripcion" property="descripcion" />

        <association property="crgv" javaType="CargoVersionVO">
            <result column="crgv_pk" property="id" />
            <result column="crgv_fini" property="finicio" />
            <result column="crgv_ffin" property="ffin" />
        </association>

        <association property="tpsr" javaType="TipoServicioVO">
            <result column="crgo_tpsr_pk" property="id" />
        </association>
    </resultMap>

    <sql id="SelectPrefix">
    <![CDATA[
        SELECT crgo_pk, crgo_codigo, crgo_codigo_norm, crgo_es_principal, crgo_es_temporal, crgo_tpsr_pk, crgo_tipo, crgo_descripcion
        	, crgv_pk, crgv_fini, crgv_ffin
        FROM portico.tbl_cargo_crgo
        	JOIN portico.tbl_cargo_version_crgv ON
        		crgv_crgo_pk = crgo_pk
    ]]>
    </sql>

    <sql id="SelectWhere">
        <where>
            <if test="fechaVigencia != null">
                AND #{fechaVigencia} BETWEEN crgv_fini AND COALESCE(crgv_ffin, #{fechaVigencia})
            </if>

            <if test="id != null">
                AND crgo_pk = #{id}
            </if>

            <if test="ids != null">
                AND crgo_pk IN
                <foreach collection="ids" open="(" close=")" separator="," item="value">#{value}</foreach>
            </if>

            <if test="padreId != null">
            <![CDATA[
                AND EXISTS (
                    SELECT 1
                    FROM tbl_cargo_dep_crdp
                    WHERE crdp_crgoh_pk = crgo_pk
                        AND crdp_crgop_pk = #{padreId}
            ]]>
                <if test="fechaVigencia != null">
                <![CDATA[
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_cargo_dep_version_crdv
                            WHERE crdv_crdp_pk = crdp_pk
                                AND #{fechaVigencia} BETWEEN crdv_fini AND COALESCE(crdv_ffin, #{fechaVigencia})
                        )
                ]]>
                </if>
            <![CDATA[
                )
            ]]>
            </if>

            <if test="padreIds != null">
            <![CDATA[
                AND EXISTS (
                    SELECT 1
                    FROM tbl_cargo_dep_crdp
                    WHERE crdp_crgoh_pk = crgo_pk
                        AND crdp_crgop_pk IN
            ]]>
                <foreach collection="padreIds" open="(" close=")" separator="," item="value">#{value}</foreach>
                <if test="fechaVigencia != null">
                <![CDATA[
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_cargo_dep_version_crdv
                            WHERE crdv_crdp_pk = crdp_pk
                                AND #{fechaVigencia} BETWEEN crdv_fini AND COALESCE(crdv_ffin, #{fechaVigencia})
                        )
                ]]>
                </if>
            <![CDATA[
                )
            ]]>
            </if>

            <if test="soloPrincipales">
                AND crgo_es_principal = 1
            </if>

            <if test="soloDependientes">
                AND crgo_es_principal = 0
            </if>
        </where>
    </sql>

    <select id="selectList" parameterType="CargoCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="selectObject" parameterType="CargoCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>
</mapper>
