SELECT *
FROM tbl_entidad_enti
ORDER BY enti_codigo
;

SELECT *
FROM
	tbl_entidad_tipo_dato_entd
	JOIN tbl_entidad_enti ON
		enti_pk = entd_enti_pk
	JOIN tbl_tipo_dato_tpdt ON
		tpdt_pk = entd_tpdt_pk
WHERE entd_enti_pk = portico.getEntidad('ASIGNACION_AMARRE')
;

SELECT *
FROM tbl_servicio_srvc
WHERE
	srvc_tpsr_pk = portico.getEntidad('ASIGNACION_AMARRE')
	AND NOW() BETWEEN srvc_fini AND COALESCE(srvc_ffin, NOW())
	AND EXISTS (
		SELECT 1
		FROM tbl_servicio_dato_srdt
		WHERE srdt_srvc_pk = srvc_pk
			AND srdt_tpdt_pk = portico.getTipoDato('AMARRE_DEP')
	)
;


UPDATE tbl_parametro_dato_prdt prdt SET
	prdt_cadena = estado
FROM (
	SELECT
		prdt_prvr_pk, prdt_tpdt_pk
		, (
			case
				WHEN
					EXISTS (
						SELECT 1
						FROM tbl_servicio_srvc
						WHERE
							srvc_tpsr_pk = portico.getEntidad('ASIGNACION_AMARRE')
							AND NOW() BETWEEN srvc_fini AND COALESCE(srvc_ffin, NOW())
							AND EXISTS (
								SELECT 1
								FROM tbl_servicio_dato_srdt
								WHERE srdt_srvc_pk = srvc_pk
									AND srdt_tpdt_pk = portico.getTipoDato('AMARRE_DEP')
									AND srdt_prmt_pk = prvr_prmt_pk
							)
							AND srvc_estado = 'A'
					)
				THEN 'O'

				WHEN
					EXISTS (
						SELECT 1
						FROM tbl_servicio_srvc
						WHERE
							srvc_tpsr_pk = portico.getEntidad('ASIGNACION_AMARRE')
							AND NOW() BETWEEN srvc_fini AND COALESCE(srvc_ffin, NOW())
							AND EXISTS (
								SELECT 1
								FROM tbl_servicio_dato_srdt
								WHERE srdt_srvc_pk = srvc_pk
									AND srdt_tpdt_pk = portico.getTipoDato('AMARRE_DEP')
									AND srdt_prmt_pk = prvr_prmt_pk
							)
							AND srvc_estado = 'P'
					)
				THEN 'R'

				WHEN
					EXISTS (
						SELECT 1
						FROM tbl_servicio_srvc
						WHERE
							srvc_tpsr_pk = portico.getEntidad('ASIGNACION_AMARRE')
							AND NOW() BETWEEN srvc_fini AND COALESCE(srvc_ffin, NOW())
							AND EXISTS (
								SELECT 1
								FROM tbl_servicio_dato_srdt
								WHERE srdt_srvc_pk = srvc_pk
									AND srdt_tpdt_pk = portico.getTipoDato('AMARRE_DEP_2')
									AND srdt_prmt_pk = prvr_prmt_pk
							)
							AND srvc_estado = 'A'
					)
				THEN 'T'

				ELSE 'L'
			END
		) AS estado
	/*
	*/
	FROM tbl_parametro_dato_prdt prdt
		JOIN tbl_parametro_version_prvr ON
			prvr_pk = prdt_prvr_pk
			AND NOW() BETWEEN prvr_fini AND COALESCE(prvr_ffin, NOW())
	WHERE
		EXISTS (
			SELECT 1
			FROM tbl_parametro_prmt
			WHERE prmt_pk = prvr_prmt_pk
				AND prmt_tppr_pk = portico.getEntidad('AMARRE_DEP')
		)
		AND prdt_tpdt_pk = portico.getTipoDato('ESTADO_AMAD')
		AND prdt_cadena <> 'B'
) sql
WHERE
	prdt.prdt_prvr_pk = sql.prdt_prvr_pk
	AND prdt.prdt_tpdt_pk = sql.prdt_tpdt_pk
	AND prdt.prdt_cadena <> sql.estado
;

