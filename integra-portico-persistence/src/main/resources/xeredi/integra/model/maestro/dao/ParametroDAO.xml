<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.maestro.dao.ParametroDAO">
    <resultMap type="ParametroVO" id="ResultMap">
        <id column="prvr_pk" />
        <id column="prmt_pk" />

        <result column="prmt_pk" property="id" />
        <result column="prmt_parametro" property="parametro" />
        <result column="prmt_tppr_pk" property="entiId" />

        <association property="prvr" javaType="ParametroVersionVO">
            <result column="prvr_pk" property="id" />
            <result column="prvr_fini" property="fini" />
            <result column="prvr_ffin" property="ffin" />
        </association>

        <association property="i18n" javaType="ParametroI18nVO">
            <result column="p18n_texto" property="texto" />
        </association>
    </resultMap>

    <sql id="SelectPrefix">
        SELECT prmt.*
        <if test="idioma != null">
        <![CDATA[
        , (
            CASE
                WHEN tppr_es_i18n = 1
                THEN (
                    SELECT p18n_texto
                    FROM tbl_parametro_i18n_p18n
                    WHERE
                        p18n_prvr_pk = prvr_pk
                        AND tppr_es_i18n = 1
                        AND p18n_idioma = 'es_ES'
                )
                WHEN tppr_tpdt_pk IS NOT NULL
                THEN (
                    SELECT prdt_cadena
                    FROM tbl_parametro_dato_prdt
                    WHERE
                        prdt_prvr_pk = prvr_pk
                        AND prdt_tpdt_pk = tppr_tpdt_pk
                )
            END
        ) AS p18n_texto
        ]]>
        </if>
        <include refid="SelectPrefixSpecific" />
        FROM vw_parametro_prmt prmt
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="postgres">
        , NULL AS rownumVar
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="sqlserver">
        , NULL AS rownumVar
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="oracle">
        , row_number() over (order by prmt_tppr_pk, prmt_parametro) rownumVar
    </sql>

    <sql id="SelectCountPrefix">
    <![CDATA[
    SELECT
        COUNT(1)
    FROM vw_parametro_prmt
    ]]>
    </sql>

    <sql id="SelectWhere">
        <if test="id != null">
            AND prmt_pk = #{id}
        </if>

        <if test="ids != null and !ids.empty">
            AND prmt_pk IN
            <foreach collection="ids" item="item" open="(" close=")" separator=",">#{item}
            </foreach>
        </if>

        <if test="entiId != null">
            AND prmt_tppr_pk = #{entiId}
        </if>

        <if test="entiIds != null and !entiIds.empty">
            AND prmt_tppr_pk IN
            <foreach collection="entiIds" item="item" open="(" close=")" separator=",">#{item}
            </foreach>
        </if>

        <if test="parametro != null and !parametro.empty">
            AND prmt_parametro LIKE #{parametro}
        </if>

        <if test="parametros != null and !parametros.empty">
            AND prmt_parametro IN
            <foreach collection="parametros" item="item" open="(" close=")" separator=",">#{item}
            </foreach>
        </if>

        <if test="prvrId != null">
            AND prvr_pk = #{prvrId}
        </if>

        <if test="prvrIds != null and !prvrIds.empty">
            AND prvr_pk IN
            <foreach collection="prvrIds" item="item" open="(" close=")" separator=",">#{item}
            </foreach>
        </if>

        <if test="fechaVigencia != null">
            AND #{fechaVigencia} BETWEEN prvr_fini AND coalesce(prvr_ffin, #{fechaVigencia})
        </if>

        <if test="itdtMap != null and !itdtMap.empty">
            <foreach collection="itdtMap" index="key" item="itdt">
                <!-- FIXME ojo, faltan las fechas -->
                <if
                    test="(itdt.prmt != null and itdt.prmt.id != null) or itdt.cantidadDecimal or itdt.cantidadEntera != null or (itdt.cadena != null and !itdt.cadena.empty) or (itdt.cadenas != null and !itdt.cadenas.empty)">
                        <![CDATA[
                        AND EXISTS (
                            SELECT 1
                            FROM tbl_parametro_dato_prdt
                            WHERE
                                prdt_prvr_pk = prvr_pk
                                AND prdt_tpdt_pk = #{itdt.tpdtId}
                        ]]>
                    <if test="itdt.prmt != null and itdt.prmt.id != null">
                        AND prdt_prmt_pk = #{itdt.prmt.id}
                    </if>
                    <if test="itdt.cantidadEntera != null">
                        AND prdt_nentero = #{itdt.cantidadEntera}
                    </if>
                    <if test="itdt.cantidadDecimal != null">
                        AND prdt_ndecimal = #{itdt.cantidadDecimal}
                    </if>
                    <if test="itdt.cadena != null and !itdt.cadena.empty">
                        AND prdt_cadena LIKE #{itdt.cadena}
                    </if>
                    <if test="itdt.cadenas != null and !itdt.cadenas.empty">
                        AND prdt_cadena IN
                        <foreach collection="itdt.cadenas" item="cadena" open="(" close=")" separator=",">#{cadena}
                        </foreach>
                    </if>
                    )
                </if>
            </foreach>
        </if>
    </sql>

    <select id="count" parameterType="ParametroCriterioVO" resultType="Integer">
        <include refid="SelectCountPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="selectList" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>

        ORDER BY prmt_tppr_pk, prmt_parametro
    </select>

    <select id="selectPaginatedList" parameterType="ParametroCriterioVO" resultMap="ResultMap" databaseId="postgres">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        ORDER BY prmt_tppr_pk, prmt_parametro
        OFFSET ${offset} ROWS FETCH NEXT ${limit} ROWS ONLY
    </select>

    <select id="selectPaginatedList" parameterType="ParametroCriterioVO" resultMap="ResultMap" databaseId="sqlserver">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        ORDER BY prmt_tppr_pk, prmt_parametro
        OFFSET ${offset} ROWS FETCH NEXT ${limit} ROWS ONLY
    </select>

    <select id="selectPaginatedList" parameterType="ParametroCriterioVO" resultMap="ResultMap" databaseId="oracle">
        SELECT * FROM (
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        <![CDATA[
        ORDER BY prmt_tppr_pk, prmt_parametro
        ) WHERE rownumVar >= ${offset} AND rownumVar < (${offset} + ${limit})
        ]]>
    </select>

    <select id="selectMap" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="selectMapByCodigo" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="selectObject" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="selectLupaList" parameterType="ParametroLupaCriterioVO" resultMap="ResultMap" fetchSize="10">
        <![CDATA[
        SELECT
            prmt_pk
            , prmt_parametro
            , (
                CASE
                    WHEN tppr_es_i18n = 1
                    THEN (
                        SELECT p18n_texto
                        FROM tbl_parametro_i18n_p18n
                        WHERE p18n_prvr_pk = prvr_pk
                            AND p18n_idioma = 'es_ES'
                    )
                    WHEN tppr_tpdt_pk IS NOT NULL
                    THEN (
                        SELECT prdt_cadena
                        FROM tbl_parametro_dato_prdt
                        WHERE prdt_prvr_pk = prvr_pk
                            AND prdt_tpdt_pk = tppr_tpdt_pk
                    )
                END
            ) AS p18n_texto
        FROM
            vw_parametro_prmt
        WHERE
            prmt_tppr_pk = #{entiId}
            AND (
                prmt_parametro LIKE #{textoBusqueda}
            )
            AND #{fechaVigencia} BETWEEN prvr_fini AND COALESCE(prvr_ffin, #{fechaVigencia})
        ]]>
    </select>

    <select id="selectId" parameterType="ParametroVO" resultType="Long">
        <![CDATA[
        SELECT prmt_pk
        FROM
            tbl_parametro_prmt prmt
        WHERE prmt_tppr_pk = #{entiId}
            AND prmt_parametro = #{parametro}
        ]]>
    </select>

    <select id="exists" parameterType="ParametroVO" resultType="Boolean">
        <![CDATA[
        SELECT COUNT(1)
        FROM tbl_parametro_prmt
        WHERE prmt_tppr_pk = #{entiId}
            AND prmt_parametro = #{parametro}
        ]]>
    </select>

    <select id="existsOverlap" parameterType="ParametroVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM
            vw_parametro_prmt
        WHERE
            prmt_pk = #{id}
            AND (
                #{prvr.fini} BETWEEN prvr_fini AND COALESCE(prvr_ffin, #{prvr.fini})
                OR COALESCE(#{prvr.ffin, jdbcType=TIMESTAMP, javaType=java.util.Date}, portico.getSysdateTime())
                    BETWEEN prvr_fini AND COALESCE(prvr_ffin, COALESCE(#{prvr.ffin, jdbcType=TIMESTAMP, javaType=java.util.Date}, portico.getSysdateTime()))
            )
    ]]>
        <if test="prvr.id != null">
        <![CDATA[
            AND prvr_pk <> #{prvr.id}
        ]]>
        </if>
    </select>

    <insert id="insert" parameterType="ParametroVO">
        <![CDATA[
        INSERT INTO tbl_parametro_prmt(prmt_pk, prmt_tppr_pk, prmt_parametro)
        VALUES (#{id}, #{entiId}, #{parametro})
        ]]>
    </insert>

    <insert id="insertVersion" parameterType="ParametroVO">
    <![CDATA[
        INSERT INTO tbl_parametro_version_prvr(prvr_pk, prvr_prmt_pk, prvr_fini, prvr_ffin)
        VALUES (#{prvr.id}, #{id}, #{prvr.fini}, #{prvr.ffin})
    ]]>
    </insert>

    <update id="updateVersion" parameterType="ParametroVO">
    <![CDATA[
        UPDATE tbl_parametro_version_prvr SET
            prvr_fini = #{prvr.fini}
            , prvr_ffin = #{prvr.ffin}
        WHERE prvr_pk = #{prvr.id}
    ]]>
    </update>

    <delete id="deleteVersion" parameterType="ParametroVO">
    <![CDATA[
        DELETE FROM tbl_parametro_version_prvr
        WHERE prvr_pk = #{prvr.id}
    ]]>
    </delete>
</mapper>
