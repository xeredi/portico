<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.maestro.dao.ParametroDAO">
    <resultMap type="ParametroVO" id="ResultMap">
        <id column="prvr_pk" />
        <result column="prmt_pk" property="id" />
        <result column="prmt_parametro" property="parametro" />
        <result column="prmt_tppr_pk" property="entiId" />

        <association property="prvr" javaType="ParametroVersionVO">
            <id column="prvr_pk" property="id" />
            <result column="prvr_fini" property="finicio" />
            <result column="prvr_ffin" property="ffin" />
        </association>

        <association property="i18n" javaType="ParametroI18nVO">
            <result column="p18n_texto" property="texto" />
        </association>
        <!-- -->
    </resultMap>

    <sql id="SelectPrefix">
    <![CDATA[
    SELECT
        prmt.prmt_pk, prmt.prmt_tppr_pk, prmt.prmt_parametro
        , prvr.prvr_pk, prvr.prvr_fini, prvr.prvr_ffin
    ]]>
        <if test="idioma != null">
        <![CDATA[
    	, CASE
    		WHEN
    			EXISTS (
    				SELECT 1 FROM tbl_tipo_parametro_tppr
    				WHERE tppr_pk = prmt_tppr_pk
    					AND tppr_es_i18n = 1
    			)
    		THEN (SELECT p18n_texto FROM tbl_parametro_i18n_p18n p18n WHERE p18n.p18n_prvr_pk = prvr.prvr_pk AND p18n.p18n_idioma = 'es_ES')

    		ELSE (
    			SELECT prdt_cadena
    			FROM tbl_parametro_dato_prdt
    			WHERE prdt_prvr_pk = prvr_pk
    				AND prdt_tpdt_pk = (
    					SELECT tppr_tpdt_pk FROM tbl_tipo_parametro_tppr
    					WHERE tppr_pk = prmt_tppr_pk
    				)
    		)
    	END AS p18n_texto
        ]]>
        </if>
    <![CDATA[
    FROM tbl_parametro_prmt prmt
        JOIN tbl_parametro_version_prvr prvr ON
            prvr.prvr_prmt_pk = prmt.prmt_pk
    ]]>
    </sql>

    <sql id="SelectCountPrefix">
    <![CDATA[
    SELECT
        COUNT(1)
    FROM tbl_parametro_prmt prmt
        JOIN tbl_parametro_version_prvr prvr ON
            prvr.prvr_prmt_pk = prmt.prmt_pk
    ]]>
    </sql>

    <sql id="SelectWhere">
        <where>
            <if test="id != null">
                AND prmt_pk = #{id}
            </if>

            <if test="ids != null and !ids.empty">
                AND prmt_pk IN
                <foreach collection="ids" item="item" open="(" close=")" separator=",">#{item}
                </foreach>
            </if>

            <if test="entiId != null">
                AND prmt_tppr_pk = #{entiId}
            </if>

            <if test="entiIds != null and !entiIds.empty">
                AND prmt_tppr_pk IN
                <foreach collection="entiIds" item="item" open="(" close=")" separator=",">#{item}
                </foreach>
            </if>

            <if test="parametro != null and !parametro.empty">
                AND prmt_parametro LIKE #{parametro}
            </if>

            <if test="parametros != null and !parametros.empty">
                AND prmt.prmt_parametro IN
                <foreach collection="parametros" item="item" open="(" close=")" separator=",">#{item}
                </foreach>
            </if>

            <if test="prvrIds != null and !prvrIds.empty">
                AND prvr_pk IN
                <foreach collection="prvrIds" item="item" open="(" close=")" separator=",">#{item}
                </foreach>
            </if>

            <if test="fechaVigencia != null">
		            <![CDATA[
		            AND #{fechaVigencia} BETWEEN prvr_fini AND coalesce(prvr_ffin, #{fechaVigencia})
		            ]]>
            </if>

            <if test="itdtMap != null and !itdtMap.empty">
                <foreach collection="itdtMap" index="key" item="itdt">
                    <!-- FIXME ojo, faltan las fechas -->
                    <if
                        test="itdt.prmtId != null or itdt.cantidadDecimal or itdt.cantidadEntera != null or (itdt.cadena != null and !itdt.cadena.empty) or (itdt.cadenas != null and !itdt.cadenas.empty)">
                            <![CDATA[
                            AND EXISTS (
                                SELECT 1
                                FROM tbl_parametro_dato_prdt
                                WHERE
                                    prdt_prvr_pk = prvr_pk
                                    AND prdt_tpdt_pk = #{key}
                            ]]>
                        <if test="itdt.prmtId != null">
                            AND prdt_prmt_pk = #{itdt.prmtId}
                        </if>
                        <if test="itdt.cantidadEntera != null">
                            AND prdt_nentero = #{itdt.cantidadEntera}
                        </if>
                        <if test="itdt.cantidadDecimal != null">
                            AND prdt_ndecimal = #{itdt.cantidadDecimal}
                        </if>
                        <if test="itdt.cadena != null and !itdt.cadena.empty">
                            AND prdt_cadena LIKE #{itdt.cadena}
                        </if>
                        <if test="itdt.cadenas != null and !itdt.cadenas.empty">
                            AND prdt_cadena IN
                            <foreach collection="itdt.cadenas" item="cadena" open="(" close=")" separator=",">#{cadena}
                            </foreach>
                        </if>
                        )
                    </if>
                </foreach>
            </if>
        </where>
    </sql>

    <select id="selectCount" parameterType="ParametroCriterioVO" resultType="Integer">
        <include refid="SelectCountPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="selectList" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />

        ORDER BY prmt.prmt_tppr_pk, prmt.prmt_parametro
    </select>

    <select id="selectMap" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="selectMapByCodigo" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="selectObject" parameterType="ParametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <include refid="SelectWhere" />
    </select>

    <select id="selectId" parameterType="ParametroVO" resultType="Long">
        <![CDATA[
        SELECT prmt_pk
        FROM
            tbl_parametro_prmt prmt
        WHERE prmt_tppr_pk = #{entiId}
            AND prmt_parametro = #{parametro}
        ]]>
    </select>

    <select id="exists" parameterType="ParametroVO" resultType="Boolean">
        <![CDATA[
        SELECT COUNT(1)
        FROM tbl_parametro_prmt
        WHERE prmt_tppr_pk = #{entiId}
            AND prmt_parametro = #{parametro}
        ]]>
    </select>

    <select id="intersects" parameterType="ParametroVO" resultType="Boolean">
        <![CDATA[
            SELECT COUNT(1)
            FROM
                tbl_parametro_prmt
                INNER JOIN tbl_parametro_version_prvr ON
                    prvr_prmt_pk = prmt_pk
                    AND (
                        #{prvr.finicio} BETWEEN prvr_fini AND COALESCE(prvr_ffin, #{prvr.finicio})
                        OR
                        COALESCE(#{prvr.ffin, jdbcType=TIMESTAMP}, portico.getSysDatetime())
                            BETWEEN prvr_fini AND COALESCE(prvr_ffin, COALESCE(#{prvr.ffin, jdbcType=TIMESTAMP}, portico.getSysDatetime()))
                        OR (
                            #{prvr.finicio} < prvr_fini
                            AND COALESCE(#{prvr.ffin, jdbcType=TIMESTAMP}, portico.getSysDatetime())
                                >= COALESCE(prvr_ffin, COALESCE(#{prvr.ffin, jdbcType=TIMESTAMP}, portico.getSysDatetime()))
                        )
                    )
            WHERE
                prmt_tppr_pk = #{entiId}
                AND prmt_parametro = #{parametro}
        ]]>
    </select>

    <select id="selectLupaList" parameterType="ParametroLupaCriterioVO" resultType="LabelValueVO">
        <![CDATA[
            SELECT
                prmt_pk AS value
                , prmt_parametro
        ]]>
        <if test="idioma != null and !idioma.empty">
            , CONCAT(CONCAT(prmt_parametro, ' - '), p18n_texto)
        </if>
        <if test="tpdtNombreId != null">
            , CONCAT(CONCAT(prmt_parametro, ' - '), prdt_cadena)
        </if>
        <if test="tpdtNombreId == null or idioma == null or idioma.empty">
            , prmt_parametro
        </if>
        <![CDATA[
                AS label
            FROM
                tbl_parametro_prmt
                    JOIN TBL_PARAMETRO_VERSION_PRVR ON
                        prvr_prmt_pk = prmt_pk
                        AND #{fechaVigencia} BETWEEN prvr_fini AND COALESCE(PRVR_Ffin, #{fechaVigencia})
        ]]>
        <if test="idioma != null and !idioma.empty">
        <![CDATA[
                    LEFT JOIN TBL_PARAMETRO_i18n_P18n P18n ON
                        p18n_prvr_pk = prvr_pk
                        AND p18n_idioma = #{idioma}
        ]]>
        </if>
        <if test="tpdtNombreId != null">
        <![CDATA[
                    LEFT JOIN tbl_parametro_dato_prdt ON
            			prdt_prvr_pk = prvr_pk
			            AND prdt_tpdt_pk = #{tpdtNombreId}
        ]]>
        </if>
        <![CDATA[
            WHERE
                prmt_tppr_pk = #{entiId}
                AND (
                    prmt_parametro LIKE #{textoBusqueda}
        ]]>
        <if test="idioma != null and !idioma.empty">
        <![CDATA[
                    OR p18n_texto LIKE #{textoBusqueda}
        ]]>
        </if>
        <if test="tpdtNombreId != null">
        <![CDATA[
                    OR prdt_cadena LIKE #{textoBusqueda}
        ]]>
        </if>
        <![CDATA[
                )
        ]]>
    </select>

    <insert id="insert" parameterType="ParametroVO">
        <![CDATA[
        INSERT INTO tbl_parametro_prmt(prmt_pk, prmt_tppr_pk, prmt_parametro)
        VALUES (#{id}, #{entiId}, #{parametro})
        ]]>
    </insert>
</mapper>
