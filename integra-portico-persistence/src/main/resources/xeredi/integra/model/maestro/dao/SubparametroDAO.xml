<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.maestro.dao.SubparametroDAO">
    <resultMap type="SubparametroVO" id="ResultMap">
        <id column="spvr_pk" />
        <id column="sprm_pk" />

        <result column="sprm_pk" property="id" />
        <result column="sprm_tpsp_pk" property="entiId" />
        <result column="sprm_prmt_pk" property="prmtId" />

        <association property="prmtAsociado" javaType="ParametroVO">
            <result column="sprm_prmt_dep_pk" property="id" />
            <result column="prmt_parametro" property="parametro" />
            <result column="prmt_texto" property="texto" />
        </association>

        <association property="spvr" javaType="SubparametroVersionVO">
            <result column="spvr_pk" property="id" />
            <result column="spvr_fini" property="fini" />
            <result column="spvr_ffin" property="ffin" />
        </association>
    </resultMap>

    <sql id="SelectPrefix">
        SELECT sprm.*
        <if test="fechaVigencia != null and idioma != null">
        <![CDATA[
            , (CASE
                WHEN tppr_es_i18n = 1
                THEN (
                    SELECT i18n_text
                    FROM tbl_i18n_i18n
                    WHERE
                        i18n_pref = 'prvr'
                        AND i18n_ext_pk = (
                            SELECT prvr_pk
                            FROM tbl_parametro_version_prvr
                            WHERE
                                prvr_prmt_pk = prmt_pk
                                AND #{fechaVigencia} BETWEEN prvr_fini AND COALESCE(prvr_ffin, #{fechaVigencia})
                        )
                        AND i18n_lang = #{idioma}
                )
                WHEN tppr_tpdt_pk IS NOT NULL
                THEN (
                    SELECT prdt_cadena
                    FROM tbl_parametro_dato_prdt
                    WHERE
                        prdt_prvr_pk = (
                            SELECT prvr_pk
                            FROM tbl_parametro_version_prvr
                            WHERE
                                prvr_prmt_pk = prmt_pk
                                AND #{fechaVigencia} BETWEEN prvr_fini AND COALESCE(prvr_ffin, #{fechaVigencia})
                        )
                        AND prdt_tpdt_pk = tppr_tpdt_pk
                )
            END) as prmt_texto
        ]]>
        </if>
        <include refid="SelectPrefixSpecific" />
        FROM vw_subparametro_sprm sprm
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="postgres">
        , NULL AS rownumVar
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="sqlserver">
        , NULL AS rownumVar
    </sql>

    <sql id="SelectPrefixSpecific" databaseId="oracle">
        , row_number() over (order by sprm_prmt_pk, sprm_tpsp_pk,
        prmt_parametro, spvr_fini DESC) rownumVar
    </sql>

    <sql id="SelectWhere">
        <if test="id != null">
            AND sprm_pk = #{id}
        </if>
        <if test="spvrId != null">
            AND spvr_pk = #{spvrId}
        </if>
        <if test="spvrIds != null and !spvrIds.empty">
            AND spvr_pk IN
            <foreach collection="spvrIds" item="item" open="(" close=")" separator=",">#{item}</foreach>
        </if>
        <if test="entiId != null">
            AND sprm_tpsp_pk = #{entiId}
        </if>
        <if test="prmt != null">
            <if test="prmt.id != null">
                AND sprm_prmt_pk = #{prmt.id}
            </if>
        </if>
        <if test="fechaVigencia != null">
            AND #{fechaVigencia} BETWEEN spvr_fini AND COALESCE(spvr_ffin,
            #{fechaVigencia})
        </if>
    </sql>

    <select id="selectCount" parameterType="SubparametroCriterioVO" resultType="Integer">
        SELECT COUNT(1) FROM vw_subparametro_sprm sprm
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="selectList" parameterType="SubparametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>

        ORDER BY sprm_prmt_pk, sprm_tpsp_pk, prmt_parametro, spvr_fini DESC
    </select>

    <select id="selectPaginatedList" parameterType="SubparametroCriterioVO" resultMap="ResultMap" databaseId="postgres">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        ORDER BY sprm_prmt_pk, sprm_tpsp_pk, prmt_parametro, spvr_fini DESC
        OFFSET ${offset} ROWS FETCH NEXT ${limit}
        ROWS ONLY
    </select>

    <select id="selectPaginatedList" parameterType="SubparametroCriterioVO" resultMap="ResultMap" databaseId="sqlserver">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        ORDER BY sprm_prmt_pk, sprm_tpsp_pk, prmt_parametro, spvr_fini DESC
        OFFSET ${offset} ROWS FETCH NEXT ${limit}
        ROWS ONLY
    </select>

    <select id="selectPaginatedList" parameterType="SubparametroCriterioVO" resultMap="ResultMap" databaseId="oracle">
        SELECT * FROM (
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
        <![CDATA[
        ORDER BY sprm_prmt_pk, sprm_tpsp_pk, prmt_parametro, spvr_fini DESC
        ) WHERE rownumVar > ${offset} AND rownumVar <= (${offset} + ${limit})
        ]]>
    </select>

    <select id="selectObject" parameterType="SubparametroCriterioVO" resultMap="ResultMap">
        <include refid="SelectPrefix" />
        <where>
            <include refid="SelectWhere" />
        </where>
    </select>

    <select id="exists" parameterType="SubparametroVO" resultType="Boolean">
        <![CDATA[
        SELECT COUNT(1)
        FROM tbl_subparametro_sprm
        WHERE
            sprm_prmt_pk = #{prmtId}
            AND sprm_prmt_dep_pk = #{prmtAsociado.id}
        ]]>
    </select>

    <select id="existsOverlap" parameterType="SubparametroVO" resultType="Boolean">
    <![CDATA[
        SELECT COUNT(1)
        FROM
            tbl_subparametro_sprm
            INNER JOIN tbl_subparametro_version_spvr ON
                spvr_sprm_pk = sprm_pk
        WHERE
            sprm_pk = #{id}
            AND (
                #{spvr.fini} BETWEEN spvr_fini AND COALESCE(spvr_ffin, #{spvr.fini})
                OR COALESCE(#{spvr.ffin, jdbcType=TIMESTAMP, javaType=java.util.Date}, portico.getSysdateTime())
                    BETWEEN spvr_fini AND COALESCE(spvr_ffin, COALESCE(#{spvr.ffin, jdbcType=TIMESTAMP, javaType=java.util.Date}, portico.getSysdateTime()))
            )
    ]]>
        <if test="spvr.id != null">
        <![CDATA[
            AND spvr_pk <> #{spvr.id}
        ]]>
        </if>
    </select>

    <select id="selectId" parameterType="SubparametroVO" resultType="Long">
        <![CDATA[
        SELECT sprm_pk
        FROM
            tbl_subparametro_sprm
        WHERE sprm_prmt_pk = #{prmtId}
            AND sprm_prmt_dep_pk = #{prmtAsociado.id}
        ]]>
    </select>

    <insert id="insert" parameterType="SubparametroVO">
        <![CDATA[
        INSERT INTO tbl_subparametro_sprm (sprm_pk, sprm_prmt_pk, sprm_prmt_dep_pk, sprm_tpsp_pk)
        VALUES (#{id}, #{prmtId}, #{prmtAsociado.id}, #{entiId})
        ]]>
    </insert>

    <insert id="insertVersion" parameterType="SubparametroVO">
    <![CDATA[
        INSERT INTO tbl_subparametro_version_spvr (spvr_pk, spvr_sprm_pk, spvr_fini, spvr_ffin)
        VALUES (#{spvr.id}, #{id}, #{spvr.fini}, #{spvr.ffin, jdbcType=TIMESTAMP})
    ]]>
    </insert>

    <update id="updateVersion" parameterType="SubparametroVO">
    <![CDATA[
        UPDATE tbl_subparametro_version_spvr SET
            spvr_fini = #{spvr.fini}
            , spvr_ffin = #{spvr.ffin, jdbcType=TIMESTAMP}
        WHERE spvr_pk = #{spvr.id}
    ]]>
    </update>

    <delete id="deleteVersion" parameterType="SubparametroVO">
    <![CDATA[
        DELETE FROM tbl_subparametro_version_spvr
        WHERE spvr_pk = #{spvr.id}
    ]]>
    </delete>
</mapper>
