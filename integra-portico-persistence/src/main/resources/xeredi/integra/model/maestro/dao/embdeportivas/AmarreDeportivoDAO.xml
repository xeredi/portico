<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="xeredi.integra.model.maestro.dao.embdeportivas.AmarreDeportivoDAO">
    <update id="updateRecalcularEstado" parameterType="ParametroCriterioVO">
    <![CDATA[
        UPDATE tbl_parametro_dato_prdt prdt SET
        	prdt_cadena = estado
        FROM (
        	SELECT
        		prdt_prvr_pk, prdt_tpdt_pk
        		, (
        			case
        				WHEN
        					EXISTS (
        						SELECT 1
        						FROM tbl_servicio_srvc
        						WHERE
        							srvc_tpsr_pk = portico.getEntidad('ASIGNACION_AMARRE')
        							AND #{fechaVigencia} BETWEEN srvc_fini AND COALESCE(srvc_ffin, #{fechaVigencia})
        							AND EXISTS (
        								SELECT 1
        								FROM tbl_servicio_dato_srdt
        								WHERE srdt_srvc_pk = srvc_pk
        									AND srdt_tpdt_pk = portico.getTipoDato('AMARRE_DEP')
        									AND srdt_prmt_pk = prvr_prmt_pk
        							)
        							AND srvc_estado = 'A'
        					)
        				THEN 'O'

        				WHEN
        					EXISTS (
        						SELECT 1
        						FROM tbl_servicio_srvc
        						WHERE
        							srvc_tpsr_pk = portico.getEntidad('ASIGNACION_AMARRE')
        							AND #{fechaVigencia} BETWEEN srvc_fini AND COALESCE(srvc_ffin, #{fechaVigencia})
        							AND EXISTS (
        								SELECT 1
        								FROM tbl_servicio_dato_srdt
        								WHERE srdt_srvc_pk = srvc_pk
        									AND srdt_tpdt_pk = portico.getTipoDato('AMARRE_DEP')
        									AND srdt_prmt_pk = prvr_prmt_pk
        							)
        							AND srvc_estado = 'P'
        					)
        				THEN 'R'

        				WHEN
        					EXISTS (
        						SELECT 1
        						FROM tbl_servicio_srvc
        						WHERE
        							srvc_tpsr_pk = portico.getEntidad('ASIGNACION_AMARRE')
        							AND #{fechaVigencia} BETWEEN srvc_fini AND COALESCE(srvc_ffin, #{fechaVigencia})
        							AND EXISTS (
        								SELECT 1
        								FROM tbl_servicio_dato_srdt
        								WHERE srdt_srvc_pk = srvc_pk
        									AND srdt_tpdt_pk = portico.getTipoDato('AMARRE_DEP_2')
        									AND srdt_prmt_pk = prvr_prmt_pk
        							)
        							AND srvc_estado = 'A'
        					)
        				THEN 'T'

        				ELSE 'L'
        			END
        		) AS estado
        	/*
        	*/
        	FROM tbl_parametro_dato_prdt prdt
        		JOIN tbl_parametro_version_prvr ON
        			prvr_pk = prdt_prvr_pk
        			AND #{fechaVigencia} BETWEEN prvr_fini AND COALESCE(prvr_ffin, #{fechaVigencia})
        	WHERE
        		EXISTS (
        			SELECT 1
        			FROM tbl_parametro_prmt
        			WHERE prmt_pk = prvr_prmt_pk
        				AND prmt_tppr_pk = portico.getEntidad('AMARRE_DEP')
    ]]>
        <if test="id != null">
        <![CDATA[
                        AND prmt_pk = #{id}
        ]]>
        </if>
        <if test="ids != null and !ids.empty">
        <![CDATA[
                        AND prmt_pk IN
        ]]>
            <foreach collection="ids" item="item" open="(" close=")" separator=",">#{item}
            </foreach>
        </if>
    <![CDATA[
        		)
        		AND prdt_tpdt_pk = portico.getTipoDato('ESTADO_AMAD')
        		AND prdt_cadena <> 'B'
        ) sql
        WHERE
        	prdt.prdt_prvr_pk = sql.prdt_prvr_pk
        	AND prdt.prdt_tpdt_pk = sql.prdt_tpdt_pk
        	AND prdt.prdt_cadena <> sql.estado
    ]]>
    </update>
</mapper>
